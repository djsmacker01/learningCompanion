{% extends "base.html" %}

{% block title %}Study Flashcards: {{ quiz.title }}{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title mb-1">{{ quiz.title }}</h5>
                            <small class="opacity-75">Card {{ card_index + 1 }} of {{ total_cards }}</small>
                        </div>
                        <div class="text-end">
                            <div class="progress mb-2" style="width: 200px; height: 8px;">
                                <div class="progress-bar bg-white" role="progressbar"
                                    style="width: {{ ((card_index + 1) / total_cards * 100) }}%"></div>
                            </div>
                            <small class="opacity-75">{{ ((card_index + 1) / total_cards * 100)|round(1) }}%
                                Complete</small>
                        </div>
                    </div>
                </div>
            </div>

            
            <div class="card border-0 shadow-sm mb-4" id="flashcard">
                <div class="card-body text-center p-5">
                    <div id="question-side">
                        <div class="mb-4">
                            <i class="fas fa-lightbulb fa-3x text-primary mb-3"></i>
                            <h4 class="text-muted">Question</h4>
                        </div>
                        <h3 class="mb-4">{{ question.question_text }}</h3>
                        <button class="btn btn-primary btn-lg" onclick="showAnswer()">
                            <i class="fas fa-eye me-2"></i>Show Answer
                        </button>
                    </div>

                    <div id="answer-side" style="display: none;">
                        <div class="mb-4">
                            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                            <h4 class="text-muted">Answer</h4>
                        </div>
                        <h3 class="mb-4">{{ question.correct_answer }}</h3>
                        {% if question.explanation %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>{{ question.explanation }}
                        </div>
                        {% endif %}
                        <button class="btn btn-outline-secondary" onclick="showQuestion()">
                            <i class="fas fa-eye-slash me-2"></i>Show Question
                        </button>
                    </div>
                </div>
            </div>

            
            <div class="card border-0 shadow-sm" id="review-form" style="display: none;">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-star me-2"></i>How well did you know this?
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" id="review-form-element">
                        {{ form.hidden_tag() }}
                        <input type="hidden" name="question_id" value="{{ question.id }}">
                        <input type="hidden" name="card_index" value="{{ card_index }}">

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="radio" name="quality" value="0" id="quality0">
                                    <label class="form-check-label" for="quality0">
                                        <strong class="text-danger">0 - Complete blackout</strong>
                                        <br><small class="text-muted">I had no idea what this was</small>
                                    </label>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="radio" name="quality" value="1" id="quality1">
                                    <label class="form-check-label" for="quality1">
                                        <strong class="text-danger">1 - Incorrect response</strong>
                                        <br><small class="text-muted">I got it wrong, but the correct answer seemed
                                            familiar</small>
                                    </label>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="radio" name="quality" value="2" id="quality2">
                                    <label class="form-check-label" for="quality2">
                                        <strong class="text-warning">2 - Incorrect response</strong>
                                        <br><small class="text-muted">I got it wrong, but the correct answer was easy to
                                            recall</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="radio" name="quality" value="3" id="quality3">
                                    <label class="form-check-label" for="quality3">
                                        <strong class="text-info">3 - Correct response after hesitation</strong>
                                        <br><small class="text-muted">I got it right, but it took me a moment</small>
                                    </label>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="radio" name="quality" value="4" id="quality4">
                                    <label class="form-check-label" for="quality4">
                                        <strong class="text-success">4 - Correct response after brief
                                            hesitation</strong>
                                        <br><small class="text-muted">I got it right with just a small pause</small>
                                    </label>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="radio" name="quality" value="5" id="quality5">
                                    <label class="form-check-label" for="quality5">
                                        <strong class="text-success">5 - Perfect response</strong>
                                        <br><small class="text-muted">I knew it immediately and confidently</small>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="text-center">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-arrow-right me-2"></i>Next Card
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            
            <div class="card border-0 shadow-sm mt-4">
                <div class="card-header bg-light">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>How to Study with Flashcards
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <ul class="list-unstyled mb-0">
                                <li class="mb-2">
                                    <i class="fas fa-lightbulb text-primary me-2"></i>
                                    Read the question carefully
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-eye text-info me-2"></i>
                                    Try to answer before revealing
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-star text-warning me-2"></i>
                                    Rate your performance honestly
                                </li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <ul class="list-unstyled mb-0">
                                <li class="mb-2">
                                    <i class="fas fa-brain text-success me-2"></i>
                                    Cards will be scheduled based on your rating
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-clock text-secondary me-2"></i>
                                    Harder cards appear more frequently
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-trophy text-warning me-2"></i>
                                    Consistent practice improves retention
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let answerShown = false;

    function showAnswer() {
        document.getElementById('question-side').style.display = 'none';
        document.getElementById('answer-side').style.display = 'block';
        document.getElementById('review-form').style.display = 'block';
        answerShown = true;

        // Add flip animation
        const flashcard = document.getElementById('flashcard');
        flashcard.style.transform = 'rotateY(180deg)';
        setTimeout(() => {
            flashcard.style.transform = 'rotateY(0deg)';
        }, 300);
    }

    function showQuestion() {
        document.getElementById('answer-side').style.display = 'none';
        document.getElementById('question-side').style.display = 'block';
        document.getElementById('review-form').style.display = 'none';
        answerShown = false;

        // Add flip animation
        const flashcard = document.getElementById('flashcard');
        flashcard.style.transform = 'rotateY(-180deg)';
        setTimeout(() => {
            flashcard.style.transform = 'rotateY(0deg)';
        }, 300);
    }

    document.addEventListener('DOMContentLoaded', function () {
        // Keyboard shortcuts
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                if (!answerShown) {
                    showAnswer();
                }
            }

            // Number keys for rating (0-5)
            if (answerShown && e.key >= '0' && e.key <= '5') {
                const quality = parseInt(e.key);
                const radio = document.getElementById(`quality${quality}`);
                if (radio) {
                    radio.checked = true;
                }
            }

            // 'n' key to submit review
            if (answerShown && e.key === 'n') {
                const form = document.getElementById('review-form-element');
                const selectedQuality = form.querySelector('input[name="quality"]:checked');
                if (selectedQuality) {
                    form.submit();
                }
            }
        });

        // Form validation
        const form = document.getElementById('review-form-element');
        form.addEventListener('submit', function (e) {
            const selectedQuality = form.querySelector('input[name="quality"]:checked');
            if (!selectedQuality) {
                e.preventDefault();
                alert('Please rate how well you knew this card before proceeding.');
                return false;
            }
        });

        // Auto-focus on first quality option when answer is shown
        const observer = new MutationObserver(function (mutations) {
            mutations.forEach(function (mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                    const reviewForm = document.getElementById('review-form');
                    if (reviewForm.style.display !== 'none') {
                        // Focus on the first quality option
                        const firstQuality = document.getElementById('quality0');
                        if (firstQuality) {
                            firstQuality.focus();
                        }
                    }
                }
            });
        });

        observer.observe(document.getElementById('review-form'), {
            attributes: true,
            attributeFilter: ['style']
        });
    });
</script>

<style>
    #flashcard {
        transition: transform 0.3s ease-in-out;
        min-height: 400px;
    }

    .form-check-input:checked+.form-check-label {
        background-color: rgba(0, 123, 255, 0.1);
        border-radius: 0.375rem;
        padding: 0.5rem;
    }
</style>
{% endblock %}