{% extends "base.html" %}

{% block title %}My GCSE Exams - Learning Companion{% endblock %}

{% block extra_css %}
<style>
    .exam-card {
        transition: transform 0.2s ease-in-out;
        border: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }

    .exam-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
    }

    .countdown-urgent {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        color: white;
        padding: 15px;
        border-radius: 10px;
    }

    .countdown-soon {
        background: linear-gradient(135deg, #feca57 0%, #ff9ff3 100%);
        color: white;
        padding: 15px;
        border-radius: 10px;
    }

    .countdown-normal {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        border-radius: 10px;
    }

    .exam-badge {
        font-size: 0.9em;
        padding: 5px 12px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('gcse.gcse_dashboard') }}">GCSE Dashboard</a></li>
            <li class="breadcrumb-item active">My Exams</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1><i class="fas fa-calendar-alt me-2"></i>My GCSE Exams</h1>
                    <p class="text-muted mb-0">Manage your exam schedule and track countdown timers</p>
                </div>
                <div>
                    <a href="{{ url_for('gcse.create_exam') }}" class="btn btn-success">
                        <i class="fas fa-plus me-2"></i>Add New Exam
                    </a>
                    <a href="{{ url_for('gcse.gcse_dashboard') }}" class="btn btn-outline-secondary ms-2">
                        <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h3 class="mb-0">{{ total_exams }}</h3>
                    <p class="mb-0">Total Exams Scheduled</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <h3 class="mb-0">{{ exams_by_subject|length }}</h3>
                    <p class="mb-0">Subjects</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h3 class="mb-0" id="nextExamDays">-</h3>
                    <p class="mb-0">Days to Next Exam</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Exams by Subject -->
    {% if exams_by_subject %}
    <div class="row">
        <div class="col-12">
            {% for subject_id, exams in exams_by_subject.items() %}
            <div class="mb-4">
                <h4 class="mb-3">
                    <i class="fas fa-book me-2"></i>
                    {% set first_exam = exams[0] %}
                    Subject Exams
                    <span class="badge bg-secondary">{{ exams|length }} exam{{ 's' if exams|length > 1 else '' }}</span>
                </h4>

                <div class="row">
                    {% for exam in exams %}
                    <div class="col-md-6 mb-3">
                        <div class="card exam-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <h5 class="card-title mb-0">{{ exam.exam_name }}</h5>
                                    <span class="badge bg-primary exam-badge">{{ exam.exam_board }}</span>
                                </div>

                                {% if exam.countdown %}
                                <div class="countdown-{{ exam.countdown.status }} mb-3">
                                    <div class="text-center">
                                        {% if exam.countdown.status == 'today' %}
                                        <h3 class="mb-0">EXAM TODAY! üéØ</h3>
                                        {% elif exam.countdown.status == 'urgent' %}
                                        <h3 class="mb-0">{{ exam.countdown.days }} day{{ 's' if exam.countdown.days > 1
                                            else '' }} left ‚è∞</h3>
                                        {% elif exam.countdown.status == 'soon' %}
                                        <h4 class="mb-0">
                                            {% if exam.countdown.weeks > 0 %}
                                            {{ exam.countdown.weeks }} week{{ 's' if exam.countdown.weeks > 1 else '' }}
                                            {% endif %}
                                            {% if exam.countdown.days > 0 %}
                                            {{ exam.countdown.days }} day{{ 's' if exam.countdown.days > 1 else '' }}
                                            {% endif %}
                                        </h4>
                                        {% else %}
                                        <h5 class="mb-0">
                                            {% if exam.countdown.months > 0 %}
                                            {{ exam.countdown.months }} month{{ 's' if exam.countdown.months > 1 else ''
                                            }}
                                            {% endif %}
                                            {% if exam.countdown.weeks > 0 %}
                                            {{ exam.countdown.weeks }} week{{ 's' if exam.countdown.weeks > 1 else '' }}
                                            {% endif %}
                                        </h5>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}

                                <div class="row text-center mb-3">
                                    <div class="col-4">
                                        <small class="text-muted">Date</small><br>
                                        <strong>{{ exam.exam_date }}</strong>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted">Duration</small><br>
                                        <strong>{{ exam.duration_minutes if exam.duration_minutes else '-' }}
                                            min</strong>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted">Marks</small><br>
                                        <strong>{{ exam.total_marks if exam.total_marks else '-' }}</strong>
                                    </div>
                                </div>

                                {% if exam.paper_number %}
                                <p class="mb-2">
                                    <i class="fas fa-file-alt me-2"></i><strong>Paper:</strong> {{ exam.paper_number }}
                                </p>
                                {% endif %}

                                {% if exam.specification_code %}
                                <p class="mb-2">
                                    <i class="fas fa-code me-2"></i><strong>Specification:</strong> {{
                                    exam.specification_code }}
                                </p>
                                {% endif %}

                                <div class="d-flex gap-2 mt-3">
                                    <a href="{{ url_for('gcse.revision_schedule') }}"
                                        class="btn btn-sm btn-outline-primary flex-fill">
                                        <i class="fas fa-calendar me-1"></i>Revision Plan
                                    </a>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteExam('{{ exam.id }}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <!-- Empty State -->
    <div class="row">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-body text-center py-5">
                    <i class="fas fa-calendar-alt fa-4x text-primary mb-4"></i>
                    <h3>No Exams Scheduled Yet</h3>
                    <p class="text-muted mb-4">
                        Start by adding your GCSE exam dates. This will help you:
                    </p>
                    <div class="row justify-content-center mb-4">
                        <div class="col-md-8">
                            <ul class="text-start">
                                <li>Get personalized countdown timers</li>
                                <li>Receive AI-powered revision schedules</li>
                                <li>Track your preparation progress</li>
                                <li>Plan your study sessions effectively</li>
                            </ul>
                        </div>
                    </div>
                    <a href="{{ url_for('gcse.create_exam') }}" class="btn btn-primary btn-lg">
                        <i class="fas fa-plus me-2"></i>Schedule Your First Exam
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
    // Calculate days to next exam
    document.addEventListener('DOMContentLoaded', function () {
        const exams = {{ exams_by_subject| tojson | safe
    }};
    let minDays = Infinity;

    for (const subjectId in exams) {
        exams[subjectId].forEach(exam => {
            if (exam.countdown && exam.countdown.status !== 'past') {
                const totalDays = (exam.countdown.months || 0) * 30 + (exam.countdown.weeks || 0) * 7 + (exam.countdown.days || 0);
                if (totalDays < minDays) {
                    minDays = totalDays;
                }
            }
        });
    }

    if (minDays !== Infinity) {
        document.getElementById('nextExamDays').textContent = minDays === 0 ? 'Today!' : minDays;
    }
    });

    // Delete exam function
    function deleteExam(examId) {
        if (confirm('Are you sure you want to delete this exam?')) {
            fetch(`/gcse/exams/${examId}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        alert('Failed to delete exam. Please try again.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to delete exam. Please try again.');
                });
        }
    }
</script>
{% endblock %}