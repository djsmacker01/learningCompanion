{% extends "base.html" %}

{% block title %}GCSE Past Papers - Learning Companion{% endblock %}

{% block extra_css %}
<style>
    .paper-card {
        transition: transform 0.2s ease-in-out;
        border: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        height: 100%;
    }

    .paper-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
    }

    .exam-board-badge {
        background: #2196F3;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: bold;
    }

    .difficulty-badge {
        padding: 2px 6px;
        border-radius: 8px;
        font-size: 0.7em;
        font-weight: bold;
    }

    .difficulty-foundation {
        background: #28a745;
        color: white;
    }

    .difficulty-higher {
        background: #dc3545;
        color: white;
    }

    .difficulty-both {
        background: #ffc107;
        color: #212529;
    }

    .filter-section {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 30px;
    }

    .recent-session {
        background: #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
    }

    .grade-display {
        font-weight: bold;
        font-size: 1.2em;
    }

    .grade-9,
    .grade-8,
    .grade-7 {
        color: #28a745;
    }

    .grade-6,
    .grade-5,
    .grade-4 {
        color: #ffc107;
    }

    .grade-3,
    .grade-2,
    .grade-1,
    .grade-u {
        color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="fas fa-file-alt me-2"></i>GCSE Past Papers</h1>
                <div>
                    <a href="{{ url_for('gcse.gcse_dashboard') }}" class="btn btn-outline-secondary me-2">
                        <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
                    </a>
                    <a href="{{ url_for('gcse_past_papers.practice_history') }}" class="btn btn-primary">
                        <i class="fas fa-history me-1"></i>Practice History
                    </a>
                </div>
            </div>
        </div>
    </div>

    
    <div class="filter-section">
        <div class="row">
            <div class="col-md-3 mb-3">
                <label for="subjectFilter" class="form-label">Subject:</label>
                <select class="form-select" id="subjectFilter">
                    <option value="">All Subjects</option>
                    {% for subject in subjects %}
                    <option value="{{ subject.id }}" {% if selected_subject_id==subject.id %}selected{% endif %}>
                        {{ subject.subject_name }} ({{ subject.exam_board }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2 mb-3">
                <label for="examBoardFilter" class="form-label">Exam Board:</label>
                <select class="form-select" id="examBoardFilter">
                    <option value="">All Boards</option>
                    {% for board in exam_boards %}
                    <option value="{{ board }}" {% if selected_exam_board==board %}selected{% endif %}>{{ board }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2 mb-3">
                <label for="examYearFilter" class="form-label">Year:</label>
                <select class="form-select" id="examYearFilter">
                    <option value="">All Years</option>
                    {% for year in range(2024, 2018, -1) %}
                    <option value="{{ year }}" {% if selected_exam_year==year %}selected{% endif %}>{{ year }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2 mb-3">
                <label for="difficultyFilter" class="form-label">Difficulty:</label>
                <select class="form-select" id="difficultyFilter">
                    <option value="">All Levels</option>
                    <option value="Foundation" {% if selected_difficulty_level=='Foundation' %}selected{% endif %}>
                        Foundation</option>
                    <option value="Higher" {% if selected_difficulty_level=='Higher' %}selected{% endif %}>Higher
                    </option>
                    <option value="Both" {% if selected_difficulty_level=='Both' %}selected{% endif %}>Both</option>
                </select>
            </div>
            <div class="col-md-3 mb-3 d-flex align-items-end">
                <button type="button" class="btn btn-primary" onclick="applyFilters()">
                    <i class="fas fa-search me-1"></i>Apply Filters
                </button>
                <button type="button" class="btn btn-outline-secondary ms-2" onclick="clearFilters()">
                    <i class="fas fa-times me-1"></i>Clear
                </button>
            </div>
        </div>
    </div>

    <div class="row">
        
        <div class="col-lg-8">
            {% if past_papers %}
            <div class="row">
                {% for paper in past_papers %}
                <div class="col-md-6 mb-4">
                    <div class="card paper-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <h5 class="card-title">{{ paper.paper_title }}</h5>
                                <span class="exam-board-badge">{{ paper.exam_board }}</span>
                            </div>

                            <div class="mb-3">
                                <span class="difficulty-badge difficulty-{{ paper.difficulty_level|lower }}">
                                    {{ paper.difficulty_level }}
                                </span>
                                <span class="badge bg-secondary ms-2">{{ paper.exam_year }} {{ paper.exam_month
                                    }}</span>
                                {% if paper.paper_number %}
                                <span class="badge bg-info ms-2">Paper {{ paper.paper_number }}</span>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                <div class="row text-center">
                                    <div class="col-4">
                                        <small class="text-muted">Questions</small><br>
                                        <strong>{{ paper.questions|length }}</strong>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted">Duration</small><br>
                                        <strong>{{ paper.duration_minutes }}m</strong>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted">Marks</small><br>
                                        <strong>{{ paper.total_marks }}</strong>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <small class="text-muted">
                                        {% if paper.questions %}
                                        {% set question_types =
                                        paper.questions|map(attribute='question_type')|unique|list %}
                                        {{ question_types|join(', ') }}
                                        {% endif %}
                                    </small>
                                </div>
                                <a href="{{ url_for('gcse_past_papers.past_paper_detail', paper_id=paper.id) }}"
                                    class="btn btn-primary btn-sm">
                                    <i class="fas fa-eye me-1"></i>View Details
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-file-alt fa-4x text-muted mb-3"></i>
                <h4>No Past Papers Found</h4>
                <p class="text-muted">Select a subject and apply filters to view available past papers.</p>
            </div>
            {% endif %}
        </div>

        
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>Recent Practice Sessions</h5>
                </div>
                <div class="card-body">
                    {% if recent_sessions %}
                    {% for session in recent_sessions %}
                    <div class="recent-session">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="mb-0">{{ session.paper_title if session.paper_title else 'Practice Session' }}
                            </h6>
                            <span class="badge bg-{{ 'success' if session.status == 'completed' else 'warning' }}">
                                {{ session.status|title }}
                            </span>
                        </div>

                        {% if session.status == 'completed' %}
                        <div class="row text-center mb-2">
                            <div class="col-4">
                                <small class="text-muted">Score</small><br>
                                <strong class="grade-display grade-{{ session.grade|lower if session.grade else 'u' }}">
                                    {{ session.achieved_marks }}/{{ session.total_marks }}
                                </strong>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">Grade</small><br>
                                <strong class="grade-display grade-{{ session.grade|lower if session.grade else 'u' }}">
                                    {{ session.grade if session.grade else 'U' }}
                                </strong>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">Time</small><br>
                                <strong>{{ session.time_taken_minutes }}m</strong>
                            </div>
                        </div>
                        {% else %}
                        <div class="text-center">
                            <small class="text-muted">In Progress</small>
                        </div>
                        {% endif %}

                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                {{ session.started_at.strftime('%d %b %Y') if session.started_at }}
                            </small>
                            {% if session.status == 'completed' %}
                            <a href="{{ url_for('gcse_past_papers.practice_results', session_id=session.id) }}"
                                class="btn btn-sm btn-outline-primary">
                                View Results
                            </a>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-play-circle fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">No practice sessions yet.<br>Start practicing with past papers!</p>
                    </div>
                    {% endif %}

                    <div class="text-center mt-3">
                        <a href="{{ url_for('gcse_past_papers.practice_history') }}"
                            class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-list me-1"></i>View All Sessions
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function applyFilters() {
        const subjectId = document.getElementById('subjectFilter').value;
        const examBoard = document.getElementById('examBoardFilter').value;
        const examYear = document.getElementById('examYearFilter').value;
        const difficultyLevel = document.getElementById('difficultyFilter').value;

        // Build query parameters
        const params = new URLSearchParams();
        if (subjectId) params.append('subject_id', subjectId);
        if (examBoard) params.append('exam_board', examBoard);
        if (examYear) params.append('exam_year', examYear);
        if (difficultyLevel) params.append('difficulty_level', difficultyLevel);

        // Redirect with filters
        window.location.href = '{{ url_for("gcse_past_papers.past_papers_list") }}?' + params.toString();
    }

    function clearFilters() {
        document.getElementById('subjectFilter').value = '';
        document.getElementById('examBoardFilter').value = '';
        document.getElementById('examYearFilter').value = '';
        document.getElementById('difficultyFilter').value = '';
        applyFilters();
    }

    // Auto-apply filters when subject changes
    document.getElementById('subjectFilter').addEventListener('change', function () {
        if (this.value) {
            applyFilters();
        }
    });
</script>
{% endblock %}