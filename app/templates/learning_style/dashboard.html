{% extends "base.html" %}

{% block title %}Learning Style Detection - Learning Companion{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Header -->
        <div class="col-12">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-gradient-info text-white">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-brain fa-2x me-3"></i>
                        <div>
                            <h2 class="h4 mb-0">Learning Style Detection & Personalization</h2>
                            <p class="mb-0 opacity-75">Advanced AI-powered learning style analysis and adaptive learning
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Learning Style Assessment -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-clipboard-check text-primary me-2"></i>
                        Learning Style Assessment
                    </h5>
                </div>
                <div class="card-body">
                    <div id="assessmentContainer">
                        <div class="text-center py-4">
                            <i class="fas fa-user-graduate fa-3x text-muted mb-3"></i>
                            <h5>Discover Your Learning Style</h5>
                            <p class="text-muted">Take our comprehensive assessment to understand how you learn best</p>
                            <button class="btn btn-primary btn-lg" onclick="startLearningStyleAssessment()">
                                <i class="fas fa-play me-2"></i>Start Assessment
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Adaptive Learning Path Generator -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-route text-success me-2"></i>
                        Adaptive Learning Path Generator
                    </h5>
                </div>
                <div class="card-body">
                    <form id="adaptiveLearningPathForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Subject</label>
                                    <select class="form-select" id="pathSubject" required>
                                        <option value="">Choose a subject...</option>
                                        <!-- Subjects will be loaded dynamically -->
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Current Level</label>
                                    <select class="form-select" id="pathCurrentLevel" required>
                                        <option value="beginner">Beginner</option>
                                        <option value="intermediate">Intermediate</option>
                                        <option value="advanced">Advanced</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Target Level</label>
                                    <select class="form-select" id="pathTargetLevel" required>
                                        <option value="intermediate">Intermediate</option>
                                        <option value="advanced">Advanced</option>
                                        <option value="expert">Expert</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Learning Style</label>
                                    <select class="form-select" id="pathLearningStyle" required>
                                        <option value="visual">Visual</option>
                                        <option value="auditory">Auditory</option>
                                        <option value="kinesthetic">Kinesthetic</option>
                                        <option value="reading_writing">Reading/Writing</option>
                                        <option value="multimodal">Multimodal</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-success" onclick="createAdaptiveLearningPath()">
                            <i class="fas fa-magic me-2"></i>Generate Learning Path
                        </button>
                    </form>

                    <div id="adaptiveLearningPathResult" class="mt-3" style="display: none;">
                        <!-- Results will be displayed here -->
                    </div>
                </div>
            </div>

            <!-- Intelligent Study Schedule -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-calendar-alt text-warning me-2"></i>
                        Intelligent Study Schedule
                    </h5>
                </div>
                <div class="card-body">
                    <form id="studyScheduleForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Learning Style</label>
                                    <select class="form-select" id="scheduleLearningStyle" required>
                                        <option value="visual">Visual</option>
                                        <option value="auditory">Auditory</option>
                                        <option value="kinesthetic">Kinesthetic</option>
                                        <option value="reading_writing">Reading/Writing</option>
                                        <option value="multimodal">Multimodal</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Available Time (hours per day)</label>
                                    <input type="number" class="form-control" id="availableTime" value="3" min="1"
                                        max="12">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Subjects to Study</label>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="subjectMath"
                                            value="Mathematics">
                                        <label class="form-check-label" for="subjectMath">Mathematics</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="subjectEnglish"
                                            value="English">
                                        <label class="form-check-label" for="subjectEnglish">English</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="subjectScience"
                                            value="Science">
                                        <label class="form-check-label" for="subjectScience">Science</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-warning" onclick="createIntelligentStudySchedule()">
                            <i class="fas fa-clock me-2"></i>Create Study Schedule
                        </button>
                    </form>

                    <div id="studyScheduleResult" class="mt-3" style="display: none;">
                        <!-- Results will be displayed here -->
                    </div>
                </div>
            </div>

            <!-- Learning Progress Analysis -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line text-info me-2"></i>
                        Learning Progress Analysis
                    </h5>
                </div>
                <div class="card-body">
                    <form id="progressAnalysisForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Analysis Period</label>
                                    <select class="form-select" id="analysisPeriod">
                                        <option value="7_days">Last 7 Days</option>
                                        <option value="30_days" selected>Last 30 Days</option>
                                        <option value="90_days">Last 90 Days</option>
                                        <option value="all_time">All Time</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Analysis Depth</label>
                                    <select class="form-select" id="analysisDepth">
                                        <option value="basic">Basic</option>
                                        <option value="comprehensive" selected>Comprehensive</option>
                                        <option value="detailed">Detailed</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-info" onclick="analyzeLearningProgress()">
                            <i class="fas fa-search me-2"></i>Analyze Progress
                        </button>
                    </form>

                    <div id="progressAnalysisResult" class="mt-3" style="display: none;">
                        <!-- Results will be displayed here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Learning Styles Info -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-gradient-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>Learning Styles
                    </h5>
                </div>
                <div class="card-body">
                    <div id="learningStylesInfo">
                        <div class="text-center py-3">
                            <i class="fas fa-spinner fa-spin fa-2x text-muted mb-3"></i>
                            <p class="text-muted">Loading learning styles...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-bolt me-2"></i>Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        <a href="#" class="list-group-item list-group-item-action" onclick="generateLearningInsights()">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-lightbulb text-warning me-3"></i>
                                <div>
                                    <h6 class="mb-1">Generate Insights</h6>
                                    <small class="text-muted">AI-powered learning insights</small>
                                </div>
                            </div>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action" onclick="personalizeContent()">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-user-cog text-info me-3"></i>
                                <div>
                                    <h6 class="mb-1">Personalize Content</h6>
                                    <small class="text-muted">Adapt content to your style</small>
                                </div>
                            </div>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action"
                            onclick="viewPersonalizationCenter()">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-cogs text-success me-3"></i>
                                <div>
                                    <h6 class="mb-1">Personalization Center</h6>
                                    <small class="text-muted">Advanced personalization</small>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Learning Tips -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-tips me-2"></i>Learning Tips
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-primary">
                        <h6>Visual Learners:</h6>
                        <p class="mb-0">Use mind maps, diagrams, and color coding to organize information effectively.
                        </p>
                    </div>
                    <div class="alert alert-success">
                        <h6>Auditory Learners:</h6>
                        <p class="mb-0">Record yourself explaining concepts and listen to educational podcasts.</p>
                    </div>
                    <div class="alert alert-warning">
                        <h6>Kinesthetic Learners:</h6>
                        <p class="mb-0">Take frequent breaks and use hands-on activities to reinforce learning.</p>
                    </div>
                    <div class="alert alert-info">
                        <h6>Reading/Writing Learners:</h6>
                        <p class="mb-0">Take detailed notes and create written summaries to solidify understanding.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Assessment Modal -->
<div class="modal fade" id="assessmentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Learning Style Assessment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="assessmentContent">
                    <!-- Assessment questions will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="submitAssessment()" id="submitAssessmentBtn"
                    disabled>Submit Assessment</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentQuestionIndex = 0;
    let assessmentQuestions = [];
    let assessmentAnswers = [];

    // Load data on page load
    document.addEventListener('DOMContentLoaded', function () {
        loadLearningStyles();
        loadSubjects();
    });

    function loadSubjects() {
        fetch('/gcse-ai/api/subjects')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error loading subjects:', data.error);
                    return;
                }

                // Populate subject dropdown
                const subjectSelect = document.getElementById('pathSubject');
                if (subjectSelect) {
                    subjectSelect.innerHTML = '<option value="">Choose a subject...</option>';
                    data.subjects.forEach(subject => {
                        const option = document.createElement('option');
                        option.value = subject.name;
                        option.textContent = subject.name;
                        subjectSelect.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading subjects:', error);
            });
    }

    function loadLearningStyles() {
        fetch('/learning-style/api/learning-styles')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error loading learning styles:', data.error);
                    return;
                }

                displayLearningStyles(data.learning_styles);
            })
            .catch(error => {
                console.error('Error loading learning styles:', error);
            });
    }

    function displayLearningStyles(learningStyles) {
        const container = document.getElementById('learningStylesInfo');
        let html = '';

        learningStyles.forEach(style => {
            html += `
                <div class="mb-3">
                    <h6 class="text-primary">${style.name}</h6>
                    <p class="small text-muted mb-2">${style.description}</p>
                    <div class="small">
                        <strong>Key Characteristics:</strong>
                        <ul class="mb-0">
                            ${style.characteristics.map(char => `<li>${char}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    function startLearningStyleAssessment() {
        fetch('/learning-style/api/learning-style-assessment')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error loading assessment:', data.error);
                    return;
                }

                assessmentQuestions = data.assessment_questions;
                currentQuestionIndex = 0;
                assessmentAnswers = [];

                showAssessmentQuestion();

                const modal = new bootstrap.Modal(document.getElementById('assessmentModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error loading assessment:', error);
            });
    }

    function showAssessmentQuestion() {
        const container = document.getElementById('assessmentContent');
        const question = assessmentQuestions[currentQuestionIndex];
        const isLastQuestion = currentQuestionIndex === assessmentQuestions.length - 1;

        let html = `
            <div class="assessment-question">
                <div class="mb-3">
                    <small class="text-muted">Question ${currentQuestionIndex + 1} of ${assessmentQuestions.length}</small>
                    <div class="progress mt-2" style="height: 6px;">
                        <div class="progress-bar bg-success" style="width: ${((currentQuestionIndex + 1) / assessmentQuestions.length) * 100}%"></div>
                    </div>
                </div>
                
                <h5 class="mb-4">${question.question}</h5>
                
                <div class="options-group mb-4">
        `;

        question.options.forEach((option, idx) => {
            const optionLetter = String.fromCharCode(65 + idx); // A, B, C, D
            html += `
                <div class="option-card mb-3 p-3 border rounded" style="cursor: pointer; transition: all 0.3s ease;" 
                     onclick="selectAnswerAndProceed('${option.style}', this)">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="question_${question.id}" 
                               id="option_${option.id}" value="${option.style}" style="cursor: pointer;">
                        <label class="form-check-label d-flex align-items-center" for="option_${option.id}" style="cursor: pointer; width: 100%;">
                            <span class="badge bg-primary me-3">${optionLetter}</span>
                            <span>${option.text}</span>
                        </label>
                    </div>
                </div>
            `;
        });

        html += `
                </div>
                
                <div class="d-flex justify-content-between mt-4">
                    <button class="btn btn-outline-secondary" onclick="previousQuestion()" ${currentQuestionIndex === 0 ? 'disabled' : ''}>
                        <i class="fas fa-arrow-left me-2"></i>Previous
                    </button>
                    <button class="btn btn-success" id="nextQuestionBtn" onclick="nextQuestion()" disabled>
                        ${isLastQuestion ? '<i class="fas fa-check me-2"></i>Finish' : '<i class="fas fa-arrow-right me-2"></i>Next'}
                    </button>
                </div>
            </div>
        `;

        container.innerHTML = html;

        // Check if this question was already answered
        if (assessmentAnswers[currentQuestionIndex]) {
            document.getElementById('nextQuestionBtn').disabled = false;
        }
    }

    function selectAnswerAndProceed(style, optionCard) {
        // Save answer
        assessmentAnswers[currentQuestionIndex] = {
            question_id: assessmentQuestions[currentQuestionIndex].id,
            style: style
        };

        // Visual feedback - highlight selected option
        document.querySelectorAll('.option-card').forEach(card => {
            card.style.background = 'white';
            card.style.borderColor = '#dee2e6';
        });
        optionCard.style.background = '#e7f3ff';
        optionCard.style.borderColor = '#0d6efd';

        // Check the radio button
        const radioInput = optionCard.querySelector('input[type="radio"]');
        if (radioInput) {
            radioInput.checked = true;
        }

        // Enable next button
        const nextBtn = document.getElementById('nextQuestionBtn');
        if (nextBtn) {
            nextBtn.disabled = false;
        }

        // Enable submit button if this is last question
        const isLastQuestion = currentQuestionIndex === assessmentQuestions.length - 1;
        if (isLastQuestion) {
            document.getElementById('submitAssessmentBtn').disabled = false;
        }
    }

    function nextQuestion() {
        if (currentQuestionIndex < assessmentQuestions.length - 1) {
            currentQuestionIndex++;
            showAssessmentQuestion();
        } else {
            // Last question - enable submit
            document.getElementById('submitAssessmentBtn').disabled = false;
        }
    }

    function previousQuestion() {
        if (currentQuestionIndex > 0) {
            currentQuestionIndex--;
            showAssessmentQuestion();
        }
    }

    function selectAnswer(style) {
        // Keep for backward compatibility
        assessmentAnswers[currentQuestionIndex] = {
            question_id: assessmentQuestions[currentQuestionIndex].id,
            style: style
        };

        // Enable submit button if all questions answered
        if (assessmentAnswers.length === assessmentQuestions.length &&
            assessmentAnswers.every(answer => answer !== undefined)) {
            document.getElementById('submitAssessmentBtn').disabled = false;
        }
    }

    function submitAssessment() {
        const submitBtn = document.getElementById('submitAssessmentBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';

        fetch('/learning-style/api/submit-assessment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                answers: assessmentAnswers
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error submitting assessment:', data.error);
                    alert('Error submitting assessment: ' + data.error);
                    // Re-enable button on error
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'Submit Assessment';
                    return;
                }

                // Show results
                showAssessmentResults(data.assessment_results);

                // Keep button disabled and change text to show completion
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i>Assessment Completed';
                submitBtn.classList.remove('btn-primary');
                submitBtn.classList.add('btn-success');
            })
            .catch(error => {
                console.error('Error submitting assessment:', error);
                alert('Error submitting assessment');
                // Re-enable button on error
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Submit Assessment';
            });
    }

    function showAssessmentResults(results) {
        const container = document.getElementById('assessmentContent');
        const analysis = results.analysis;

        let html = `
            <div class="text-center mb-4">
                <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                <h5>Assessment Complete!</h5>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">Your Primary Learning Style</h6>
                            <h4 class="text-primary">${results.primary_learning_style.toUpperCase()}</h4>
                            <p class="card-text">${analysis.recommendations[0] || 'Great choice!'}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">Style Scores</h6>
                            ${Object.entries(results.style_scores).map(([style, score]) => `
                                <div class="d-flex justify-content-between mb-1">
                                    <span>${style.charAt(0).toUpperCase() + style.slice(1)}:</span>
                                    <span>${score}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-4">
                <h6>Personalized Recommendations:</h6>
                <ul>
                    ${analysis.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                </ul>
            </div>
        `;

        container.innerHTML = html;

        // Hide the submit button and show "Close" or "Start New" button
        const submitBtn = document.getElementById('submitAssessmentBtn');
        if (submitBtn) {
            submitBtn.style.display = 'none';
        }

        // Update modal footer to show completion options
        const modalFooter = submitBtn.closest('.modal-footer');
        if (modalFooter) {
            // Find close button
            const closeBtn = modalFooter.querySelector('[data-bs-dismiss="modal"]');
            if (closeBtn) {
                closeBtn.innerHTML = '<i class="fas fa-check me-2"></i>Done';
                closeBtn.classList.remove('btn-secondary');
                closeBtn.classList.add('btn-success');
            }
        }
    }

    function createAdaptiveLearningPath() {
        const subject = document.getElementById('pathSubject').value;
        const currentLevel = document.getElementById('pathCurrentLevel').value;
        const targetLevel = document.getElementById('pathTargetLevel').value;
        const learningStyle = document.getElementById('pathLearningStyle').value;

        if (!subject) {
            alert('Please select a subject');
            return;
        }

        const resultDiv = document.getElementById('adaptiveLearningPathResult');
        resultDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin me-2"></i>Creating adaptive learning path...</div>';
        resultDiv.style.display = 'block';

        fetch('/learning-style/api/create-adaptive-learning-path', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                subject: subject,
                current_level: currentLevel,
                target_level: targetLevel,
                learning_style: learningStyle
            })
        })
            .then(response => response.json())
            .then(data => {
                console.log('Adaptive Learning Path Data:', data);

                if (data.error) {
                    resultDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i>${data.error}</div>`;
                } else {
                    let html = `
                        <div class="result-card" style="background: white; border-radius: 12px; padding: 20px; border: 2px solid #e9ecef;">
                            <div class="result-header" style="border-bottom: 2px solid #28a745; padding-bottom: 12px; margin-bottom: 15px;">
                                <h6 style="color: #28a745; font-weight: 700; font-size: 18px;">
                                    <i class="fas fa-route me-2"></i>Adaptive Learning Path Created!
                                </h6>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <strong>Subject:</strong><br>
                                    <span class="text-primary">${data.subject}</span>
                                </div>
                                <div class="col-md-4">
                                    <strong>Learning Style:</strong><br>
                                    <span class="text-info">${data.learning_style}</span>
                                </div>
                                <div class="col-md-4">
                                    <strong>Completion Time:</strong><br>
                                    <span class="text-success">${data.estimated_completion_time || 'Varies'}</span>
                                </div>
                            </div>
                    `;

                    // Learning Modules
                    if (data.learning_modules && Array.isArray(data.learning_modules) && data.learning_modules.length > 0) {
                        html += `
                            <div class="result-section" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #28a745;">
                                <h6 style="color: #28a745; font-weight: 600; margin-bottom: 15px;">
                                    <i class="fas fa-book me-2"></i>Learning Modules
                                </h6>
                        `;
                        data.learning_modules.forEach((module, idx) => {
                            const moduleName = typeof module === 'string' ? module : (module.name || module.title || `Module ${idx + 1}`);
                            const moduleDesc = typeof module === 'object' ? (module.description || '') : '';

                            html += `
                                <div class="module-card mb-3 p-3 bg-white border rounded" style="border-left: 4px solid #28a745;">
                                    <div class="d-flex align-items-start">
                                        <span class="badge bg-success me-3" style="font-size: 16px; padding: 8px 12px;">${idx + 1}</span>
                                        <div style="flex: 1;">
                                            <h6 class="mb-2" style="color: #212529; font-weight: 600;">${moduleName}</h6>
                                            ${moduleDesc ? `<p class="mb-0 text-muted" style="line-height: 1.6;">${moduleDesc}</p>` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                    }

                    // Adaptive Progression
                    if (data.adaptive_progression && typeof data.adaptive_progression === 'object') {
                        html += `
                            <div class="result-section" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #17a2b8;">
                                <h6 style="color: #17a2b8; font-weight: 600; margin-bottom: 10px;">
                                    <i class="fas fa-chart-line me-2"></i>Progression Plan
                                </h6>
                                <p class="mb-0">Your learning path adapts based on your progress and performance.</p>
                            </div>
                        `;
                    }

                    // Learning Milestones
                    if (data.learning_milestones && Array.isArray(data.learning_milestones) && data.learning_milestones.length > 0) {
                        html += `
                            <div class="result-section" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #ffc107;">
                                <h6 style="color: #ffc107; font-weight: 600; margin-bottom: 15px;">
                                    <i class="fas fa-trophy me-2"></i>Learning Milestones
                                </h6>
                        `;
                        data.learning_milestones.forEach((milestone, idx) => {
                            let milestoneName = typeof milestone === 'string' ? milestone : (milestone.name || milestone.title || 'Milestone');

                            // Clean up milestone text - remove "Module X Milestone:" prefix
                            milestoneName = milestoneName.replace(/^Module\s*\d+\s*Milestone:\s*/i, '').trim();

                            html += `
                                <div class="milestone-card mb-3 p-3 bg-white border rounded" style="border-left: 4px solid #ffc107;">
                                    <div class="d-flex align-items-start">
                                        <i class="fas fa-flag-checkered text-warning me-3" style="font-size: 20px; margin-top: 2px;"></i>
                                        <div style="flex: 1;">
                                            <p class="mb-0" style="line-height: 1.6; color: #495057;">${milestoneName}</p>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                    }

                    // Recommendations
                    if (data.recommendations && Array.isArray(data.recommendations) && data.recommendations.length > 0) {
                        html += `
                            <div class="result-section" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #0d6efd;">
                                <h6 style="color: #0d6efd; font-weight: 600; margin-bottom: 10px;">
                                    <i class="fas fa-lightbulb me-2"></i>Recommendations
                                </h6>
                                <ul class="list-unstyled mb-0">
                        `;
                        data.recommendations.forEach(rec => {
                            html += `<li class="mb-2"><i class="fas fa-star text-primary me-2"></i>${rec}</li>`;
                        });
                        html += '</ul></div>';
                    }

                    html += '</div>';
                    resultDiv.innerHTML = html;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                resultDiv.innerHTML = '<div class="alert alert-danger">Error creating adaptive learning path</div>';
            });
    }

    function createIntelligentStudySchedule() {
        const learningStyle = document.getElementById('scheduleLearningStyle').value;
        const availableTime = document.getElementById('availableTime').value;

        const selectedSubjects = [];
        if (document.getElementById('subjectMath').checked) selectedSubjects.push('Mathematics');
        if (document.getElementById('subjectEnglish').checked) selectedSubjects.push('English');
        if (document.getElementById('subjectScience').checked) selectedSubjects.push('Science');

        if (selectedSubjects.length === 0) {
            alert('Please select at least one subject');
            return;
        }

        const resultDiv = document.getElementById('studyScheduleResult');
        resultDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin me-2"></i>Creating intelligent study schedule...</div>';
        resultDiv.style.display = 'block';

        const availableTimeData = {};
        for (let day of ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday']) {
            availableTimeData[day] = {
                'morning': Math.floor(availableTime * 0.3),
                'afternoon': Math.floor(availableTime * 0.4),
                'evening': Math.floor(availableTime * 0.3)
            };
        }

        fetch('/learning-style/api/create-intelligent-study-schedule', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                learning_style: learningStyle,
                available_time: availableTimeData,
                subjects: selectedSubjects,
                priorities: selectedSubjects.reduce((acc, subject, index) => {
                    acc[subject] = index === 0 ? 'high' : 'medium';
                    return acc;
                }, {})
            })
        })
            .then(response => response.json())
            .then(data => {
                console.log('Study Schedule Data:', data);

                if (data.error) {
                    resultDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i>${data.error}</div>`;
                } else {
                    let html = `
                        <div class="result-card" style="background: white; border-radius: 12px; padding: 20px; border: 2px solid #e9ecef;">
                            <div class="result-header" style="border-bottom: 2px solid #ffc107; padding-bottom: 12px; margin-bottom: 15px;">
                                <h6 style="color: #ffc107; font-weight: 700; font-size: 18px;">
                                    <i class="fas fa-calendar-check me-2"></i>Intelligent Study Schedule Created!
                                </h6>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>Learning Style:</strong><br>
                                    <span class="text-primary">${data.user_learning_style || learningStyle}</span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Effectiveness Score:</strong><br>
                                    <span class="text-success">${data.schedule_effectiveness_score || 85}%</span>
                                </div>
                            </div>
                    `;

                    // Weekly Schedule - Beautiful Calendar View
                    if (data.weekly_schedule && typeof data.weekly_schedule === 'object') {
                        html += `
                            <div class="result-section" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #ffc107;">
                                <h6 style="color: #ffc107; font-weight: 600; margin-bottom: 15px;">
                                    <i class="fas fa-calendar-week me-2"></i>Weekly Study Schedule
                                </h6>
                                <div class="weekly-calendar">
                        `;
                        
                        const dayOrder = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                        const dayIcons = {
                            'monday': 'üåÖ',
                            'tuesday': 'üí™',
                            'wednesday': '‚ö°',
                            'thursday': 'üéØ',
                            'friday': 'üåü',
                            'saturday': 'üìö',
                            'sunday': 'üßò'
                        };
                        
                        dayOrder.forEach(day => {
                            const sessions = data.weekly_schedule[day];
                            if (sessions && Array.isArray(sessions)) {
                                html += `
                                    <div class="day-card mb-3 p-3 bg-white border rounded shadow-sm">
                                        <div class="day-header mb-3" style="border-bottom: 2px solid #ffc107; padding-bottom: 8px;">
                                            <h6 class="mb-0" style="color: #212529; font-weight: 700;">
                                                ${dayIcons[day]} ${day.charAt(0).toUpperCase() + day.slice(1)}
                                            </h6>
                                        </div>
                                        <div class="day-sessions">
                                `;
                                
                                sessions.forEach((session, idx) => {
                                    const timeSlotColors = {
                                        'morning': '#28a745',
                                        'afternoon': '#ffc107',
                                        'evening': '#17a2b8'
                                    };
                                    const timeSlotIcons = {
                                        'morning': 'üåÖ',
                                        'afternoon': '‚òÄÔ∏è',
                                        'evening': 'üåô'
                                    };
                                    
                                    const color = timeSlotColors[session.time_slot] || '#6c757d';
                                    const icon = timeSlotIcons[session.time_slot] || 'üìñ';
                                    
                                    html += `
                                        <div class="session-block mb-2 p-2 rounded" style="border-left: 4px solid ${color}; background: #f8f9fa;">
                                            <div class="d-flex align-items-start">
                                                <span class="me-2" style="font-size: 18px;">${icon}</span>
                                                <div style="flex: 1;">
                                                    <div class="d-flex justify-content-between align-items-start mb-1">
                                                        <strong style="color: ${color}; font-size: 14px;">${session.subject || 'Study'}</strong>
                                                        <span class="badge" style="background-color: ${color}; font-size: 11px;">${session.duration || '45 min'}</span>
                                                    </div>
                                                    <div style="font-size: 12px; color: #6c757d;">
                                                        <i class="fas fa-tasks me-1"></i>${session.activity || 'Study session'}
                                                    </div>
                                                    <div style="font-size: 11px; color: #6c757d; margin-top: 4px;">
                                                        <i class="far fa-clock me-1"></i>${session.time_slot.charAt(0).toUpperCase() + session.time_slot.slice(1)}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                });
                                
                                html += `
                                        </div>
                                    </div>
                                `;
                            }
                        });
                        
                        html += '</div></div>';
                    }

                    // Optimization Tips
                    if (data.optimization_tips && Array.isArray(data.optimization_tips) && data.optimization_tips.length > 0) {
                        html += `
                            <div class="result-section" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #28a745;">
                                <h6 style="color: #28a745; font-weight: 600; margin-bottom: 15px;">
                                    <i class="fas fa-lightbulb me-2"></i>Session Optimization Tips
                                </h6>
                        `;
                        data.optimization_tips.forEach((tip, idx) => {
                            html += `
                                <div class="tip-card mb-2 p-3 bg-white border-start border-4 border-success rounded" style="border-left-color: #28a745 !important;">
                                    <div class="d-flex align-items-start">
                                        <i class="fas fa-check-circle text-success me-2" style="margin-top: 2px;"></i>
                                        <p class="mb-0" style="line-height: 1.6; color: #495057;">${tip}</p>
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                    }
                    
                    // Break Recommendations
                    if (data.break_recommendations && Array.isArray(data.break_recommendations) && data.break_recommendations.length > 0) {
                        html += `
                            <div class="result-section" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #17a2b8;">
                                <h6 style="color: #17a2b8; font-weight: 600; margin-bottom: 15px;">
                                    <i class="fas fa-coffee me-2"></i>Break Recommendations
                                </h6>
                        `;
                        data.break_recommendations.forEach((breakRec, idx) => {
                            const activity = typeof breakRec === 'string' ? breakRec : (breakRec.activity || 'Take a break');
                            const duration = typeof breakRec === 'object' ? breakRec.duration : '';
                            const benefit = typeof breakRec === 'object' ? breakRec.benefit : '';
                            
                            html += `
                                <div class="break-card mb-3 p-3 bg-white border rounded shadow-sm">
                                    <div class="d-flex align-items-start">
                                        <span class="badge bg-info me-3" style="font-size: 14px; padding: 8px 10px; height: fit-content;">${duration || '10m'}</span>
                                        <div style="flex: 1;">
                                            <h6 class="mb-1" style="color: #212529; font-weight: 600; font-size: 14px;">${activity}</h6>
                                            ${benefit ? `<p class="mb-0 text-muted" style="font-size: 12px; line-height: 1.5;"><i class="fas fa-info-circle me-1"></i>${benefit}</p>` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                    }
                    
                    // Motivation Triggers
                    if (data.motivation_triggers && Array.isArray(data.motivation_triggers) && data.motivation_triggers.length > 0) {
                        html += `
                            <div class="result-section" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #dc3545;">
                                <h6 style="color: #dc3545; font-weight: 600; margin-bottom: 15px;">
                                    <i class="fas fa-fire me-2"></i>Motivation Strategies
                                </h6>
                        `;
                        data.motivation_triggers.forEach((trigger, idx) => {
                            const triggerText = typeof trigger === 'string' ? trigger : (trigger.trigger || 'Motivation strategy');
                            const timing = typeof trigger === 'object' ? trigger.timing : '';
                            const benefit = typeof trigger === 'object' ? trigger.benefit : '';
                            
                            html += `
                                <div class="motivation-card mb-3 p-3 bg-white border rounded shadow-sm" style="border-left: 4px solid #dc3545;">
                                    <div class="d-flex align-items-start">
                                        <i class="fas fa-bolt text-danger me-2" style="font-size: 20px; margin-top: 2px;"></i>
                                        <div style="flex: 1;">
                                            <h6 class="mb-1" style="color: #212529; font-weight: 600; font-size: 14px;">${triggerText}</h6>
                                            ${timing ? `<p class="mb-1 text-muted" style="font-size: 12px;"><i class="far fa-clock me-1"></i><strong>When:</strong> ${timing}</p>` : ''}
                                            ${benefit ? `<p class="mb-0 text-muted" style="font-size: 12px;"><i class="fas fa-arrow-up me-1"></i><strong>Why:</strong> ${benefit}</p>` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                    }
                    
                    // Revision Schedule
                    if (data.revision_schedule && typeof data.revision_schedule === 'object') {
                        html += `
                            <div class="result-section" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #6f42c1;">
                                <h6 style="color: #6f42c1; font-weight: 600; margin-bottom: 15px;">
                                    <i class="fas fa-redo me-2"></i>Revision Strategy (Spaced Repetition)
                                </h6>
                                <div class="revision-content p-3 bg-white rounded">
                        `;
                        
                        if (data.revision_schedule.revision_intervals) {
                            html += `
                                <div class="mb-3">
                                    <strong style="color: #6f42c1;"><i class="fas fa-calendar-alt me-2"></i>Review Intervals:</strong>
                                    <div class="d-flex flex-wrap gap-2 mt-2">
                            `;
                            data.revision_schedule.revision_intervals.forEach(interval => {
                                html += `<span class="badge bg-light text-dark border" style="font-size: 12px; padding: 6px 12px;">${interval}</span>`;
                            });
                            html += '</div></div>';
                        }
                        
                        if (data.revision_schedule.revision_methods) {
                            html += `
                                <div class="mb-3">
                                    <strong style="color: #6f42c1;"><i class="fas fa-brain me-2"></i>Revision Methods:</strong>
                                    <ul class="mb-0 mt-2" style="list-style: none; padding-left: 0;">
                            `;
                            data.revision_schedule.revision_methods.forEach(method => {
                                html += `<li class="mb-1"><i class="fas fa-check text-success me-2"></i>${method}</li>`;
                            });
                            html += '</ul></div>';
                        }
                        
                        if (data.revision_schedule.tips) {
                            html += `
                                <div>
                                    <strong style="color: #6f42c1;"><i class="fas fa-star me-2"></i>Pro Tips:</strong>
                                    <ul class="mb-0 mt-2" style="list-style: none; padding-left: 0;">
                            `;
                            data.revision_schedule.tips.forEach(tip => {
                                html += `<li class="mb-1"><i class="fas fa-lightbulb text-warning me-2"></i>${tip}</li>`;
                            });
                            html += '</ul></div>';
                        }
                        
                        html += '</div></div>';
                    }
                    
                    // Intensity Patterns
                    if (data.intensity_patterns && typeof data.intensity_patterns === 'object') {
                        html += `
                            <div class="result-section" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #fd7e14;">
                                <h6 style="color: #fd7e14; font-weight: 600; margin-bottom: 15px;">
                                    <i class="fas fa-chart-line me-2"></i>Weekly Intensity Guide
                                </h6>
                                <div class="intensity-grid">
                        `;
                        
                        const intensityColors = {
                            'high': '#dc3545',
                            'medium': '#ffc107',
                            'low': '#28a745'
                        };
                        
                        const dayOrder = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                        dayOrder.forEach(day => {
                            const dayData = data.intensity_patterns[day];
                            if (dayData && typeof dayData === 'object') {
                                const intensity = dayData.intensity || 'medium';
                                const focus = dayData.focus || 'Study';
                                const color = intensityColors[intensity.toLowerCase()] || '#6c757d';
                                
                                html += `
                                    <div class="intensity-day mb-2 p-3 bg-white border-start border-4 rounded" style="border-left-color: ${color} !important;">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong style="color: #212529;">${day.charAt(0).toUpperCase() + day.slice(1)}</strong>
                                                <span class="badge ms-2" style="background-color: ${color}; font-size: 11px;">${intensity}</span>
                                            </div>
                                            <small class="text-muted">${focus}</small>
                                        </div>
                                    </div>
                                `;
                            }
                        });
                        
                        html += '</div></div>';
                    }

                    html += '</div>';
                    resultDiv.innerHTML = html;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                resultDiv.innerHTML = '<div class="alert alert-danger">Error creating study schedule</div>';
            });
    }

    function analyzeLearningProgress() {
        const timePeriod = document.getElementById('analysisPeriod').value;
        const analysisDepth = document.getElementById('analysisDepth').value;

        const resultDiv = document.getElementById('progressAnalysisResult');
        resultDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin me-2"></i>Analyzing learning progress...</div>';
        resultDiv.style.display = 'block';

        fetch(`/learning-style/api/analyze-learning-progress?time_period=${timePeriod}`)
            .then(response => response.json())
            .then(data => {
                console.log('Progress Analysis Data:', data);

                if (data.error) {
                    resultDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i>${data.error}</div>`;
                } else {
                    let html = `
                        <div class="result-card" style="background: white; border-radius: 12px; padding: 20px; border: 2px solid #e9ecef;">
                            <div class="result-header" style="border-bottom: 2px solid #17a2b8; padding-bottom: 12px; margin-bottom: 15px;">
                                <h6 style="color: #17a2b8; font-weight: 700; font-size: 18px;">
                                    <i class="fas fa-chart-line me-2"></i>Learning Progress Analysis Complete!
                                </h6>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>Time Period:</strong><br>
                                    <span class="text-primary">${data.time_period || timePeriod.replace('_', ' ')}</span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Learning Velocity:</strong><br>
                                    <span class="text-success">${data.learning_velocity || 75}%</span>
                                </div>
                            </div>
                    `;

                    // Learning Style Evolution
                    if (data.learning_style_evolution && typeof data.learning_style_evolution === 'object') {
                        html += `
                            <div class="result-section" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #17a2b8;">
                                <h6 style="color: #17a2b8; font-weight: 600; margin-bottom: 10px;">
                                    <i class="fas fa-sync-alt me-2"></i>Learning Style Evolution
                                </h6>
                                <p class="mb-0">Your learning style preferences have been adapting over time based on your performance.</p>
                            </div>
                        `;
                    }

                    // Performance Trends
                    if (data.performance_trends && Array.isArray(data.performance_trends) && data.performance_trends.length > 0) {
                        html += `
                            <div class="result-section" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #28a745;">
                                <h6 style="color: #28a745; font-weight: 600; margin-bottom: 10px;">
                                    <i class="fas fa-trending-up me-2"></i>Performance Trends
                                </h6>
                                <ul class="list-unstyled mb-0">
                        `;
                        data.performance_trends.forEach(trend => {
                            const trendText = typeof trend === 'string' ? trend : (trend.description || trend.name || 'Performance improving');
                            html += `<li class="mb-2"><i class="fas fa-arrow-up text-success me-2"></i>${trendText}</li>`;
                        });
                        html += '</ul></div>';
                    }

                    // Improvement Areas
                    if (data.improvement_areas && Array.isArray(data.improvement_areas) && data.improvement_areas.length > 0) {
                        html += `
                            <div class="result-section" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #ffc107;">
                                <h6 style="color: #ffc107; font-weight: 600; margin-bottom: 10px;">
                                    <i class="fas fa-exclamation-triangle me-2"></i>Areas for Improvement
                                </h6>
                                <ul class="list-unstyled mb-0">
                        `;
                        data.improvement_areas.forEach(area => {
                            const areaText = typeof area === 'string' ? area : (area.description || area.name || 'Focus area');
                            html += `<li class="mb-2"><i class="fas fa-circle text-warning me-2"></i>${areaText}</li>`;
                        });
                        html += '</ul></div>';
                    }

                    // Recommendations
                    if (data.recommendations && Array.isArray(data.recommendations) && data.recommendations.length > 0) {
                        html += `
                            <div class="result-section" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #0d6efd;">
                                <h6 style="color: #0d6efd; font-weight: 600; margin-bottom: 10px;">
                                    <i class="fas fa-lightbulb me-2"></i>Recommendations
                                </h6>
                                <ul class="list-unstyled mb-0">
                        `;
                        data.recommendations.forEach(rec => {
                            html += `<li class="mb-2"><i class="fas fa-star text-primary me-2"></i>${rec}</li>`;
                        });
                        html += '</ul></div>';
                    }

                    html += '</div>';
                    resultDiv.innerHTML = html;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                resultDiv.innerHTML = '<div class="alert alert-danger">Error analyzing learning progress</div>';
            });
    }

    function generateLearningInsights() {
        alert('Learning insights generation feature coming soon!');
    }

    function personalizeContent() {
        alert('Content personalization feature coming soon!');
    }

    function viewPersonalizationCenter() {
        window.location.href = '/learning-style/personalization-center';
    }
</script>

<style>
    /* Assessment Option Cards */
    .option-card {
        background: white;
        border: 2px solid #dee2e6 !important;
        transition: all 0.3s ease;
    }

    .option-card:hover {
        background: #f8f9fa;
        border-color: #0d6efd !important;
        transform: translateX(5px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .option-card .badge {
        min-width: 35px;
        height: 35px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        font-weight: 600;
    }

    .option-card label {
        font-size: 15px;
        margin-bottom: 0;
    }

    .option-card input[type="radio"] {
        width: 20px;
        height: 20px;
        margin-right: 10px;
    }

    /* Result Cards */
    .result-card {
        animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .result-section {
        animation: slideIn 0.5s ease-out;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(-10px);
        }

        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
</style>
{% endblock %}