{% extends "base.html" %}

{% block title %}Learning Style Detection - Learning Companion{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        
        <div class="col-12">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-gradient-info text-white">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-brain fa-2x me-3"></i>
                        <div>
                            <h2 class="h4 mb-0">Learning Style Detection & Personalization</h2>
                            <p class="mb-0 opacity-75">Advanced AI-powered learning style analysis and adaptive learning
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        
        <div class="col-lg-8">
            
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-clipboard-check text-primary me-2"></i>
                        Learning Style Assessment
                    </h5>
                </div>
                <div class="card-body">
                    <div id="assessmentContainer">
                        <div class="text-center py-4">
                            <i class="fas fa-user-graduate fa-3x text-muted mb-3"></i>
                            <h5>Discover Your Learning Style</h5>
                            <p class="text-muted">Take our comprehensive assessment to understand how you learn best</p>
                            <button class="btn btn-primary btn-lg" onclick="startLearningStyleAssessment()">
                                <i class="fas fa-play me-2"></i>Start Assessment
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-route text-success me-2"></i>
                        Adaptive Learning Path Generator
                    </h5>
                </div>
                <div class="card-body">
                    <form id="adaptiveLearningPathForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Subject</label>
                                    <select class="form-select" id="pathSubject" required>
                                        <option value="">Choose a subject...</option>
                                        
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Current Level</label>
                                    <select class="form-select" id="pathCurrentLevel" required>
                                        <option value="beginner">Beginner</option>
                                        <option value="intermediate">Intermediate</option>
                                        <option value="advanced">Advanced</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Target Level</label>
                                    <select class="form-select" id="pathTargetLevel" required>
                                        <option value="intermediate">Intermediate</option>
                                        <option value="advanced">Advanced</option>
                                        <option value="expert">Expert</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Learning Style</label>
                                    <select class="form-select" id="pathLearningStyle" required>
                                        <option value="visual">Visual</option>
                                        <option value="auditory">Auditory</option>
                                        <option value="kinesthetic">Kinesthetic</option>
                                        <option value="reading_writing">Reading/Writing</option>
                                        <option value="multimodal">Multimodal</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-success" onclick="createAdaptiveLearningPath()">
                            <i class="fas fa-magic me-2"></i>Generate Learning Path
                        </button>
                    </form>

                    <div id="adaptiveLearningPathResult" class="mt-3" style="display: none;">
                        
                    </div>
                </div>
            </div>

            
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-calendar-alt text-warning me-2"></i>
                        Intelligent Study Schedule
                    </h5>
                </div>
                <div class="card-body">
                    <form id="studyScheduleForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Learning Style</label>
                                    <select class="form-select" id="scheduleLearningStyle" required>
                                        <option value="visual">Visual</option>
                                        <option value="auditory">Auditory</option>
                                        <option value="kinesthetic">Kinesthetic</option>
                                        <option value="reading_writing">Reading/Writing</option>
                                        <option value="multimodal">Multimodal</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Available Time (hours per day)</label>
                                    <input type="number" class="form-control" id="availableTime" value="3" min="1"
                                        max="12">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-book me-2"></i>Subjects to Study & Learning Styles
                                <small class="text-muted">(Select subjects and choose learning style for each)</small>
                            </label>
                            <div class="row g-3">
                                
                                <div class="col-md-4">
                                    <input class="form-check-input d-none subject-checkbox" type="checkbox"
                                        id="subjectMath" value="Mathematics" onchange="toggleSubjectStyle('Math')">
                                    <label class="subject-card" for="subjectMath"
                                        style="cursor: pointer; display: block; padding: 15px; border: 2px solid #dee2e6; border-radius: 8px; text-align: center; transition: all 0.3s ease; background: white;">
                                        <div style="font-size: 32px; margin-bottom: 8px;">üìê</div>
                                        <h6 class="mb-0" style="font-weight: 600; color: #212529;">Mathematics</h6>
                                        <small class="text-muted">Numbers & Logic</small>
                                    </label>
                                    <div id="mathStyleSelect" class="mt-2" style="display: none;">
                                        <select class="form-select form-select-sm" id="mathLearningStyle">
                                            <option value="visual">üìä Visual</option>
                                            <option value="auditory">üéß Auditory</option>
                                            <option value="kinesthetic">ü§∏ Kinesthetic</option>
                                            <option value="reading">üìñ Reading/Writing</option>
                                        </select>
                                    </div>
                                </div>

                                
                                <div class="col-md-4">
                                    <input class="form-check-input d-none subject-checkbox" type="checkbox"
                                        id="subjectEnglish" value="English" onchange="toggleSubjectStyle('English')">
                                    <label class="subject-card" for="subjectEnglish"
                                        style="cursor: pointer; display: block; padding: 15px; border: 2px solid #dee2e6; border-radius: 8px; text-align: center; transition: all 0.3s ease; background: white;">
                                        <div style="font-size: 32px; margin-bottom: 8px;">üìö</div>
                                        <h6 class="mb-0" style="font-weight: 600; color: #212529;">English</h6>
                                        <small class="text-muted">Language & Literature</small>
                                    </label>
                                    <div id="englishStyleSelect" class="mt-2" style="display: none;">
                                        <select class="form-select form-select-sm" id="englishLearningStyle">
                                            <option value="visual">üìä Visual</option>
                                            <option value="auditory">üéß Auditory</option>
                                            <option value="kinesthetic">ü§∏ Kinesthetic</option>
                                            <option value="reading">üìñ Reading/Writing</option>
                                        </select>
                                    </div>
                                </div>

                                
                                <div class="col-md-4">
                                    <input class="form-check-input d-none subject-checkbox" type="checkbox"
                                        id="subjectScience" value="Science" onchange="toggleSubjectStyle('Science')">
                                    <label class="subject-card" for="subjectScience"
                                        style="cursor: pointer; display: block; padding: 15px; border: 2px solid #dee2e6; border-radius: 8px; text-align: center; transition: all 0.3s ease; background: white;">
                                        <div style="font-size: 32px; margin-bottom: 8px;">üî¨</div>
                                        <h6 class="mb-0" style="font-weight: 600; color: #212529;">Science</h6>
                                        <small class="text-muted">Biology, Chemistry, Physics</small>
                                    </label>
                                    <div id="scienceStyleSelect" class="mt-2" style="display: none;">
                                        <select class="form-select form-select-sm" id="scienceLearningStyle">
                                            <option value="visual">üìä Visual</option>
                                            <option value="auditory">üéß Auditory</option>
                                            <option value="kinesthetic">ü§∏ Kinesthetic</option>
                                            <option value="reading">üìñ Reading/Writing</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-warning" onclick="createIntelligentStudySchedule()">
                            <i class="fas fa-clock me-2"></i>Create Study Schedule
                        </button>
                    </form>

                    <div id="studyScheduleResult" class="mt-3" style="display: none;">
                        
                    </div>
                </div>
            </div>

            
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line text-info me-2"></i>
                        Learning Progress Analysis
                    </h5>
                </div>
                <div class="card-body">
                    <form id="progressAnalysisForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Analysis Period</label>
                                    <select class="form-select" id="analysisPeriod">
                                        <option value="7_days">Last 7 Days</option>
                                        <option value="30_days" selected>Last 30 Days</option>
                                        <option value="90_days">Last 90 Days</option>
                                        <option value="all_time">All Time</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Analysis Depth</label>
                                    <select class="form-select" id="analysisDepth">
                                        <option value="basic">Basic</option>
                                        <option value="comprehensive" selected>Comprehensive</option>
                                        <option value="detailed">Detailed</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-info" onclick="analyzeLearningProgress()">
                            <i class="fas fa-search me-2"></i>Analyze Progress
                        </button>
                    </form>

                    <div id="progressAnalysisResult" class="mt-3" style="display: none;">
                        
                    </div>
                </div>
            </div>
        </div>

        
        <div class="col-lg-4">
            
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-gradient-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>Learning Styles
                    </h5>
                </div>
                <div class="card-body">
                    <div id="learningStylesInfo">
                        <div class="text-center py-3">
                            <i class="fas fa-spinner fa-spin fa-2x text-muted mb-3"></i>
                            <p class="text-muted">Loading learning styles...</p>
                        </div>
                    </div>
                </div>
            </div>

            
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-bolt me-2"></i>Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        <a href="#" class="list-group-item list-group-item-action" onclick="generateLearningInsights()">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-lightbulb text-warning me-3"></i>
                                <div>
                                    <h6 class="mb-1">Generate Insights</h6>
                                    <small class="text-muted">AI-powered learning insights</small>
                                </div>
                            </div>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action" onclick="personalizeContent()">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-user-cog text-info me-3"></i>
                                <div>
                                    <h6 class="mb-1">Personalize Content</h6>
                                    <small class="text-muted">Adapt content to your style</small>
                                </div>
                            </div>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action"
                            onclick="viewPersonalizationCenter()">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-cogs text-success me-3"></i>
                                <div>
                                    <h6 class="mb-1">Personalization Center</h6>
                                    <small class="text-muted">Advanced personalization</small>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>

            
            <div class="card border-0 shadow-sm" id="learningTipsCard"
                style="border-left: 4px solid #6f42c1 !important;">
                <div class="card-header"
                    style="background: linear-gradient(135deg, #6f42c115 0%, #6f42c105 100%); border-bottom: 2px solid #6f42c1;">
                    <h5 class="card-title mb-0 fw-bold" style="color: #6f42c1;">
                        <i class="fas fa-lightbulb me-2"></i>Learning Tips
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-primary border-0 mb-3" style="border-left: 4px solid #0d6efd !important;">
                        <h6 class="fw-bold mb-2">
                            <i class="fas fa-eye text-primary me-2"></i>Visual Learners:
                        </h6>
                        <p class="mb-0">Use mind maps, diagrams, and color coding to organize information effectively.
                        </p>
                    </div>
                    <div class="alert alert-success border-0 mb-3" style="border-left: 4px solid #28a745 !important;">
                        <h6 class="fw-bold mb-2">
                            <i class="fas fa-headphones text-success me-2"></i>Auditory Learners:
                        </h6>
                        <p class="mb-0">Record yourself explaining concepts and listen to educational podcasts.</p>
                    </div>
                    <div class="alert alert-warning border-0 mb-3" style="border-left: 4px solid #ffc107 !important;">
                        <h6 class="fw-bold mb-2">
                            <i class="fas fa-hands text-warning me-2"></i>Kinesthetic Learners:
                        </h6>
                        <p class="mb-0">Take frequent breaks and use hands-on activities to reinforce learning.</p>
                    </div>
                    <div class="alert alert-info border-0 mb-0" style="border-left: 4px solid #17a2b8 !important;">
                        <h6 class="fw-bold mb-2">
                            <i class="fas fa-book-open text-info me-2"></i>Reading/Writing Learners:
                        </h6>
                        <p class="mb-0">Take detailed notes and create written summaries to solidify understanding.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="assessmentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Learning Style Assessment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="assessmentContent">
                    
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="submitAssessment()" id="submitAssessmentBtn"
                    disabled>Submit Assessment</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Subject Card Styling */
    .subject-card {
        position: relative;
        overflow: hidden;
    }

    .subject-card:hover {
        border-color: #ffc107 !important;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 193, 7, 0.2);
    }

    .subject-checkbox:checked+.subject-card {
        border-color: #ffc107 !important;
        background: linear-gradient(135deg, #fff9e6 0%, #fffcf0 100%) !important;
        box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
    }

    .subject-checkbox:checked+.subject-card::before {
        content: '‚úì';
        position: absolute;
        top: 8px;
        right: 8px;
        width: 28px;
        height: 28px;
        background: #ffc107;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 16px;
    }

    .subject-card h6 {
        transition: color 0.3s ease;
    }

    .subject-checkbox:checked+.subject-card h6 {
        color: #ffc107 !important;
    }

    /* Ensure Learning Tips Stay Visible - ULTRA AGGRESSIVE */
    #learningTipsCard {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: relative !important;
        z-index: 999999 !important;
        min-height: 400px !important;
        height: auto !important;
        overflow: visible !important;
        pointer-events: auto !important;
        background-color: white !important;
        transform: none !important;
        filter: none !important;
        clip-path: none !important;
        mask: none !important;
    }

    #learningTipsCard .card-body {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        min-height: 300px !important;
        height: auto !important;
        overflow: visible !important;
        padding: 1rem !important;
        background-color: white !important;
        transform: none !important;
        filter: none !important;
        clip-path: none !important;
        mask: none !important;
    }

    #learningTipsCard .alert {
        display: block !important;
        opacity: 1 !important;
        visibility: visible !important;
        position: relative !important;
        z-index: 1000000 !important;
        margin-bottom: 12px !important;
        min-height: 60px !important;
        height: auto !important;
        padding: 0.75rem !important;
        background-color: inherit !important;
        border: 1px solid #dee2e6 !important;
        border-radius: 0.375rem !important;
        transform: none !important;
        filter: none !important;
        clip-path: none !important;
        mask: none !important;
        transition: none !important;
        animation: none !important;
    }

    /* Override any possible hiding mechanisms */
    #learningTipsCard .alert.d-none,
    #learningTipsCard .alert.invisible,
    #learningTipsCard .alert[style*="display: none"],
    #learningTipsCard .alert[style*="visibility: hidden"],
    #learningTipsCard .alert[style*="opacity: 0"] {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }

    /* Force visibility even if parent is hidden */
    #learningTipsCard .card-body.d-none,
    #learningTipsCard .card-body.invisible,
    #learningTipsCard .card-body[style*="display: none"],
    #learningTipsCard .card-body[style*="visibility: hidden"],
    #learningTipsCard .card-body[style*="opacity: 0"] {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }

    #learningTipsCard .alert-primary {
        background-color: #cfe2ff !important;
        border-color: #0d6efd !important;
        color: #084298 !important;
    }

    #learningTipsCard .alert-success {
        background-color: #d1e7dd !important;
        border-color: #28a745 !important;
        color: #0f5132 !important;
    }

    #learningTipsCard .alert-warning {
        background-color: #fff3cd !important;
        border-color: #ffc107 !important;
        color: #664d03 !important;
    }

    #learningTipsCard .alert-info {
        background-color: #d1ecf1 !important;
        border-color: #17a2b8 !important;
        color: #055160 !important;
    }

    #learningTipsCard .card-header {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        background-color: #f8f9fa !important;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    let currentQuestionIndex = 0;
    let assessmentQuestions = [];
    let assessmentAnswers = [];

    // Load data on page load
    document.addEventListener('DOMContentLoaded', function () {
        loadLearningStyles();
        loadSubjects();

        // Ensure Learning Tips stay visible
        ensureLearningTipsVisible();
    });

    // Also run on window load to catch late-loading scripts
    window.addEventListener('load', function () {
        console.log('üîÑ Window loaded - ensuring Learning Tips visible...');
        setTimeout(ensureLearningTipsVisible, 500);
        setTimeout(ensureLearningTipsVisible, 1500);
        setTimeout(ensureLearningTipsVisible, 3000);
    });

    // Run on any page visibility change
    document.addEventListener('visibilitychange', function () {
        if (!document.hidden) {
            console.log('üîÑ Page visible again - ensuring Learning Tips visible...');
            setTimeout(ensureLearningTipsVisible, 100);
        }
    });

    function ensureLearningTipsVisible() {
        const tipsCard = document.getElementById('learningTipsCard');
        if (tipsCard) {
            // Force visibility aggressively
            tipsCard.style.display = 'block';
            tipsCard.style.visibility = 'visible';
            tipsCard.style.opacity = '1';
            tipsCard.style.position = 'relative';
            tipsCard.style.zIndex = '1';
            tipsCard.style.minHeight = '400px';

            // Debug info
            const rect = tipsCard.getBoundingClientRect();
            console.log('‚úÖ Learning Tips card is visible');
            console.log('   Position:', { top: rect.top, left: rect.left, width: rect.width, height: rect.height });
            console.log('   In viewport:', rect.top >= 0 && rect.top <= window.innerHeight);

            // Force all child elements visible
            const cardBody = tipsCard.querySelector('.card-body');
            if (cardBody) {
                cardBody.style.display = 'block';
                cardBody.style.visibility = 'visible';
                cardBody.style.opacity = '1';
                cardBody.style.height = 'auto';
                cardBody.style.minHeight = '300px';
                cardBody.style.padding = '1rem';
                cardBody.style.backgroundColor = 'white';
                console.log('‚úÖ Card body forced visible');
            }

            const alerts = tipsCard.querySelectorAll('.alert');
            console.log(`   Found ${alerts.length} alert elements`);
            alerts.forEach((alert, idx) => {
                // Remove any conflicting classes first
                alert.classList.remove('d-none', 'invisible', 'opacity-0');

                // Force visibility with specific styling
                alert.style.display = 'block';
                alert.style.visibility = 'visible';
                alert.style.opacity = '1';
                alert.style.position = 'relative';
                alert.style.zIndex = '1000';
                alert.style.minHeight = '60px';
                alert.style.height = 'auto';
                alert.style.marginBottom = '12px';
                alert.style.padding = '0.75rem';
                alert.style.borderRadius = '0.375rem';
                alert.style.border = '1px solid #dee2e6';

                // Apply specific colors based on alert type
                if (alert.classList.contains('alert-primary')) {
                    alert.style.backgroundColor = '#cfe2ff';
                    alert.style.borderColor = '#0d6efd';
                    alert.style.color = '#084298';
                } else if (alert.classList.contains('alert-success')) {
                    alert.style.backgroundColor = '#d1e7dd';
                    alert.style.borderColor = '#28a745';
                    alert.style.color = '#0f5132';
                } else if (alert.classList.contains('alert-warning')) {
                    alert.style.backgroundColor = '#fff3cd';
                    alert.style.borderColor = '#ffc107';
                    alert.style.color = '#664d03';
                } else if (alert.classList.contains('alert-info')) {
                    alert.style.backgroundColor = '#d1ecf1';
                    alert.style.borderColor = '#17a2b8';
                    alert.style.color = '#055160';
                }

                const alertRect = alert.getBoundingClientRect();
                const computedStyle = window.getComputedStyle(alert);
                console.log(`   Alert ${idx + 1}: ${alertRect.height}px tall, visible=${alertRect.height > 0}, display=${computedStyle.display}`);
            });
            console.log(`   ‚úì All alerts processed with forced styling`);

            // MutationObserver to watch for changes to alerts
            const observer = new MutationObserver(function (mutations) {
                mutations.forEach(function (mutation) {
                    if (mutation.type === 'attributes' && (mutation.attributeName === 'style' || mutation.attributeName === 'class')) {
                        const target = mutation.target;
                        if (target.classList && target.classList.contains('alert')) {
                            console.warn('üîÑ Alert style changed - restoring visibility...');
                            target.style.display = 'block';
                            target.style.visibility = 'visible';
                            target.style.opacity = '1';
                        }
                    }
                });
            });

            // Start observing all alerts
            alerts.forEach(alert => {
                observer.observe(alert, {
                    attributes: true,
                    attributeFilter: ['style', 'class']
                });
            });

            // MULTIPLE monitoring intervals to catch different timing issues
            // Ultra-fast monitoring for immediate issues
            setInterval(function () {
                recreateLearningTipsContent();
            }, 50); // Every 50ms

            // Fast monitoring for immediate issues
            setInterval(function () {
                forceLearningTipsVisible();
            }, 100); // Every 100ms

            // Medium monitoring for general issues  
            setInterval(function () {
                forceLearningTipsVisible();
            }, 500); // Every 500ms

            // Slow monitoring for late-loading scripts
            setInterval(function () {
                forceLearningTipsVisible();
            }, 2000); // Every 2 seconds

            // Delayed execution to catch scripts that load after page
            setTimeout(recreateLearningTipsContent, 500);
            setTimeout(forceLearningTipsVisible, 1000);
            setTimeout(recreateLearningTipsContent, 2000);
            setTimeout(forceLearningTipsVisible, 3000);
            setTimeout(recreateLearningTipsContent, 4000);
            setTimeout(forceLearningTipsVisible, 5000);
            setTimeout(recreateLearningTipsContent, 8000);
            setTimeout(forceLearningTipsVisible, 10000);

            function recreateLearningTipsContent() {
                const card = document.getElementById('learningTipsCard');
                if (!card) return;

                const cardBody = card.querySelector('.card-body');
                if (!cardBody) return;

                // Check if alerts are missing or hidden
                const currentAlerts = cardBody.querySelectorAll('.alert');
                let needsRecreation = false;

                if (currentAlerts.length === 0) {
                    needsRecreation = true;
                } else {
                    // Check if any alerts are hidden
                    currentAlerts.forEach(alert => {
                        const style = window.getComputedStyle(alert);
                        if (style.display === 'none' || style.visibility === 'hidden' || parseFloat(style.opacity) < 1) {
                            needsRecreation = true;
                        }
                    });
                }

                if (needsRecreation) {
                    console.warn('üîÑ Learning Tips content missing/hidden - RECREATING...');

                    // Completely recreate the card body content
                    cardBody.innerHTML = `
                        <div class="alert alert-primary border-0 mb-3" style="border-left: 4px solid #0d6efd !important; display: block !important; visibility: visible !important; opacity: 1 !important; position: relative !important; z-index: 1000000 !important; min-height: 60px !important; height: auto !important; margin-bottom: 12px !important; padding: 0.75rem !important; background-color: #cfe2ff !important; border-color: #0d6efd !important; color: #084298 !important; border-radius: 0.375rem !important;">
                            <h6 class="fw-bold mb-2">
                                <i class="fas fa-eye text-primary me-2"></i>Visual Learners:
                            </h6>
                            <p class="mb-0">Use mind maps, diagrams, and color coding to organize information effectively.</p>
                        </div>
                        <div class="alert alert-success border-0 mb-3" style="border-left: 4px solid #28a745 !important; display: block !important; visibility: visible !important; opacity: 1 !important; position: relative !important; z-index: 1000000 !important; min-height: 60px !important; height: auto !important; margin-bottom: 12px !important; padding: 0.75rem !important; background-color: #d1e7dd !important; border-color: #28a745 !important; color: #0f5132 !important; border-radius: 0.375rem !important;">
                            <h6 class="fw-bold mb-2">
                                <i class="fas fa-headphones text-success me-2"></i>Auditory Learners:
                            </h6>
                            <p class="mb-0">Record yourself explaining concepts and listen to educational podcasts.</p>
                        </div>
                        <div class="alert alert-warning border-0 mb-3" style="border-left: 4px solid #ffc107 !important; display: block !important; visibility: visible !important; opacity: 1 !important; position: relative !important; z-index: 1000000 !important; min-height: 60px !important; height: auto !important; margin-bottom: 12px !important; padding: 0.75rem !important; background-color: #fff3cd !important; border-color: #ffc107 !important; color: #664d03 !important; border-radius: 0.375rem !important;">
                            <h6 class="fw-bold mb-2">
                                <i class="fas fa-hands text-warning me-2"></i>Kinesthetic Learners:
                            </h6>
                            <p class="mb-0">Take frequent breaks and use hands-on activities to reinforce learning.</p>
                        </div>
                        <div class="alert alert-info border-0 mb-0" style="border-left: 4px solid #17a2b8 !important; display: block !important; visibility: visible !important; opacity: 1 !important; position: relative !important; z-index: 1000000 !important; min-height: 60px !important; height: auto !important; margin-bottom: 0 !important; padding: 0.75rem !important; background-color: #d1ecf1 !important; border-color: #17a2b8 !important; color: #055160 !important; border-radius: 0.375rem !important;">
                            <h6 class="fw-bold mb-2">
                                <i class="fas fa-book-open text-info me-2"></i>Reading/Writing Learners:
                            </h6>
                            <p class="mb-0">Take detailed notes and create written summaries to solidify understanding.</p>
                        </div>
                    `;

                    console.log('‚úÖ Learning Tips content recreated successfully!');
                }
            }

            function forceLearningTipsVisible() {
                const card = document.getElementById('learningTipsCard');
                if (!card) return;

                // Force card visibility
                const computedStyle = window.getComputedStyle(card);
                if (computedStyle.display === 'none' || computedStyle.visibility === 'hidden' || parseFloat(computedStyle.opacity) < 1) {
                    console.warn('üîÑ Learning Tips card visibility lost - restoring...');
                    card.style.display = 'block';
                    card.style.visibility = 'visible';
                    card.style.opacity = '1';
                    card.style.zIndex = '999999';
                }

                // Force card-body visibility
                const cardBody = card.querySelector('.card-body');
                if (cardBody) {
                    const bodyStyle = window.getComputedStyle(cardBody);
                    if (bodyStyle.display === 'none' || bodyStyle.visibility === 'hidden' || parseFloat(bodyStyle.opacity) < 1) {
                        console.warn('üîÑ Card body visibility lost - restoring...');
                        cardBody.style.display = 'block';
                        cardBody.style.visibility = 'visible';
                        cardBody.style.opacity = '1';
                        cardBody.style.height = 'auto';
                        cardBody.style.minHeight = '300px';
                        cardBody.style.padding = '1rem';
                        cardBody.style.backgroundColor = 'white';
                    }
                }

                // Try to recreate content if needed
                recreateLearningTipsContent();
            }

        } else {
            console.error('‚ùå Learning Tips card not found in DOM!');
        }
    }

    function loadSubjects() {
        fetch('/gcse-ai/api/subjects')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error loading subjects:', data.error);
                    return;
                }

                // Populate subject dropdown
                const subjectSelect = document.getElementById('pathSubject');
                if (subjectSelect) {
                    subjectSelect.innerHTML = '<option value="">Choose a subject...</option>';
                    data.subjects.forEach(subject => {
                        const option = document.createElement('option');
                        option.value = subject.name;
                        option.textContent = subject.name;
                        subjectSelect.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading subjects:', error);
            });
    }

    function loadLearningStyles() {
        fetch('/learning-style/api/learning-styles')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error loading learning styles:', data.error);
                    return;
                }

                displayLearningStyles(data.learning_styles);
            })
            .catch(error => {
                console.error('Error loading learning styles:', error);
            });
    }

    function displayLearningStyles(learningStyles) {
        const container = document.getElementById('learningStylesInfo');
        let html = '';

        learningStyles.forEach(style => {
            html += `
                <div class="mb-3">
                    <h6 class="text-primary">${style.name}</h6>
                    <p class="small text-muted mb-2">${style.description}</p>
                    <div class="small">
                        <strong>Key Characteristics:</strong>
                        <ul class="mb-0">
                            ${style.characteristics.map(char => `<li>${char}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    function startLearningStyleAssessment() {
        fetch('/learning-style/api/learning-style-assessment')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error loading assessment:', data.error);
                    return;
                }

                assessmentQuestions = data.assessment_questions;
                currentQuestionIndex = 0;
                assessmentAnswers = [];

                showAssessmentQuestion();

                const modal = new bootstrap.Modal(document.getElementById('assessmentModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error loading assessment:', error);
            });
    }

    function showAssessmentQuestion() {
        const container = document.getElementById('assessmentContent');
        const question = assessmentQuestions[currentQuestionIndex];
        const isLastQuestion = currentQuestionIndex === assessmentQuestions.length - 1;

        let html = `
            <div class="assessment-question">
                <div class="mb-3">
                    <small class="text-muted">Question ${currentQuestionIndex + 1} of ${assessmentQuestions.length}</small>
                    <div class="progress mt-2" style="height: 6px;">
                        <div class="progress-bar bg-success" style="width: ${((currentQuestionIndex + 1) / assessmentQuestions.length) * 100}%"></div>
                    </div>
                </div>
                
                <h5 class="mb-4">${question.question}</h5>
                
                <div class="options-group mb-4">
        `;

        question.options.forEach((option, idx) => {
            const optionLetter = String.fromCharCode(65 + idx); // A, B, C, D
            html += `
                <div class="option-card mb-3 p-3 border rounded" style="cursor: pointer; transition: all 0.3s ease;" 
                     onclick="selectAnswerAndProceed('${option.style}', this)">
                    <div class="form-check">
                    <input class="form-check-input" type="radio" name="question_${question.id}" 
                               id="option_${option.id}" value="${option.style}" style="cursor: pointer;">
                        <label class="form-check-label d-flex align-items-center" for="option_${option.id}" style="cursor: pointer; width: 100%;">
                            <span class="badge bg-primary me-3">${optionLetter}</span>
                            <span>${option.text}</span>
                    </label>
                    </div>
                </div>
            `;
        });

        html += `
                </div>
                
                <div class="d-flex justify-content-between mt-4">
                    <button class="btn btn-outline-secondary" onclick="previousQuestion()" ${currentQuestionIndex === 0 ? 'disabled' : ''}>
                        <i class="fas fa-arrow-left me-2"></i>Previous
                    </button>
                    <button class="btn btn-success" id="nextQuestionBtn" onclick="nextQuestion()" disabled>
                        ${isLastQuestion ? '<i class="fas fa-check me-2"></i>Finish' : '<i class="fas fa-arrow-right me-2"></i>Next'}
                    </button>
                </div>
            </div>
        `;

        container.innerHTML = html;

        // Check if this question was already answered
        if (assessmentAnswers[currentQuestionIndex]) {
            document.getElementById('nextQuestionBtn').disabled = false;
        }
    }

    function selectAnswerAndProceed(style, optionCard) {
        // Save answer
        assessmentAnswers[currentQuestionIndex] = {
            question_id: assessmentQuestions[currentQuestionIndex].id,
            style: style
        };

        // Visual feedback - highlight selected option
        document.querySelectorAll('.option-card').forEach(card => {
            card.style.background = 'white';
            card.style.borderColor = '#dee2e6';
        });
        optionCard.style.background = '#e7f3ff';
        optionCard.style.borderColor = '#0d6efd';

        // Check the radio button
        const radioInput = optionCard.querySelector('input[type="radio"]');
        if (radioInput) {
            radioInput.checked = true;
        }

        // Enable next button
        const nextBtn = document.getElementById('nextQuestionBtn');
        if (nextBtn) {
            nextBtn.disabled = false;
        }

        // Enable submit button if this is last question
        const isLastQuestion = currentQuestionIndex === assessmentQuestions.length - 1;
        if (isLastQuestion) {
            document.getElementById('submitAssessmentBtn').disabled = false;
        }
    }

    function nextQuestion() {
        if (currentQuestionIndex < assessmentQuestions.length - 1) {
            currentQuestionIndex++;
            showAssessmentQuestion();
        } else {
            // Last question - enable submit
            document.getElementById('submitAssessmentBtn').disabled = false;
        }
    }

    function previousQuestion() {
        if (currentQuestionIndex > 0) {
            currentQuestionIndex--;
            showAssessmentQuestion();
        }
    }

    function selectAnswer(style) {
        // Keep for backward compatibility
        assessmentAnswers[currentQuestionIndex] = {
            question_id: assessmentQuestions[currentQuestionIndex].id,
            style: style
        };

        // Enable submit button if all questions answered
        if (assessmentAnswers.length === assessmentQuestions.length &&
            assessmentAnswers.every(answer => answer !== undefined)) {
            document.getElementById('submitAssessmentBtn').disabled = false;
        }
    }

    function submitAssessment() {
        const submitBtn = document.getElementById('submitAssessmentBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';

        fetch('/learning-style/api/submit-assessment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                answers: assessmentAnswers
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error submitting assessment:', data.error);
                    alert('Error submitting assessment: ' + data.error);
                    // Re-enable button on error
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'Submit Assessment';
                    return;
                }

                // Show results
                showAssessmentResults(data.assessment_results);

                // Keep button disabled and change text to show completion
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i>Assessment Completed';
                submitBtn.classList.remove('btn-primary');
                submitBtn.classList.add('btn-success');
            })
            .catch(error => {
                console.error('Error submitting assessment:', error);
                alert('Error submitting assessment');
                // Re-enable button on error
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Submit Assessment';
            });
    }

    function showAssessmentResults(results) {
        const container = document.getElementById('assessmentContent');
        const analysis = results.analysis;

        let html = `
            <div class="text-center mb-4">
                <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                <h5>Assessment Complete!</h5>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">Your Primary Learning Style</h6>
                            <h4 class="text-primary">${results.primary_learning_style.toUpperCase()}</h4>
                            <p class="card-text">${analysis.recommendations[0] || 'Great choice!'}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">Style Scores</h6>
                            ${Object.entries(results.style_scores).map(([style, score]) => `
                                <div class="d-flex justify-content-between mb-1">
                                    <span>${style.charAt(0).toUpperCase() + style.slice(1)}:</span>
                                    <span>${score}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-4">
                <h6>Personalized Recommendations:</h6>
                <ul>
                    ${analysis.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                </ul>
            </div>
        `;

        container.innerHTML = html;

        // Hide the submit button and show "Close" or "Start New" button
        const submitBtn = document.getElementById('submitAssessmentBtn');
        if (submitBtn) {
            submitBtn.style.display = 'none';
        }

        // Update modal footer to show completion options
        const modalFooter = submitBtn.closest('.modal-footer');
        if (modalFooter) {
            // Find close button
            const closeBtn = modalFooter.querySelector('[data-bs-dismiss="modal"]');
            if (closeBtn) {
                closeBtn.innerHTML = '<i class="fas fa-check me-2"></i>Done';
                closeBtn.classList.remove('btn-secondary');
                closeBtn.classList.add('btn-success');
            }
        }
    }

    function createAdaptiveLearningPath() {
        const subject = document.getElementById('pathSubject').value;
        const currentLevel = document.getElementById('pathCurrentLevel').value;
        const targetLevel = document.getElementById('pathTargetLevel').value;
        const learningStyle = document.getElementById('pathLearningStyle').value;

        if (!subject) {
            alert('Please select a subject');
            return;
        }

        const resultDiv = document.getElementById('adaptiveLearningPathResult');
        resultDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin me-2"></i>Creating adaptive learning path...</div>';
        resultDiv.style.display = 'block';

        fetch('/learning-style/api/create-adaptive-learning-path', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                subject: subject,
                current_level: currentLevel,
                target_level: targetLevel,
                learning_style: learningStyle
            })
        })
            .then(response => response.json())
            .then(data => {
                console.log('Adaptive Learning Path Data:', data);

                if (data.error) {
                    resultDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i>${data.error}</div>`;
                } else {
                    let html = `
                        <div class="result-card" style="background: white; border-radius: 12px; padding: 20px; border: 2px solid #e9ecef;">
                            <div class="result-header" style="border-bottom: 2px solid #28a745; padding-bottom: 12px; margin-bottom: 15px;">
                                <h6 style="color: #28a745; font-weight: 700; font-size: 18px;">
                                    <i class="fas fa-route me-2"></i>Adaptive Learning Path Created!
                                </h6>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <strong>Subject:</strong><br>
                                    <span class="text-primary">${data.subject}</span>
                                </div>
                                <div class="col-md-4">
                                    <strong>Learning Style:</strong><br>
                                    <span class="text-info">${data.learning_style}</span>
                                </div>
                                <div class="col-md-4">
                                    <strong>Completion Time:</strong><br>
                                    <span class="text-success">${data.estimated_completion_time || 'Varies'}</span>
                                </div>
                    </div>
                `;

                    // Learning Modules
                    if (data.learning_modules && Array.isArray(data.learning_modules) && data.learning_modules.length > 0) {
                        html += `
                            <div class="result-section" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #28a745;">
                                <h6 style="color: #28a745; font-weight: 600; margin-bottom: 15px;">
                                    <i class="fas fa-book me-2"></i>Learning Modules
                                </h6>
                        `;
                        data.learning_modules.forEach((module, idx) => {
                            const moduleName = typeof module === 'string' ? module : (module.name || module.title || `Module ${idx + 1}`);
                            const moduleDesc = typeof module === 'object' ? (module.description || '') : '';

                            html += `
                                <div class="module-card mb-3 p-3 bg-white border rounded" style="border-left: 4px solid #28a745;">
                                    <div class="d-flex align-items-start">
                                        <span class="badge bg-success me-3" style="font-size: 16px; padding: 8px 12px;">${idx + 1}</span>
                                        <div style="flex: 1;">
                                            <h6 class="mb-2" style="color: #212529; font-weight: 600;">${moduleName}</h6>
                                            ${moduleDesc ? `<p class="mb-0 text-muted" style="line-height: 1.6;">${moduleDesc}</p>` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                    }

                    // Adaptive Progression
                    if (data.adaptive_progression && typeof data.adaptive_progression === 'object') {
                        html += `
                            <div class="result-section" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #17a2b8;">
                                <h6 style="color: #17a2b8; font-weight: 600; margin-bottom: 10px;">
                                    <i class="fas fa-chart-line me-2"></i>Progression Plan
                                </h6>
                                <p class="mb-0">Your learning path adapts based on your progress and performance.</p>
                            </div>
                        `;
                    }

                    // Learning Milestones
                    if (data.learning_milestones && Array.isArray(data.learning_milestones) && data.learning_milestones.length > 0) {
                        html += `
                            <div class="result-section" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #ffc107;">
                                <h6 style="color: #ffc107; font-weight: 600; margin-bottom: 15px;">
                                    <i class="fas fa-trophy me-2"></i>Learning Milestones
                                </h6>
                        `;
                        data.learning_milestones.forEach((milestone, idx) => {
                            let milestoneName = typeof milestone === 'string' ? milestone : (milestone.name || milestone.title || 'Milestone');

                            // Clean up milestone text - remove "Module X Milestone:" prefix
                            milestoneName = milestoneName.replace(/^Module\s*\d+\s*Milestone:\s*/i, '').trim();

                            html += `
                                <div class="milestone-card mb-3 p-3 bg-white border rounded" style="border-left: 4px solid #ffc107;">
                                    <div class="d-flex align-items-start">
                                        <i class="fas fa-flag-checkered text-warning me-3" style="font-size: 20px; margin-top: 2px;"></i>
                                        <div style="flex: 1;">
                                            <p class="mb-0" style="line-height: 1.6; color: #495057;">${milestoneName}</p>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                    }

                    // Recommendations
                    if (data.recommendations && Array.isArray(data.recommendations) && data.recommendations.length > 0) {
                        html += `
                            <div class="result-section" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #0d6efd;">
                                <h6 style="color: #0d6efd; font-weight: 600; margin-bottom: 10px;">
                                    <i class="fas fa-lightbulb me-2"></i>Recommendations
                                </h6>
                                <ul class="list-unstyled mb-0">
                        `;
                        data.recommendations.forEach(rec => {
                            html += `<li class="mb-2"><i class="fas fa-star text-primary me-2"></i>${rec}</li>`;
                        });
                        html += '</ul></div>';
                    }

                    html += '</div>';
                    resultDiv.innerHTML = html;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                resultDiv.innerHTML = '<div class="alert alert-danger">Error creating adaptive learning path</div>';
            });
    }

    function toggleSubjectStyle(subject) {
        const checkbox = document.getElementById(`subject${subject}`);
        const styleSelect = document.getElementById(`${subject.toLowerCase()}StyleSelect`);

        if (checkbox.checked) {
            styleSelect.style.display = 'block';
        } else {
            styleSelect.style.display = 'none';
        }
    }

    function createIntelligentStudySchedule() {
        const globalLearningStyle = document.getElementById('scheduleLearningStyle').value;
        const availableTime = document.getElementById('availableTime').value;

        // Collect selected subjects with their specific learning styles
        const selectedSubjects = [];
        const subjectLearningStyles = {};

        if (document.getElementById('subjectMath').checked) {
            selectedSubjects.push('Mathematics');
            subjectLearningStyles['Mathematics'] = document.getElementById('mathLearningStyle').value;
        }
        if (document.getElementById('subjectEnglish').checked) {
            selectedSubjects.push('English');
            subjectLearningStyles['English'] = document.getElementById('englishLearningStyle').value;
        }
        if (document.getElementById('subjectScience').checked) {
            selectedSubjects.push('Science');
            subjectLearningStyles['Science'] = document.getElementById('scienceLearningStyle').value;
        }

        if (selectedSubjects.length === 0) {
            alert('Please select at least one subject');
            return;
        }

        const resultDiv = document.getElementById('studyScheduleResult');
        resultDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin me-2"></i>Creating intelligent study schedule...</div>';
        resultDiv.style.display = 'block';

        const availableTimeData = {};
        for (let day of ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday']) {
            availableTimeData[day] = {
                'morning': Math.floor(availableTime * 0.3),
                'afternoon': Math.floor(availableTime * 0.4),
                'evening': Math.floor(availableTime * 0.3)
            };
        }

        fetch('/learning-style/api/create-intelligent-study-schedule', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                learning_style: globalLearningStyle,  // Fallback global style
                subject_learning_styles: subjectLearningStyles,  // Subject-specific styles
                available_time: availableTimeData,
                subjects: selectedSubjects,
                priorities: selectedSubjects.reduce((acc, subject, index) => {
                    acc[subject] = index === 0 ? 'high' : 'medium';
                    return acc;
                }, {})
            })
        })
            .then(response => response.json())
            .then(data => {
                console.log('Study Schedule Data:', data);

                if (data.error) {
                    resultDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i>${data.error}</div>`;
                } else {
                    let html = `
                        <div class="result-card" style="background: white; border-radius: 12px; padding: 20px; border: 2px solid #e9ecef;">
                            <div class="result-header" style="border-bottom: 2px solid #ffc107; padding-bottom: 12px; margin-bottom: 15px;">
                                <h6 style="color: #ffc107; font-weight: 700; font-size: 18px;">
                                    <i class="fas fa-calendar-check me-2"></i>Intelligent Study Schedule Created!
                                </h6>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>Learning Style:</strong><br>
                                    <span class="text-primary">${data.user_learning_style || learningStyle}</span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Effectiveness Score:</strong><br>
                                    <span class="text-success">${data.schedule_effectiveness_score || 85}%</span>
                                </div>
                            </div>
                    `;

                    // Weekly Schedule - Beautiful Calendar View
                    if (data.weekly_schedule && typeof data.weekly_schedule === 'object') {
                        html += `
                            <div class="result-section" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #ffc107;">
                                <h6 style="color: #ffc107; font-weight: 600; margin-bottom: 15px;">
                                    <i class="fas fa-calendar-week me-2"></i>Weekly Study Schedule
                                </h6>
                                <div class="weekly-calendar">
                        `;

                        const dayOrder = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                        const dayIcons = {
                            'monday': 'üåÖ',
                            'tuesday': 'üí™',
                            'wednesday': '‚ö°',
                            'thursday': 'üéØ',
                            'friday': 'üåü',
                            'saturday': 'üìö',
                            'sunday': 'üßò'
                        };

                        dayOrder.forEach(day => {
                            const sessions = data.weekly_schedule[day];
                            if (sessions && Array.isArray(sessions)) {
                                html += `
                                    <div class="day-card mb-3 p-3 bg-white border rounded shadow-sm">
                                        <div class="day-header mb-3" style="border-bottom: 2px solid #ffc107; padding-bottom: 8px;">
                                            <h6 class="mb-0" style="color: #212529; font-weight: 700;">
                                                ${dayIcons[day]} ${day.charAt(0).toUpperCase() + day.slice(1)}
                                            </h6>
                                        </div>
                                        <div class="day-sessions">
                                `;

                                sessions.forEach((session, idx) => {
                                    const timeSlotColors = {
                                        'morning': '#28a745',
                                        'afternoon': '#ffc107',
                                        'evening': '#17a2b8'
                                    };
                                    const timeSlotIcons = {
                                        'morning': 'üåÖ',
                                        'afternoon': '‚òÄÔ∏è',
                                        'evening': 'üåô'
                                    };

                                    const color = timeSlotColors[session.time_slot] || '#6c757d';
                                    const icon = timeSlotIcons[session.time_slot] || 'üìñ';

                                    html += `
                                        <div class="session-block mb-2 p-2 rounded" style="border-left: 4px solid ${color}; background: #f8f9fa;">
                                            <div class="d-flex align-items-start">
                                                <span class="me-2" style="font-size: 18px;">${icon}</span>
                                                <div style="flex: 1;">
                                                    <div class="d-flex justify-content-between align-items-start mb-1">
                                                        <strong style="color: ${color}; font-size: 14px;">${session.subject || 'Study'}</strong>
                                                        <span class="badge" style="background-color: ${color}; font-size: 11px;">${session.duration || '45 min'}</span>
                                                    </div>
                                                    <div style="font-size: 12px; color: #6c757d;">
                                                        <i class="fas fa-tasks me-1"></i>${session.activity || 'Study session'}
                                                    </div>
                                                    <div style="font-size: 11px; color: #6c757d; margin-top: 4px;">
                                                        <i class="far fa-clock me-1"></i>${session.time_slot.charAt(0).toUpperCase() + session.time_slot.slice(1)}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                });

                                html += `
                                        </div>
                    </div>
                `;
                            }
                        });

                        html += '</div></div>';
                    }

                    // Optimization Tips
                    if (data.optimization_tips && Array.isArray(data.optimization_tips) && data.optimization_tips.length > 0) {
                        html += `
                            <div class="result-section" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #28a745;">
                                <h6 style="color: #28a745; font-weight: 600; margin-bottom: 15px;">
                                    <i class="fas fa-lightbulb me-2"></i>Session Optimization Tips
                                </h6>
                        `;
                        data.optimization_tips.forEach((tip, idx) => {
                            html += `
                                <div class="tip-card mb-2 p-3 bg-white border-start border-4 border-success rounded" style="border-left-color: #28a745 !important;">
                                    <div class="d-flex align-items-start">
                                        <i class="fas fa-check-circle text-success me-2" style="margin-top: 2px;"></i>
                                        <p class="mb-0" style="line-height: 1.6; color: #495057;">${tip}</p>
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                    }

                    // Break Recommendations
                    if (data.break_recommendations && Array.isArray(data.break_recommendations) && data.break_recommendations.length > 0) {
                        html += `
                            <div class="result-section" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #17a2b8;">
                                <h6 style="color: #17a2b8; font-weight: 600; margin-bottom: 15px;">
                                    <i class="fas fa-coffee me-2"></i>Break Recommendations
                                </h6>
                        `;
                        data.break_recommendations.forEach((breakRec, idx) => {
                            const activity = typeof breakRec === 'string' ? breakRec : (breakRec.activity || 'Take a break');
                            const duration = typeof breakRec === 'object' ? breakRec.duration : '';
                            const benefit = typeof breakRec === 'object' ? breakRec.benefit : '';

                            html += `
                                <div class="break-card mb-3 p-3 bg-white border rounded shadow-sm">
                                    <div class="d-flex align-items-start">
                                        <span class="badge bg-info me-3" style="font-size: 14px; padding: 8px 10px; height: fit-content;">${duration || '10m'}</span>
                                        <div style="flex: 1;">
                                            <h6 class="mb-1" style="color: #212529; font-weight: 600; font-size: 14px;">${activity}</h6>
                                            ${benefit ? `<p class="mb-0 text-muted" style="font-size: 12px; line-height: 1.5;"><i class="fas fa-info-circle me-1"></i>${benefit}</p>` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                    }

                    // Motivation Triggers
                    if (data.motivation_triggers && Array.isArray(data.motivation_triggers) && data.motivation_triggers.length > 0) {
                        html += `
                            <div class="result-section" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #dc3545;">
                                <h6 style="color: #dc3545; font-weight: 600; margin-bottom: 15px;">
                                    <i class="fas fa-fire me-2"></i>Motivation Strategies
                                </h6>
                        `;
                        data.motivation_triggers.forEach((trigger, idx) => {
                            const triggerText = typeof trigger === 'string' ? trigger : (trigger.trigger || 'Motivation strategy');
                            const timing = typeof trigger === 'object' ? trigger.timing : '';
                            const benefit = typeof trigger === 'object' ? trigger.benefit : '';

                            html += `
                                <div class="motivation-card mb-3 p-3 bg-white border rounded shadow-sm" style="border-left: 4px solid #dc3545;">
                                    <div class="d-flex align-items-start">
                                        <i class="fas fa-bolt text-danger me-2" style="font-size: 20px; margin-top: 2px;"></i>
                                        <div style="flex: 1;">
                                            <h6 class="mb-1" style="color: #212529; font-weight: 600; font-size: 14px;">${triggerText}</h6>
                                            ${timing ? `<p class="mb-1 text-muted" style="font-size: 12px;"><i class="far fa-clock me-1"></i><strong>When:</strong> ${timing}</p>` : ''}
                                            ${benefit ? `<p class="mb-0 text-muted" style="font-size: 12px;"><i class="fas fa-arrow-up me-1"></i><strong>Why:</strong> ${benefit}</p>` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                    }

                    // Revision Schedule
                    if (data.revision_schedule && typeof data.revision_schedule === 'object') {
                        html += `
                            <div class="result-section" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #6f42c1;">
                                <h6 style="color: #6f42c1; font-weight: 600; margin-bottom: 15px;">
                                    <i class="fas fa-redo me-2"></i>Revision Strategy (Spaced Repetition)
                                </h6>
                                <div class="revision-content p-3 bg-white rounded">
                        `;

                        if (data.revision_schedule.revision_intervals) {
                            html += `
                                <div class="mb-3">
                                    <strong style="color: #6f42c1;"><i class="fas fa-calendar-alt me-2"></i>Review Intervals:</strong>
                                    <div class="d-flex flex-wrap gap-2 mt-2">
                            `;
                            data.revision_schedule.revision_intervals.forEach(interval => {
                                html += `<span class="badge bg-light text-dark border" style="font-size: 12px; padding: 6px 12px;">${interval}</span>`;
                            });
                            html += '</div></div>';
                        }

                        if (data.revision_schedule.revision_methods) {
                            html += `
                                <div class="mb-3">
                                    <strong style="color: #6f42c1;"><i class="fas fa-brain me-2"></i>Revision Methods:</strong>
                                    <ul class="mb-0 mt-2" style="list-style: none; padding-left: 0;">
                            `;
                            data.revision_schedule.revision_methods.forEach(method => {
                                html += `<li class="mb-1"><i class="fas fa-check text-success me-2"></i>${method}</li>`;
                            });
                            html += '</ul></div>';
                        }

                        if (data.revision_schedule.tips) {
                            html += `
                                <div>
                                    <strong style="color: #6f42c1;"><i class="fas fa-star me-2"></i>Pro Tips:</strong>
                                    <ul class="mb-0 mt-2" style="list-style: none; padding-left: 0;">
                            `;
                            data.revision_schedule.tips.forEach(tip => {
                                html += `<li class="mb-1"><i class="fas fa-lightbulb text-warning me-2"></i>${tip}</li>`;
                            });
                            html += '</ul></div>';
                        }

                        html += '</div></div>';
                    }

                    // Intensity Patterns
                    if (data.intensity_patterns && typeof data.intensity_patterns === 'object') {
                        html += `
                            <div class="result-section" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #fd7e14;">
                                <h6 style="color: #fd7e14; font-weight: 600; margin-bottom: 15px;">
                                    <i class="fas fa-chart-line me-2"></i>Weekly Intensity Guide
                                </h6>
                                <div class="intensity-grid">
                        `;

                        const intensityColors = {
                            'high': '#dc3545',
                            'medium': '#ffc107',
                            'low': '#28a745'
                        };

                        const dayOrder = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                        dayOrder.forEach(day => {
                            const dayData = data.intensity_patterns[day];
                            if (dayData && typeof dayData === 'object') {
                                const intensity = dayData.intensity || 'medium';
                                const focus = dayData.focus || 'Study';
                                const color = intensityColors[intensity.toLowerCase()] || '#6c757d';

                                html += `
                                    <div class="intensity-day mb-2 p-3 bg-white border-start border-4 rounded" style="border-left-color: ${color} !important;">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong style="color: #212529;">${day.charAt(0).toUpperCase() + day.slice(1)}</strong>
                                                <span class="badge ms-2" style="background-color: ${color}; font-size: 11px;">${intensity}</span>
                                            </div>
                                            <small class="text-muted">${focus}</small>
                                        </div>
                                    </div>
                                `;
                            }
                        });

                        html += '</div></div>';
                    }

                    html += '</div>';
                    resultDiv.innerHTML = html;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                resultDiv.innerHTML = '<div class="alert alert-danger">Error creating study schedule</div>';
            });
    }

    function analyzeLearningProgress() {
        const timePeriod = document.getElementById('analysisPeriod').value;
        const analysisDepth = document.getElementById('analysisDepth').value;

        const resultDiv = document.getElementById('progressAnalysisResult');
        resultDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin me-2"></i>Analyzing learning progress...</div>';
        resultDiv.style.display = 'block';

        fetch(`/learning-style/api/analyze-learning-progress?time_period=${timePeriod}`)
            .then(response => response.json())
            .then(data => {
                console.log('Progress Analysis Data:', data);

                if (data.error) {
                    resultDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i>${data.error}</div>`;
                } else {
                    let html = `
                        <div class="result-card" style="background: white; border-radius: 12px; padding: 20px; border: 2px solid #e9ecef;">
                            <div class="result-header" style="border-bottom: 2px solid #17a2b8; padding-bottom: 12px; margin-bottom: 15px;">
                                <h6 style="color: #17a2b8; font-weight: 700; font-size: 18px;">
                                    <i class="fas fa-chart-line me-2"></i>Learning Progress Analysis Complete!
                                </h6>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>Time Period:</strong><br>
                                    <span class="text-primary">${data.time_period || timePeriod.replace('_', ' ')}</span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Learning Velocity:</strong><br>
                                    <span class="text-success" style="font-size: 24px; font-weight: 700;">${data.learning_velocity || 75}%</span>
                                </div>
                    </div>
                `;

                    // Add Learning Velocity Explanation
                    const velocity = data.learning_velocity || 75;
                    let velocityLevel = '';
                    let velocityColor = '';
                    let velocityIcon = '';
                    let velocityMessage = '';

                    if (velocity >= 80) {
                        velocityLevel = 'Excellent';
                        velocityColor = '#28a745';
                        velocityIcon = 'fa-trophy';
                        velocityMessage = 'You\'re demonstrating outstanding learning momentum! Your consistent engagement and high activity levels show excellent dedication to your studies.';
                    } else if (velocity >= 60) {
                        velocityLevel = 'Good';
                        velocityColor = '#17a2b8';
                        velocityIcon = 'fa-chart-line';
                        velocityMessage = 'You\'re maintaining solid learning progress! Your study habits are on the right track, with good consistency and engagement.';
                    } else if (velocity >= 40) {
                        velocityLevel = 'Moderate';
                        velocityColor = '#ffc107';
                        velocityIcon = 'fa-battery-half';
                        velocityMessage = 'You\'re making steady progress! There\'s room to boost your learning velocity by increasing study frequency or quiz practice.';
                    } else if (velocity >= 20) {
                        velocityLevel = 'Building';
                        velocityColor = '#fd7e14';
                        velocityIcon = 'fa-seedling';
                        velocityMessage = 'You\'re building your learning foundation! Consider increasing your daily study time and regular practice to accelerate your progress.';
                    } else {
                        velocityLevel = 'Getting Started';
                        velocityColor = '#dc3545';
                        velocityIcon = 'fa-flag';
                        velocityMessage = 'Every learning journey starts somewhere! Focus on building consistent daily study habits to boost your velocity.';
                    }

                    html += `
                        <div class="velocity-explanation" style="margin: 15px 0; padding: 20px; background: linear-gradient(135deg, ${velocityColor}15 0%, ${velocityColor}05 100%); border-radius: 12px; border-left: 4px solid ${velocityColor};">
                            <div class="d-flex align-items-center mb-3">
                                <i class="fas ${velocityIcon}" style="font-size: 32px; color: ${velocityColor}; margin-right: 15px;"></i>
                                <div>
                                    <h6 style="color: ${velocityColor}; font-weight: 700; margin: 0; font-size: 18px;">
                                        ${velocityLevel} Learning Velocity
                                    </h6>
                                    <small class="text-muted">Your current learning pace</small>
                                </div>
                            </div>
                            <p style="margin-bottom: 15px; line-height: 1.6; color: #495057;">
                                ${velocityMessage}
                            </p>
                            
                            <div class="velocity-breakdown" style="background: white; padding: 15px; border-radius: 8px; margin-top: 15px;">
                                <h6 style="font-weight: 600; margin-bottom: 12px; color: #495057;">
                                    <i class="fas fa-info-circle me-2"></i>How Velocity is Calculated:
                                </h6>
                                <div class="row g-2">
                                    <div class="col-md-4">
                                        <div class="p-2 bg-light rounded text-center">
                                            <i class="fas fa-clock text-primary mb-1" style="font-size: 20px;"></i>
                                            <div style="font-size: 11px; font-weight: 600; color: #6c757d;">STUDY TIME</div>
                                            <div style="font-size: 13px; font-weight: 700; color: #212529;">40 points</div>
                                            <small style="font-size: 10px; color: #6c757d;">60 min/day = max</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="p-2 bg-light rounded text-center">
                                            <i class="fas fa-question-circle text-info mb-1" style="font-size: 20px;"></i>
                                            <div style="font-size: 11px; font-weight: 600; color: #6c757d;">QUIZ PRACTICE</div>
                                            <div style="font-size: 13px; font-weight: 700; color: #212529;">30 points</div>
                                            <small style="font-size: 10px; color: #6c757d;">2 quizzes/week = max</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="p-2 bg-light rounded text-center">
                                            <i class="fas fa-book text-success mb-1" style="font-size: 20px;"></i>
                                            <div style="font-size: 11px; font-weight: 600; color: #6c757d;">CONTENT CREATION</div>
                                            <div style="font-size: 13px; font-weight: 700; color: #212529;">30 points</div>
                                            <small style="font-size: 10px; color: #6c757d;">1 topic/week = max</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-2 text-center">
                                    <small style="color: #6c757d;">
                                        <i class="fas fa-plus-circle me-1"></i>
                                        <strong>Bonus:</strong> Up to 10 points for total activity volume
                                    </small>
                                </div>
                            </div>
                        </div>
                    `;

                    // Learning Style Evolution
                    if (data.learning_style_evolution && typeof data.learning_style_evolution === 'object') {
                        html += `
                            <div class="result-section" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #17a2b8;">
                                <h6 style="color: #17a2b8; font-weight: 600; margin-bottom: 10px;">
                                    <i class="fas fa-sync-alt me-2"></i>Learning Style Evolution
                                </h6>
                                <p class="mb-0">Your learning style preferences have been adapting over time based on your performance.</p>
                            </div>
                        `;
                    }

                    // Performance Trends
                    if (data.performance_trends && Array.isArray(data.performance_trends) && data.performance_trends.length > 0) {
                        html += `
                            <div class="result-section" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #28a745;">
                                <h6 style="color: #28a745; font-weight: 600; margin-bottom: 10px;">
                                    <i class="fas fa-trending-up me-2"></i>Performance Trends
                                </h6>
                                <ul class="list-unstyled mb-0">
                        `;
                        data.performance_trends.forEach(trend => {
                            const trendText = typeof trend === 'string' ? trend : (trend.description || trend.name || 'Performance improving');
                            html += `<li class="mb-2"><i class="fas fa-arrow-up text-success me-2"></i>${trendText}</li>`;
                        });
                        html += '</ul></div>';
                    }

                    // Improvement Areas
                    if (data.improvement_areas && Array.isArray(data.improvement_areas) && data.improvement_areas.length > 0) {
                        html += `
                            <div class="result-section" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #ffc107;">
                                <h6 style="color: #ffc107; font-weight: 600; margin-bottom: 10px;">
                                    <i class="fas fa-exclamation-triangle me-2"></i>Areas for Improvement
                                </h6>
                                <ul class="list-unstyled mb-0">
                        `;
                        data.improvement_areas.forEach(area => {
                            const areaText = typeof area === 'string' ? area : (area.description || area.name || 'Focus area');
                            html += `<li class="mb-2"><i class="fas fa-circle text-warning me-2"></i>${areaText}</li>`;
                        });
                        html += '</ul></div>';
                    }

                    // Recommendations
                    if (data.recommendations && Array.isArray(data.recommendations) && data.recommendations.length > 0) {
                        html += `
                            <div class="result-section" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #0d6efd;">
                                <h6 style="color: #0d6efd; font-weight: 600; margin-bottom: 10px;">
                                    <i class="fas fa-lightbulb me-2"></i>Recommendations
                                </h6>
                                <ul class="list-unstyled mb-0">
                        `;
                        data.recommendations.forEach(rec => {
                            html += `<li class="mb-2"><i class="fas fa-star text-primary me-2"></i>${rec}</li>`;
                        });
                        html += '</ul></div>';
                    }

                    html += '</div>';
                    resultDiv.innerHTML = html;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                resultDiv.innerHTML = '<div class="alert alert-danger">Error analyzing learning progress</div>';
            });
    }

    function generateLearningInsights() {
        // Create a modal to show insights
        const modalHTML = `
            <div class="modal fade" id="insightsModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-gradient-warning text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-lightbulb me-2"></i>AI-Powered Learning Insights
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body" id="insightsContent">
                            <div class="text-center py-4">
                                <i class="fas fa-spinner fa-spin fa-3x text-warning mb-3"></i>
                                <p class="text-muted">Generating personalized insights...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Remove old modal if exists
        const oldModal = document.getElementById('insightsModal');
        if (oldModal) oldModal.remove();

        // Add new modal
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        const modal = new bootstrap.Modal(document.getElementById('insightsModal'));
        modal.show();

        // Fetch insights
        fetch('/learning-style/api/generate-learning-insights')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('insightsContent').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>${data.error}
                        </div>
                    `;
                } else {
                    displayLearningInsights(data);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('insightsContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>Failed to generate insights
                    </div>
                `;
            });
    }

    function displayLearningInsights(data) {
        console.log('Insights data:', data);
        let html = '';

        // Overview Stats
        html += `
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="stat-card p-3 bg-light rounded text-center">
                        <i class="fas fa-brain text-warning" style="font-size: 32px;"></i>
                        <div class="mt-2">
                            <small class="text-muted">Analysis Depth</small>
                            <h6 class="mb-0 fw-bold">${data.analysis_depth || 'Comprehensive'}</h6>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="stat-card p-3 bg-light rounded text-center">
                        <i class="fas fa-certificate text-success" style="font-size: 32px;"></i>
                        <div class="mt-2">
                            <small class="text-muted">Confidence</small>
                            <h6 class="mb-0 fw-bold">${data.insights_confidence || 90}%</h6>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Personalized Insights
        const insights = data.personalized_insights || [];
        if (Array.isArray(insights) && insights.length > 0) {
            html += `
                <div class="insights-section mb-4">
                    <h6 class="fw-bold text-warning mb-3">
                        <i class="fas fa-star me-2"></i>Key Insights About Your Learning
                    </h6>
            `;
            insights.forEach((insight, idx) => {
                html += `
                    <div class="insight-card p-3 mb-2 bg-light rounded border-start border-warning border-4">
                        <div class="d-flex align-items-start">
                            <span class="badge bg-warning text-dark me-2" style="margin-top: 2px;">${idx + 1}</span>
                            <p class="mb-0" style="line-height: 1.6;">${insight}</p>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
        }

        // Strengths & Weaknesses
        const strengthsWeaknesses = data.strengths_weaknesses || {};
        const strengths = strengthsWeaknesses.strengths || [];
        const weaknesses = strengthsWeaknesses.weaknesses || [];

        if (strengths.length > 0) {
            html += `
                <div class="insights-section mb-4">
                    <h6 class="fw-bold text-success mb-3">
                        <i class="fas fa-check-circle me-2"></i>Your Strengths
                    </h6>
                    <div class="row g-2">
            `;
            strengths.forEach(strength => {
                html += `
                    <div class="col-md-6">
                        <div class="p-2 bg-success bg-opacity-10 rounded">
                            <i class="fas fa-plus-circle text-success me-2"></i>
                            <span>${strength}</span>
                        </div>
                    </div>
                `;
            });
            html += '</div></div>';
        }

        if (weaknesses.length > 0) {
            html += `
                <div class="insights-section mb-4">
                    <h6 class="fw-bold text-info mb-3">
                        <i class="fas fa-arrow-up me-2"></i>Areas for Growth
                    </h6>
                    <div class="row g-2">
            `;
            weaknesses.forEach(area => {
                html += `
                    <div class="col-md-6">
                        <div class="p-2 bg-info bg-opacity-10 rounded">
                            <i class="fas fa-seedling text-info me-2"></i>
                            <span>${area}</span>
                        </div>
                    </div>
                `;
            });
            html += '</div></div>';
        }

        // Action Plan
        const actionPlan = data.action_plan || {};
        if (typeof actionPlan === 'object' && Object.keys(actionPlan).length > 0) {
            html += `
                <div class="insights-section mb-4">
                    <h6 class="fw-bold text-primary mb-3">
                        <i class="fas fa-tasks me-2"></i>Your Personalized Action Plan
                    </h6>
            `;

            Object.entries(actionPlan).forEach(([key, value]) => {
                if (value && typeof value === 'string') {
                    html += `
                        <div class="action-card p-3 mb-2 border rounded">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-chevron-right text-primary me-2" style="margin-top: 4px;"></i>
                                <div style="flex: 1;">
                                    <strong style="color: #0d6efd;">${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}:</strong>
                                    <p class="mb-0 mt-1">${value}</p>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (Array.isArray(value)) {
                    html += `
                        <div class="action-card p-3 mb-2 border rounded">
                            <strong style="color: #0d6efd;">${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}:</strong>
                            <ul class="mb-0 mt-2">
                    `;
                    value.forEach(item => {
                        html += `<li>${item}</li>`;
                    });
                    html += '</ul></div>';
                }
            });
            html += '</div>';
        }

        // Success Predictions
        if (data.success_predictions && typeof data.success_predictions === 'object') {
            html += `
                <div class="insights-section">
                    <h6 class="fw-bold text-purple mb-3">
                        <i class="fas fa-crystal-ball me-2"></i>Success Predictions
                    </h6>
                    <div class="prediction-content p-3 bg-light rounded">
            `;

            Object.entries(data.success_predictions).forEach(([key, value]) => {
                if (value) {
                    html += `
                        <div class="mb-2">
                            <strong>${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}:</strong>
                            <span class="ms-2">${value}</span>
                        </div>
                    `;
                }
            });
            html += '</div></div>';
        }

        if (!html) {
            html = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    No insights data available. Continue using the platform to generate personalized insights!
                </div>
            `;
        }

        document.getElementById('insightsContent').innerHTML = html;
    }

    function personalizeContent() {
        // Create a modal for content personalization
        const modalHTML = `
            <div class="modal fade" id="personalizeContentModal" tabindex="-1">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header bg-gradient-info text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-user-cog me-2"></i>Personalize Learning Content
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="personalizeContentForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">
                                                <i class="fas fa-book me-2"></i>Select Content to Personalize
                                            </label>
                                            <select class="form-select" id="personalizeContentId" required>
                                                <option value="">Loading your topics...</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">
                                                <i class="fas fa-palette me-2"></i>Target Learning Style
                                            </label>
                                            <select class="form-select" id="personalizeTargetStyle" required>
                                                <option value="visual">üìä Visual - Diagrams & Charts</option>
                                                <option value="auditory">üéß Auditory - Listening & Discussion</option>
                                                <option value="kinesthetic">ü§∏ Kinesthetic - Hands-on Practice</option>
                                                <option value="reading">üìñ Reading/Writing - Text-based</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-sliders-h me-2"></i>Personalization Options
                                    </label>
                                    <div class="row g-2">
                                        <div class="col-md-4">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="addVisualAids" checked>
                                                <label class="form-check-label" for="addVisualAids">
                                                    Add Visual Aids
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="addPracticeQuestions" checked>
                                                <label class="form-check-label" for="addPracticeQuestions">
                                                    Add Practice Questions
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="addSummaries" checked>
                                                <label class="form-check-label" for="addSummaries">
                                                    Add Summaries
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <button type="button" class="btn btn-info" onclick="generatePersonalizedContent()">
                                    <i class="fas fa-magic me-2"></i>Personalize Content
                                </button>
                            </form>
                            
                            <div id="personalizedContentResult" class="mt-4" style="display: none;">
                                
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Remove old modal if exists
        const oldModal = document.getElementById('personalizeContentModal');
        if (oldModal) oldModal.remove();

        // Add new modal
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        const modal = new bootstrap.Modal(document.getElementById('personalizeContentModal'));
        modal.show();

        // Load user's topics
        loadUserTopicsForPersonalization();
    }

    function loadUserTopicsForPersonalization() {
        // Use the Supabase client to fetch topics directly
        fetch('/learning-style/api/user-topics')
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('personalizeContentId');
                if (data.topics && Array.isArray(data.topics) && data.topics.length > 0) {
                    select.innerHTML = '<option value="">-- Select a topic --</option>';
                    data.topics.forEach(topic => {
                        const title = topic.title || 'Untitled Topic';
                        select.innerHTML += `<option value="${topic.id}">${title}</option>`;
                    });
                } else {
                    select.innerHTML = '<option value="">No topics found - create a topic first</option>';
                }
            })
            .catch(error => {
                console.error('Error loading topics:', error);
                document.getElementById('personalizeContentId').innerHTML = '<option value="">Error loading topics</option>';
            });
    }

    function generatePersonalizedContent() {
        const contentId = document.getElementById('personalizeContentId').value;
        const targetStyle = document.getElementById('personalizeTargetStyle').value;
        const addVisualAids = document.getElementById('addVisualAids').checked;
        const addPracticeQuestions = document.getElementById('addPracticeQuestions').checked;
        const addSummaries = document.getElementById('addSummaries').checked;

        if (!contentId) {
            alert('Please select a topic to personalize');
            return;
        }

        const resultDiv = document.getElementById('personalizedContentResult');
        resultDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin me-2"></i>Personalizing content for your learning style...</div>';
        resultDiv.style.display = 'block';

        fetch('/learning-style/api/personalize-content-delivery', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                content_id: contentId,
                user_learning_style: targetStyle,
                performance_history: {},
                options: {
                    add_visual_aids: addVisualAids,
                    add_practice_questions: addPracticeQuestions,
                    add_summaries: addSummaries
                }
            })
        })
            .then(response => response.json())
            .then(data => {
                console.log('Personalized Content:', data);

                if (data.error) {
                    resultDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i>${data.error}</div>`;
                } else {
                    displayPersonalizedContent(data);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                resultDiv.innerHTML = '<div class="alert alert-danger">Error personalizing content</div>';
            });
    }

    function displayPersonalizedContent(data) {
        let html = `
            <div class="personalized-content-card" style="background: white; border-radius: 12px; padding: 20px; border: 2px solid #e9ecef;">
                <div class="result-header" style="border-bottom: 2px solid #17a2b8; padding-bottom: 12px; margin-bottom: 15px;">
                    <h6 style="color: #17a2b8; font-weight: 700; font-size: 18px;">
                        <i class="fas fa-check-circle me-2"></i>Content Personalized Successfully!
                    </h6>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Learning Style:</strong><br>
                        <span class="text-primary">${data.adapted_content?.learning_style || 'visual'}</span>
                    </div>
                    <div class="col-md-6">
                        <strong>Personalization Score:</strong><br>
                        <span class="text-success">${data.personalization_score || 85}%</span>
                    </div>
                </div>
        `;

        // Adapted Content
        if (data.adapted_content) {
            const content = data.adapted_content;

            html += `
                <div class="content-section mb-4 p-4 bg-light rounded">
                    <h6 class="fw-bold mb-3">
                        <i class="fas fa-magic me-2 text-info"></i>Personalized Content
                    </h6>
            `;

            // Main content
            if (content.main_content) {
                html += `<div class="mb-3">${content.main_content}</div>`;
            }

            // Visual aids
            if (content.visual_aids && Array.isArray(content.visual_aids)) {
                html += `
                    <div class="visual-aids mb-3">
                        <strong class="text-success"><i class="fas fa-image me-2"></i>Visual Aids:</strong>
                        <ul class="mt-2">
                `;
                content.visual_aids.forEach(aid => {
                    html += `<li>${aid}</li>`;
                });
                html += '</ul></div>';
            }

            // Examples
            if (content.examples && Array.isArray(content.examples)) {
                html += `
                    <div class="examples mb-3">
                        <strong class="text-warning"><i class="fas fa-lightbulb me-2"></i>Examples:</strong>
                        <ul class="mt-2">
                `;
                content.examples.forEach(example => {
                    html += `<li>${example}</li>`;
                });
                html += '</ul></div>';
            }

            html += '</div>';
        }

        // Interactive Elements
        if (data.interactive_elements && Array.isArray(data.interactive_elements) && data.interactive_elements.length > 0) {
            html += `
                <div class="interactive-section mb-4">
                    <h6 class="fw-bold mb-3">
                        <i class="fas fa-hands me-2 text-primary"></i>Interactive Activities
                    </h6>
            `;
            data.interactive_elements.forEach((element, idx) => {
                html += `
                    <div class="interactive-card p-3 mb-2 border rounded">
                        <strong>${idx + 1}. ${element.type || 'Activity'}:</strong>
                        <p class="mb-0 mt-1">${element.description || element}</p>
                    </div>
                `;
            });
            html += '</div>';
        }

        // Comprehension Checks
        if (data.comprehension_checks && Array.isArray(data.comprehension_checks) && data.comprehension_checks.length > 0) {
            html += `
                <div class="comprehension-section mb-4">
                    <h6 class="fw-bold mb-3">
                        <i class="fas fa-question-circle me-2 text-warning"></i>Check Your Understanding
                    </h6>
            `;
            data.comprehension_checks.forEach((check, idx) => {
                const question = typeof check === 'string' ? check : (check.question || check);
                html += `
                    <div class="check-card p-3 mb-2 bg-warning bg-opacity-10 rounded">
                        <strong>${idx + 1}.</strong> ${question}
                    </div>
                `;
            });
            html += '</div>';
        }

        // Reinforcement Activities
        if (data.reinforcement_activities && Array.isArray(data.reinforcement_activities) && data.reinforcement_activities.length > 0) {
            html += `
                <div class="reinforcement-section">
                    <h6 class="fw-bold mb-3">
                        <i class="fas fa-dumbbell me-2 text-success"></i>Practice Activities
                    </h6>
            `;
            data.reinforcement_activities.forEach((activity, idx) => {
                html += `
                    <div class="activity-card p-3 mb-2 bg-success bg-opacity-10 rounded border-start border-success border-4">
                        <div class="d-flex align-items-start">
                            <span class="badge bg-success me-2">${idx + 1}</span>
                            <div>${activity}</div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
        }

        html += '</div>';
        document.getElementById('personalizedContentResult').innerHTML = html;
    }

    function viewPersonalizationCenter() {
        window.location.href = '/learning-style/personalization-center';
    }
</script>

<style>
    /* Assessment Option Cards */
    .option-card {
        background: white;
        border: 2px solid #dee2e6 !important;
        transition: all 0.3s ease;
    }

    .option-card:hover {
        background: #f8f9fa;
        border-color: #0d6efd !important;
        transform: translateX(5px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .option-card .badge {
        min-width: 35px;
        height: 35px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        font-weight: 600;
    }

    .option-card label {
        font-size: 15px;
        margin-bottom: 0;
    }

    .option-card input[type="radio"] {
        width: 20px;
        height: 20px;
        margin-right: 10px;
    }

    /* Result Cards */
    .result-card {
        animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .result-section {
        animation: slideIn 0.5s ease-out;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(-10px);
        }

        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
</style>
{% endblock %}