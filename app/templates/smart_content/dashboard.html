{% extends "base.html" %}

{% block title %}Smart Content Generator - Learning Companion{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Header -->
        <div class="col-12">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header smart-content-header text-white">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-magic fa-2x me-3"></i>
                        <div>
                            <h2 class="h4 mb-0">Smart Content Generator</h2>
                            <p class="mb-0 opacity-75">AI-powered content creation for enhanced learning</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Content Generation -->
        <div class="col-lg-8">
            <!-- Content Type Selection -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cogs text-primary me-2"></i>
                        Generate Content
                    </h5>
                </div>
                <div class="card-body">
                    <form id="contentGenerationForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Select Topic</label>
                                    <div class="input-group">
                                    <select class="form-select" id="contentTopicSelect" required>
                                        <option value="">Choose a topic...</option>
                                    </select>
                                        <button class="btn btn-outline-secondary" type="button" onclick="loadTopics()"
                                            title="Refresh topics" id="refreshTopicsBtn">
                                            <i class="fas fa-sync-alt" id="refreshTopicsIcon"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Content Type</label>
                                    <select class="form-select" id="contentTypeSelect" required>
                                        <option value="">Choose content type...</option>
                                        <option value="study_notes">Study Notes</option>
                                        <option value="interactive">Interactive Content</option>
                                        <option value="visual">Visual Aids</option>
                                        <option value="personalized">Personalized Content</option>
                                        <option value="summary">Summary</option>
                                        <option value="learning_path">Learning Path</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row" id="subtypeRow" style="display: none;">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Content Subtype</label>
                                    <select class="form-select" id="contentSubtypeSelect">
                                        <option value="">Choose subtype...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Learning Style</label>
                                    <select class="form-select" id="learningStyleSelect">
                                        <option value="visual">Visual</option>
                                        <option value="auditory">Auditory</option>
                                        <option value="kinesthetic">Kinesthetic</option>
                                        <option value="reading">Reading/Writing</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <button type="button" class="btn btn-success" onclick="generateContent()">
                                <i class="fas fa-magic me-2"></i>Generate Content
                            </button>
                            <button type="button" class="btn btn-primary ms-2" onclick="generateComprehensivePackage()">
                                <i class="fas fa-layer-group me-2"></i>Generate Full Package
                            </button>
                            <button type="button" class="btn btn-outline-info ms-2"
                                onclick="window.location.href='/topics/new'">
                                <i class="fas fa-plus me-2"></i>Create Topic
                            </button>
                        </div>
                    </form>

                    <div id="contentGenerationResult" class="mt-3" style="display: none;">
                        <!-- Results will be displayed here -->
                    </div>
                </div>
            </div>

            <!-- Generated Content Display -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-file-alt text-info me-2"></i>
                        Generated Content
                    </h5>
                </div>
                <div class="card-body">
                    <div id="generatedContentDisplay">
                        <div class="text-center py-4">
                            <i class="fas fa-magic fa-3x text-muted mb-3"></i>
                            <p class="text-muted">Generate content to see it here!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Content Types -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-gradient-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list me-2"></i>Content Types
                    </h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        <a href="#" class="list-group-item list-group-item-action"
                            onclick="showContentTypeInfo('study_notes')">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-book text-primary me-3"></i>
                                <div>
                                    <h6 class="mb-1">Study Notes</h6>
                                    <small class="text-muted">Comprehensive, summary, key points</small>
                                </div>
                            </div>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action"
                            onclick="showContentTypeInfo('interactive')">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-gamepad text-success me-3"></i>
                                <div>
                                    <h6 class="mb-1">Interactive Content</h6>
                                    <small class="text-muted">Quizzes, flashcards, scenarios</small>
                                </div>
                            </div>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action"
                            onclick="showContentTypeInfo('visual')">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-project-diagram text-warning me-3"></i>
                                <div>
                                    <h6 class="mb-1">Visual Aids</h6>
                                    <small class="text-muted">Mind maps, diagrams, timelines</small>
                                </div>
                            </div>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action"
                            onclick="showContentTypeInfo('personalized')">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-user-cog text-info me-3"></i>
                                <div>
                                    <h6 class="mb-1">Personalized</h6>
                                    <small class="text-muted">Adapted to your learning style</small>
                                </div>
                            </div>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action"
                            onclick="showContentTypeInfo('summary')">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-compress-alt text-secondary me-3"></i>
                                <div>
                                    <h6 class="mb-1">Summaries</h6>
                                    <small class="text-muted">Quick references and overviews</small>
                                </div>
                            </div>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action"
                            onclick="showContentTypeInfo('learning_path')">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-route text-purple me-3"></i>
                                <div>
                                    <h6 class="mb-1">Learning Paths</h6>
                                    <small class="text-muted">Structured progression plans</small>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-bolt text-warning me-2"></i>
                        Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="loadContentTypes(event)">
                            <i class="fas fa-sync me-2"></i>Refresh Content Types
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="showContentGenerator()">
                            <i class="fas fa-cogs me-2"></i>Advanced Generator
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="showContentHistory()">
                            <i class="fas fa-history me-2"></i>Generation History
                        </button>
                    </div>
                </div>
            </div>

            <!-- AI Tips -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-gradient-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-lightbulb me-2"></i>
                        AI Content Tips
                    </h5>
                </div>
                <div class="card-body">
                    <div class="tip-item mb-3">
                        <div class="tip-icon bg-success">
                            <i class="fas fa-book text-white"></i>
                        </div>
                        <div class="tip-content">
                            <h6 class="mb-1">Start with Notes</h6>
                            <p class="mb-0 small">Generate comprehensive study notes first, then create interactive
                                content to test your understanding!</p>
                        </div>
                    </div>

                    <div class="tip-item mb-3">
                        <div class="tip-icon bg-info">
                            <i class="fas fa-eye text-white"></i>
                        </div>
                        <div class="tip-content">
                            <h6 class="mb-1">Learning Styles</h6>
                            <p class="mb-0 small">Visual learners benefit from mind maps and diagrams, while kinesthetic
                                learners prefer interactive exercises.</p>
                        </div>
                    </div>

                    <div class="tip-item mb-3">
                        <div class="tip-icon bg-warning">
                            <i class="fas fa-magic text-white"></i>
                </div>
                        <div class="tip-content">
                            <h6 class="mb-1">AI Creativity</h6>
                            <p class="mb-0 small">Use different content types for the same topic to get varied
                                perspectives and deeper understanding.</p>
            </div>
        </div>

                    <div class="tip-item mb-3">
                        <div class="tip-icon bg-danger">
                            <i class="fas fa-sync-alt text-white"></i>
                        </div>
                        <div class="tip-content">
                            <h6 class="mb-1">Regenerate Content</h6>
                            <p class="mb-0 small">Don't like the result? Generate again for fresh AI-created content
                                with new perspectives.</p>
                        </div>
                    </div>

                    <div class="tip-item">
                        <div class="tip-icon bg-secondary">
                            <i class="fas fa-history text-white"></i>
                        </div>
                        <div class="tip-content">
                            <h6 class="mb-1">Check History</h6>
                            <p class="mb-0 small">Review your generation history to revisit previous content and track
                                your learning materials.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Content Type Info Modal -->
<div class="modal fade" id="contentTypeInfoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Content Type Information</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="contentTypeInfoBody">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Generation History Modal -->
<div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-history me-2"></i>Content Generation History</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="historyLoadingSpinner" class="text-center py-4">
                    <div class="spinner-border text-info" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading your generation history...</p>
                </div>
                <div id="historyContent" style="display: none;">
                    <div class="mb-3">
                        <input type="text" id="historySearch" class="form-control" placeholder="Search history...">
                    </div>
                    <div id="historyList"></div>
                    <div id="historyEmpty" class="text-center py-5" style="display: none;">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No generation history yet. Start creating content!</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Content Detail Modal -->
<div class="modal fade" id="contentDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="contentDetailTitle">
                    <i class="fas fa-file-alt me-2"></i>Content Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="contentDetailBody">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-primary" onclick="regenerateContent()">
                    <i class="fas fa-sync-alt me-2"></i>Regenerate
                </button>
                <button type="button" class="btn btn-outline-success" onclick="copyDetailContent()">
                    <i class="fas fa-copy me-2"></i>Copy
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Advanced Generator Modal -->
<div class="modal fade" id="advancedGeneratorModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-cogs me-2"></i>Advanced Content Generator
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Advanced Mode:</strong> Create multiple content types at once, customize AI parameters, and
                    more!
                </div>

                <form id="advancedGeneratorForm">
                    <!-- Topic Selection -->
                    <div class="mb-3">
                        <label class="form-label"><strong>Select Topic</strong></label>
                        <select id="advancedTopicSelect" class="form-select" required>
                            <option value="">Choose a topic...</option>
                        </select>
                    </div>

                    <!-- Batch Generation -->
                    <div class="mb-3">
                        <label class="form-label"><strong>Content Types to Generate (Multiple)</strong></label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="batch_study_notes"
                                        value="study_notes">
                                    <label class="form-check-label" for="batch_study_notes">
                                        📚 Study Notes
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="batch_quiz" value="quiz">
                                    <label class="form-check-label" for="batch_quiz">
                                        ❓ Interactive Quiz
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="batch_flashcards"
                                        value="flashcards">
                                    <label class="form-check-label" for="batch_flashcards">
                                        🃏 Flashcards
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="batch_mindmap" value="mind_map">
                                    <label class="form-check-label" for="batch_mindmap">
                                        🧠 Mind Map
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="batch_summary" value="summary">
                                    <label class="form-check-label" for="batch_summary">
                                        📋 Summary
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="batch_practice"
                                        value="practice">
                                    <label class="form-check-label" for="batch_practice">
                                        ✍️ Practice Exercises
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Parameters -->
                    <div class="mb-3">
                        <label class="form-label"><strong>AI Creativity Level</strong></label>
                        <input type="range" class="form-range" id="creativityLevel" min="0" max="100" value="70">
                        <div class="d-flex justify-content-between">
                            <small>Conservative</small>
                            <small id="creativityValue">70%</small>
                            <small>Creative</small>
                        </div>
                    </div>

                    <!-- Difficulty Level -->
                    <div class="mb-3">
                        <label class="form-label"><strong>Difficulty Level</strong></label>
                        <select class="form-select" id="difficultyLevel">
                            <option value="beginner">Beginner</option>
                            <option value="intermediate" selected>Intermediate</option>
                            <option value="advanced">Advanced</option>
                            <option value="expert">Expert</option>
                        </select>
                    </div>

                    <!-- Content Length -->
                    <div class="mb-3">
                        <label class="form-label"><strong>Content Length</strong></label>
                        <select class="form-select" id="contentLength">
                            <option value="brief">Brief (Quick Overview)</option>
                            <option value="standard" selected>Standard (Balanced)</option>
                            <option value="detailed">Detailed (Comprehensive)</option>
                            <option value="extensive">Extensive (In-depth)</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="generateAdvancedContent()">
                    <i class="fas fa-magic me-2"></i>Generate All Content
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Content type configurations
    const contentTypes = {
        'study_notes': {
            subtypes: ['comprehensive', 'summary', 'key_points', 'exam_focused'],
            description: 'AI-generated study notes in various formats'
        },
        'interactive': {
            subtypes: ['quiz', 'flashcards', 'scenarios', 'exercises'],
            description: 'Interactive learning content'
        },
        'visual': {
            subtypes: ['mind_map', 'diagram', 'timeline', 'flowchart'],
            description: 'Visual learning aids and diagrams'
        },
        'personalized': {
            subtypes: ['visual', 'auditory', 'kinesthetic', 'reading'],
            description: 'Content adapted to learning style'
        },
        'summary': {
            subtypes: ['overview', 'key_concepts', 'exam_summary', 'quick_reference'],
            description: 'Various types of content summaries'
        },
        'learning_path': {
            subtypes: ['beginner', 'intermediate', 'advanced'],
            description: 'Structured learning progression'
        }
    };

    // Load topics and content types on page load
    document.addEventListener('DOMContentLoaded', function () {
        loadTopics();
        loadContentTypes();
    });

    function loadTopics() {
        const topicSelect = document.getElementById('contentTopicSelect');
        const refreshBtn = document.getElementById('refreshTopicsBtn');
        const refreshIcon = document.getElementById('refreshTopicsIcon');

        // Show loading state
        topicSelect.innerHTML = '<option value="">Loading topics...</option>';
        topicSelect.disabled = true;
        refreshBtn.disabled = true;
        refreshIcon.className = 'fas fa-spinner fa-spin';

        // Return the promise so it can be chained
        return fetch('/content/api/topics')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error loading topics:', data.error);
                    topicSelect.innerHTML = '<option value="">Error loading topics</option>';
                    showAlert('Error loading topics: ' + data.error, 'danger');
                    throw new Error(data.error);
                } else {
                    topicSelect.innerHTML = '<option value="">Choose a topic...</option>';

                    if (data.topics && data.topics.length > 0) {
                        data.topics.forEach(topic => {
                            const option = document.createElement('option');
                            option.value = topic.id;
                            option.textContent = topic.title;
                            topicSelect.appendChild(option);
                        });
                        showAlert(`Loaded ${data.topics.length} topics successfully!`, 'success');
                    } else {
                        topicSelect.innerHTML = '<option value="">No topics found. Create a topic first.</option>';
                        showAlert('No topics found. Please create a topic first.', 'warning');
                    }
                }
                topicSelect.disabled = false;
                refreshBtn.disabled = false;
                refreshIcon.className = 'fas fa-sync-alt';
                return data;
            })
            .catch(error => {
                console.error('Error loading topics:', error);
                topicSelect.innerHTML = '<option value="">Error loading topics</option>';
                topicSelect.disabled = false;
                refreshBtn.disabled = false;
                refreshIcon.className = 'fas fa-sync-alt';
                showAlert('Error loading topics. Please try again.', 'danger');
                throw error;
            });
    }

    function loadContentTypes(event) {
        // Only show button feedback if called from button click
        if (event) {
            const button = event.target.closest('button');
            const originalHTML = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Refreshing...';

            // Reload topics
            loadTopics().then(() => {
                // Show success feedback
                button.innerHTML = '<i class="fas fa-check me-2"></i>Refreshed!';
                button.classList.remove('btn-outline-primary');
                button.classList.add('btn-success');

                // Show alert
                showAlert('Content types and topics refreshed successfully!', 'success');

                // Reset button after 2 seconds
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.classList.remove('btn-success');
                    button.classList.add('btn-outline-primary');
                    button.disabled = false;
                }, 2000);
            }).catch(error => {
                console.error('Error refreshing:', error);
                button.innerHTML = originalHTML;
                button.disabled = false;
                showAlert('Failed to refresh. Please try again.', 'danger');
            });
        } else {
            // Called on page load - just log
            console.log('Content types initialized');
        }
    }

    // Handle content type selection
    document.getElementById('contentTypeSelect').addEventListener('change', function () {
        const contentType = this.value;
        const subtypeRow = document.getElementById('subtypeRow');
        const subtypeSelect = document.getElementById('contentSubtypeSelect');

        if (contentType && contentTypes[contentType]) {
            subtypeSelect.innerHTML = '<option value="">Choose subtype...</option>';
            contentTypes[contentType].subtypes.forEach(subtype => {
                const option = document.createElement('option');
                option.value = subtype;
                option.textContent = subtype.charAt(0).toUpperCase() + subtype.slice(1).replace('_', ' ');
                subtypeSelect.appendChild(option);
            });
            subtypeRow.style.display = 'block';
        } else {
            subtypeRow.style.display = 'none';
        }
    });

    // Download content function
    function downloadContent() {
        const displayDiv = document.getElementById('generatedContentDisplay');
        const content = displayDiv.innerHTML;

        // Create a blob with the content
        const blob = new Blob([content], { type: 'text/html' });
        const url = window.URL.createObjectURL(blob);

        // Create download link
        const a = document.createElement('a');
        a.href = url;
        a.download = 'generated-content.html';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

        showAlert('Content downloaded successfully!', 'success');
    }

    // Copy content to clipboard
    function copyContent() {
        const displayDiv = document.getElementById('generatedContentDisplay');
        const textContent = displayDiv.innerText;

        navigator.clipboard.writeText(textContent).then(() => {
            showAlert('Content copied to clipboard!', 'success');
        }).catch(err => {
            showAlert('Failed to copy content', 'danger');
            });
    }

    function generateComprehensivePackage() {
        const topicId = document.getElementById('contentTopicSelect').value;
        const learningStyle = document.getElementById('learningStyleSelect').value;

        if (!topicId) {
            showAlert('Please select a topic', 'warning');
            return;
        }

        // Get selected topic name for display
        const topicSelect = document.getElementById('contentTopicSelect');
        const selectedTopic = topicSelect.options[topicSelect.selectedIndex].text;

        const types = ['notes', 'quiz', 'summary', 'visual'];
        let url = `/content/api/comprehensive-generation/${topicId}?learning_style=${learningStyle}`;
        types.forEach(type => url += `&types=${type}`);

        const resultDiv = document.getElementById('contentGenerationResult');
        resultDiv.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-spinner fa-spin me-2"></i>
                Generating comprehensive content package for "${selectedTopic}"...
                <div class="mt-2">
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        `;
        resultDiv.style.display = 'block';

        // Disable form during generation
        const generateBtn = document.querySelector('button[onclick="generateContent()"]');
        const packageBtn = document.querySelector('button[onclick="generateComprehensivePackage()"]');
        generateBtn.disabled = true;
        packageBtn.disabled = true;

        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    resultDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>${data.error}</div>`;
                    showAlert('Comprehensive package generation failed: ' + data.error, 'danger');
                } else {
                    displayComprehensiveContent(data);
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            Comprehensive content package generated for "${selectedTopic}"!
                            <button class="btn btn-sm btn-outline-success ms-2" onclick="downloadContent()">
                                <i class="fas fa-download me-1"></i>Download
                            </button>
                        </div>
                    `;
                    showAlert('Comprehensive content package generated successfully!', 'success');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error generating comprehensive package: ${error.message}
                        <br><small class="text-muted">Please check your internet connection and try again.</small>
                    </div>
                `;
                showAlert('Error generating comprehensive package. Please try again.', 'danger');
            })
            .finally(() => {
                // Re-enable form
                generateBtn.disabled = false;
                packageBtn.disabled = false;
            });
    }

    function displayGeneratedContent(data) {
        const displayDiv = document.getElementById('generatedContentDisplay');

        let content = '<div class="generated-content">';

        // Add header with actions
        content += `
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0"><i class="fas fa-file-alt text-primary me-2"></i>Generated Content</h6>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary" onclick="copyContent()" title="Copy to clipboard">
                        <i class="fas fa-copy"></i>
                    </button>
                    <button class="btn btn-outline-primary" onclick="downloadContent()" title="Download">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
            </div>
        `;

        // Display content based on type
        if (data.notes) {
            content += `
                <div class="content-section">
                    <h6 class="text-success"><i class="fas fa-book me-2"></i>Study Notes</h6>
                    <div class="content-text">${data.notes.replace(/\n/g, '<br>')}</div>
                </div>
            `;
        } else if (data.content) {
            const contentData = data.content;

            // Check if it's reading/writing content
            if (contentData.type === 'reading' && (contentData.sections || contentData.introduction)) {
                content += `
                    <div class="content-section reading-content">
                        <h6 class="text-info"><i class="fas fa-book-open me-2"></i>${contentData.title || 'Reading Content'}</h6>
                        
                        ${contentData.introduction ? `
                            <div class="reading-introduction">
                                <p>${contentData.introduction}</p>
                            </div>
                        ` : ''}
                        
                        ${contentData.sections && contentData.sections.length > 0 ? `
                            <div class="reading-sections">
                                ${contentData.sections.map((section, index) => `
                                    <div class="reading-section">
                                        <h6 class="section-heading">${section.heading}</h6>
                                        <div class="section-content">${section.content.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>')}</div>
                                        ${section.key_points && section.key_points.length > 0 ? `
                                            <div class="key-points">
                                                <strong>Key Points:</strong>
                                                <ul>
                                                    ${section.key_points.map(point => `<li>${point}</li>`).join('')}
                                                </ul>
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        ${contentData.definitions && contentData.definitions.length > 0 ? `
                            <div class="definitions-section">
                                <h6><i class="fas fa-book me-2"></i>Key Definitions</h6>
                                <div class="definitions-list">
                                    ${contentData.definitions.map(def => `
                                        <div class="definition-item">
                                            <strong>${def.term}:</strong> ${def.definition}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${contentData.examples && contentData.examples.length > 0 ? `
                            <div class="examples-section">
                                <h6><i class="fas fa-lightbulb me-2"></i>Examples</h6>
                                ${contentData.examples.map(example => `
                                    <div class="example-item">
                                        <h6>${example.title}</h6>
                                        <p>${example.description}</p>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        ${contentData.writing_prompts && contentData.writing_prompts.length > 0 ? `
                            <div class="writing-prompts-section">
                                <h6><i class="fas fa-pen me-2"></i>Writing Prompts</h6>
                                <ul class="prompts-list">
                                    ${contentData.writing_prompts.map(prompt => `<li>${prompt}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        ${contentData.summary ? `
                            <div class="content-summary">
                                <h6><i class="fas fa-clipboard-check me-2"></i>Summary</h6>
                                <p>${contentData.summary}</p>
                            </div>
                        ` : ''}
                    </div>
                `;
            } else {
                // Generic interactive content
                content += `
                    <div class="content-section">
                        <h6 class="text-info"><i class="fas fa-puzzle-piece me-2"></i>Interactive Content</h6>
                        <div class="content-text">${typeof contentData === 'string' ? contentData.replace(/\n/g, '<br>') : JSON.stringify(contentData, null, 2)}</div>
                    </div>
                `;
            }
        } else if (data.summary) {
            content += `
                <div class="content-section">
                    <h6 class="text-warning"><i class="fas fa-compress-alt me-2"></i>Summary</h6>
                    <div class="content-text">${data.summary.replace(/\n/g, '<br>')}</div>
                </div>
            `;
        } else if (data.visual) {
            const visualContent = data.visual;
            content += `
                <div class="content-section">
                    <h6 class="text-primary"><i class="fas fa-project-diagram me-2"></i>Visual Aid</h6>
                    ${visualContent.title ? `<h6 class="visual-title">${visualContent.title}</h6>` : ''}
                    ${visualContent.description ? `<p class="visual-description">${visualContent.description}</p>` : ''}
                    
                    ${visualContent.steps && visualContent.steps.length > 0 ? `
                        <!-- Flowchart Display -->
                        <div class="flowchart-display">
                            <div class="flowchart-canvas">
                                ${visualContent.steps.map(step => `
                                    <div class="flowchart-step ${step.type || 'process'}" 
                                         style="left: ${(step.x || 0) + 150}px; top: ${(step.y || 0) + 20}px;"
                                         data-step-id="${step.id}">
                                        <div class="step-content">
                                            ${step.label || 'Unlabeled Step'}
                                        </div>
                                    </div>
                                `).join('')}
                                <!-- SVG for connections -->
                                <svg class="connections-svg" width="100%" height="100%">
                                    ${visualContent.connections ? visualContent.connections.map(conn => {
                const fromStep = visualContent.steps.find(s => s.id === conn.from);
                const toStep = visualContent.steps.find(s => s.id === conn.to);
                if (fromStep && toStep) {
                    const x1 = (fromStep.x || 0) + 150 + 75; // Center of step
                    const y1 = (fromStep.y || 0) + 20 + 40; // Bottom of step
                    const x2 = (toStep.x || 0) + 150 + 75;
                    const y2 = (toStep.y || 0) + 20 + 10; // Top of step
                    return `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="#0d6efd" stroke-width="2" marker-end="url(#arrowhead)"/>`;
                }
                return '';
            }).join('') : ''}
                                    <defs>
                                        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                            <polygon points="0 0, 10 3.5, 0 7" fill="#0d6efd"/>
                                        </marker>
                                    </defs>
                                </svg>
                            </div>
                            <div class="flowchart-info">
                                <h6>Process Steps:</h6>
                                <div class="steps-list">
                                    ${visualContent.steps.map((step, index) => `
                                        <div class="step-item ${step.type || 'process'}">
                                            <span class="step-number">${index + 1}</span>
                                            <span class="step-label">${step.label || 'Unlabeled Step'}</span>
                                        </div>
                                    `).join('')}
                                </div>
                                ${visualContent.connections && visualContent.connections.length > 0 ? `
                                    <div class="flowchart-connections mt-3">
                                        <h6>Flow Connections:</h6>
                                        ${visualContent.connections.map(conn => `
                                            <div class="connection">
                                                <i class="fas fa-arrow-down me-2"></i>
                                                ${conn.from} → ${conn.to}
                                                ${conn.label ? `<br><small class="text-muted ms-4">${conn.label}</small>` : ''}
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    ` : visualContent.nodes && visualContent.nodes.length > 0 ? `
                        <!-- Mind Map Display -->
                        <div class="visual-display">
                            <div class="mindmap-container">
                                <div class="mindmap-canvas">
                                    ${visualContent.nodes.map(node => `
                                        <div class="visual-node ${node.type || 'default'}" 
                                             style="left: ${(node.x || 0) + 250}px; top: ${(node.y || 0) + 150}px;"
                                             data-node-id="${node.id}">
                                            <div class="node-content">
                                                ${node.label || 'Unlabeled Node'}
                                            </div>
                                        </div>
                                    `).join('')}
                                    <!-- SVG for connections -->
                                    <svg class="connections-svg" width="100%" height="100%">
                                        ${visualContent.connections ? visualContent.connections.map(conn => {
                const fromNode = visualContent.nodes.find(n => n.id === conn.from);
                const toNode = visualContent.nodes.find(n => n.id === conn.to);
                if (fromNode && toNode) {
                    const x1 = (fromNode.x || 0) + 250 + 60;
                    const y1 = (fromNode.y || 0) + 150 + 20;
                    const x2 = (toNode.x || 0) + 250 + 60;
                    const y2 = (toNode.y || 0) + 150 + 20;
                    return `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="#0d6efd" stroke-width="2" marker-end="url(#arrowhead2)"/>`;
                }
                return '';
            }).join('') : ''}
                                        <defs>
                                            <marker id="arrowhead2" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                                <polygon points="0 0, 10 3.5, 0 7" fill="#0d6efd"/>
                                            </marker>
                                        </defs>
                                    </svg>
                                </div>
                            </div>
                            <div class="visual-info">
                                <h6>Mind Map Elements:</h6>
                                <div class="nodes-list">
                                    ${visualContent.nodes.map(node => `
                                        <div class="node-item ${node.type || 'default'}">
                                            <span class="node-type">${node.type || 'node'}</span>
                                            <span class="node-label">${node.label || 'Unlabeled Node'}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    ` : visualContent.events && visualContent.events.length > 0 ? `
                        <!-- Timeline Display -->
                        <div class="timeline-display">
                            <h6>Timeline:</h6>
                            ${visualContent.events.map(event => `
                                <div class="timeline-event">
                                    <div class="timeline-date">${event.date}</div>
                                    <div class="timeline-content">
                                        <h6>${event.event}</h6>
                                        <p>${event.description || ''}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : visualContent.elements && visualContent.elements.length > 0 ? `
                        <!-- Diagram Display -->
                        <div class="diagram-display">
                            <div class="diagram-canvas">
                                ${visualContent.elements.map(element => `
                                    <div class="diagram-element ${element.type || 'box'}" 
                                         style="left: ${(element.x || 0) + 150}px; top: ${(element.y || 0) + 20}px;"
                                         data-element-id="${element.id}">
                                        <div class="element-content">
                                            ${element.label || 'Unlabeled Element'}
                                        </div>
                                    </div>
                                `).join('')}
                                <!-- SVG for connections -->
                                <svg class="connections-svg" width="100%" height="100%">
                                    ${visualContent.connections ? visualContent.connections.map(conn => {
                const fromElement = visualContent.elements.find(e => e.id === conn.from);
                const toElement = visualContent.elements.find(e => e.id === conn.to);
                if (fromElement && toElement) {
                    const x1 = (fromElement.x || 0) + 150 + 75;
                    const y1 = (fromElement.y || 0) + 20 + 40;
                    const x2 = (toElement.x || 0) + 150 + 75;
                    const y2 = (toElement.y || 0) + 20 + 10;
                    return `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="#6f42c1" stroke-width="2" marker-end="url(#arrowhead3)"/>`;
                }
                return '';
            }).join('') : ''}
                                    <defs>
                                        <marker id="arrowhead3" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                            <polygon points="0 0, 10 3.5, 0 7" fill="#6f42c1"/>
                                        </marker>
                                    </defs>
                                </svg>
                            </div>
                            <div class="diagram-info">
                                <h6>Diagram Elements:</h6>
                                <div class="elements-list">
                                    ${visualContent.elements.map((element, index) => `
                                        <div class="element-item ${element.type || 'box'}">
                                            <span class="element-number">${index + 1}</span>
                                            <span class="element-label">${element.label || 'Unlabeled Element'}</span>
                                            <span class="element-type-badge">${element.type || 'box'}</span>
                                        </div>
                                    `).join('')}
                                </div>
                                ${visualContent.connections && visualContent.connections.length > 0 ? `
                                    <div class="diagram-connections mt-3">
                                        <h6>Connections:</h6>
                                        ${visualContent.connections.map(conn => `
                                            <div class="connection">
                                                <i class="fas fa-link me-2"></i>
                                                ${conn.from} → ${conn.to}
                                                ${conn.label ? `<br><small class="text-muted ms-4">${conn.label}</small>` : ''}
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    ` : `
                        <div class="visual-placeholder">
                            <p>Visual content: ${typeof visualContent === 'string' ? visualContent.replace(/\n/g, '<br>') : JSON.stringify(visualContent, null, 2)}</p>
                        </div>
                    `}
                </div>
            `;
        } else if (data.learning_path) {
            content += `
                <div class="content-section">
                    <h6 class="text-secondary"><i class="fas fa-route me-2"></i>Learning Path</h6>
                    <div class="content-text">${typeof data.learning_path === 'string' ? data.learning_path.replace(/\n/g, '<br>') : JSON.stringify(data.learning_path, null, 2)}</div>
                </div>
            `;
        } else {
            content += `
                <div class="content-section">
                    <h6 class="text-muted"><i class="fas fa-info-circle me-2"></i>Generated Content</h6>
                    <div class="content-text">${JSON.stringify(data, null, 2)}</div>
                </div>
            `;
        }

        // Add metadata
        if (data.generated_at) {
            content += `
                <div class="content-metadata mt-3 pt-3 border-top">
                    <small class="text-muted">
                        <i class="fas fa-clock me-1"></i>
                        Generated on ${new Date(data.generated_at).toLocaleString()}
                    </small>
                </div>
            `;
        }

        content += '</div>';
        displayDiv.innerHTML = content;
    }

    function displayComprehensiveContent(data) {
        const displayDiv = document.getElementById('generatedContentDisplay');

        let content = '<div class="comprehensive-content">';

        // Add header with actions
        content += `
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0"><i class="fas fa-layer-group text-success me-2"></i>Comprehensive Content Package</h6>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary" onclick="copyContent()" title="Copy to clipboard">
                        <i class="fas fa-copy"></i>
                    </button>
                    <button class="btn btn-outline-primary" onclick="downloadContent()" title="Download">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
            </div>
        `;

        // Add package info
        if (data.content_types) {
            content += `
                <div class="package-info mb-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Package includes: ${data.content_types.join(', ')}
                    </small>
                </div>
            `;
        }

        // Study Notes Section
        if (data.study_notes && data.study_notes.notes) {
            content += `
                <div class="content-section">
                    <h6 class="text-success"><i class="fas fa-book me-2"></i>Study Notes</h6>
                    <div class="content-text">${data.study_notes.notes.replace(/\n/g, '<br>')}</div>
                </div>
            `;
        }

        // Summary Section
        if (data.summary && data.summary.summary) {
            content += `
                <div class="content-section">
                    <h6 class="text-warning"><i class="fas fa-compress-alt me-2"></i>Summary</h6>
                    <div class="content-text">${data.summary.summary.replace(/\n/g, '<br>')}</div>
                </div>
            `;
        }

        // Interactive Quiz Section
        if (data.interactive_quiz && data.interactive_quiz.content) {
            const quizContent = data.interactive_quiz.content;
            content += `
                <div class="content-section">
                    <h6 class="text-info"><i class="fas fa-question-circle me-2"></i>Interactive Quiz</h6>
                    ${quizContent.title ? `<h6 class="quiz-title">${quizContent.title}</h6>` : ''}
                    ${quizContent.description ? `<p class="quiz-description">${quizContent.description}</p>` : ''}
                    ${quizContent.questions && quizContent.questions.length > 0 ? `
                        <div class="quiz-questions">
                            ${quizContent.questions.map((question, index) => `
                                <div class="question-item">
                                    <h6>Question ${index + 1}: ${question.question}</h6>
                                    <div class="question-options">
                                        ${question.options ? question.options.map((option, optIndex) => `
                                            <div class="option ${optIndex === question.correct_answer ? 'correct' : ''}">
                                                <span class="option-label">${String.fromCharCode(65 + optIndex)}.</span> ${option}
                                                ${optIndex === question.correct_answer ? '<i class="fas fa-check text-success ms-2"></i>' : ''}
                                            </div>
                                        `).join('') : ''}
                                    </div>
                                    ${question.explanation ? `<div class="explanation"><strong>Explanation:</strong> ${question.explanation}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    ` : `
                        <div class="quiz-placeholder">
                            <p>Quiz content: ${typeof quizContent === 'string' ? quizContent.replace(/\n/g, '<br>') : JSON.stringify(quizContent, null, 2)}</p>
                        </div>
                    `}
                </div>
            `;
        }

        // Visual Aids Section
        if (data.visual_aids && data.visual_aids.visual) {
            const visualContent = data.visual_aids.visual;
            content += `
                <div class="content-section">
                    <h6 class="text-primary"><i class="fas fa-project-diagram me-2"></i>Visual Aids</h6>
                    ${visualContent.title ? `<h6 class="visual-title">${visualContent.title}</h6>` : ''}
                    ${visualContent.description ? `<p class="visual-description">${visualContent.description}</p>` : ''}
                    
                    ${visualContent.nodes && visualContent.nodes.length > 0 ? `
                        <div class="visual-display">
                            <div class="mindmap-container">
                                <div class="mindmap-canvas">
                                    ${visualContent.nodes.map(node => `
                                        <div class="visual-node ${node.type || 'default'}" 
                                             style="left: ${(node.x || 0) + 250}px; top: ${(node.y || 0) + 150}px;"
                                             data-node-id="${node.id}">
                                            <div class="node-content">
                                                ${node.label || 'Unlabeled Node'}
                                            </div>
                                        </div>
                                    `).join('')}
                                    <!-- SVG for connections -->
                                    <svg class="connections-svg" width="100%" height="100%">
                                        ${visualContent.connections ? visualContent.connections.map(conn => {
                const fromNode = visualContent.nodes.find(n => n.id === conn.from);
                const toNode = visualContent.nodes.find(n => n.id === conn.to);
                if (fromNode && toNode) {
                    const x1 = (fromNode.x || 0) + 250 + 60; // Center of node
                    const y1 = (fromNode.y || 0) + 150 + 20;
                    const x2 = (toNode.x || 0) + 250 + 60;
                    const y2 = (toNode.y || 0) + 150 + 20;
                    return `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="#0d6efd" stroke-width="2" marker-end="url(#arrowhead)"/>`;
                }
                return '';
            }).join('') : ''}
                                        <defs>
                                            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                                <polygon points="0 0, 10 3.5, 0 7" fill="#0d6efd"/>
                                            </marker>
                                        </defs>
                                    </svg>
                                </div>
                            </div>
                            <div class="visual-info">
                                <h6>Mind Map Elements:</h6>
                                <div class="nodes-list">
                                    ${visualContent.nodes.map(node => `
                                        <div class="node-item ${node.type || 'default'}">
                                            <span class="node-type">${node.type || 'node'}</span>
                                            <span class="node-label">${node.label || 'Unlabeled Node'}</span>
                                        </div>
                                    `).join('')}
                                </div>
                                ${visualContent.connections && visualContent.connections.length > 0 ? `
                                    <div class="visual-connections">
                                        <h6>Connections:</h6>
                                        ${visualContent.connections.map(conn => `
                                            <div class="connection">
                                                <i class="fas fa-arrow-right me-2"></i>
                                                ${conn.from} → ${conn.to}
                                                ${conn.label ? ` (${conn.label})` : ''}
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    ` : visualContent.events && visualContent.events.length > 0 ? `
                        <div class="timeline-display">
                            <h6>Timeline:</h6>
                            ${visualContent.events.map(event => `
                                <div class="timeline-event">
                                    <div class="timeline-date">${event.date}</div>
                                    <div class="timeline-content">
                                        <h6>${event.event}</h6>
                                        <p>${event.description || ''}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : visualContent.steps && visualContent.steps.length > 0 ? `
                        <div class="flowchart-display">
                            <h6>Process Steps:</h6>
                            ${visualContent.steps.map(step => `
                                <div class="flowchart-step ${step.type || 'process'}" style="position: relative; left: ${(step.x || 0) + 100}px; top: ${(step.y || 0) + 100}px;">
                                    <div class="step-content">
                                        ${step.label || 'Unlabeled Step'}
                                    </div>
                                </div>
                            `).join('')}
                            ${visualContent.connections && visualContent.connections.length > 0 ? `
                                <div class="flowchart-connections">
                                    <h6>Flow:</h6>
                                    ${visualContent.connections.map(conn => `
                                        <div class="connection">
                                            <i class="fas fa-arrow-right me-2"></i>
                                            ${conn.from} → ${conn.to}
                                            ${conn.label ? ` (${conn.label})` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    ` : visualContent.elements && visualContent.elements.length > 0 ? `
                        <!-- Diagram Display -->
                        <div class="diagram-display">
                            <div class="diagram-canvas">
                                ${visualContent.elements.map(element => `
                                    <div class="diagram-element ${element.type || 'box'}" 
                                         style="left: ${(element.x || 0) + 150}px; top: ${(element.y || 0) + 20}px;"
                                         data-element-id="${element.id}">
                                        <div class="element-content">
                                            ${element.label || 'Unlabeled Element'}
                                        </div>
                                    </div>
                                `).join('')}
                                <!-- SVG for connections -->
                                <svg class="connections-svg" width="100%" height="100%">
                                    ${visualContent.connections ? visualContent.connections.map(conn => {
                const fromElement = visualContent.elements.find(e => e.id === conn.from);
                const toElement = visualContent.elements.find(e => e.id === conn.to);
                if (fromElement && toElement) {
                    const x1 = (fromElement.x || 0) + 150 + 75;
                    const y1 = (fromElement.y || 0) + 20 + 40;
                    const x2 = (toElement.x || 0) + 150 + 75;
                    const y2 = (toElement.y || 0) + 20 + 10;
                    return `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="#6f42c1" stroke-width="2" marker-end="url(#arrowhead4)"/>`;
                }
                return '';
            }).join('') : ''}
                                    <defs>
                                        <marker id="arrowhead4" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                            <polygon points="0 0, 10 3.5, 0 7" fill="#6f42c1"/>
                                        </marker>
                                    </defs>
                                </svg>
                            </div>
                            <div class="diagram-info">
                                <h6>Diagram Elements:</h6>
                                <div class="elements-list">
                                    ${visualContent.elements.map((element, index) => `
                                        <div class="element-item ${element.type || 'box'}">
                                            <span class="element-number">${index + 1}</span>
                                            <span class="element-label">${element.label || 'Unlabeled Element'}</span>
                                            <span class="element-type-badge">${element.type || 'box'}</span>
                                        </div>
                                    `).join('')}
                                </div>
                                ${visualContent.connections && visualContent.connections.length > 0 ? `
                                    <div class="diagram-connections mt-3">
                                        <h6>Connections:</h6>
                                        ${visualContent.connections.map(conn => `
                                            <div class="connection">
                                                <i class="fas fa-link me-2"></i>
                                                ${conn.from} → ${conn.to}
                                                ${conn.label ? `<br><small class="text-muted ms-4">${conn.label}</small>` : ''}
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    ` : `
                        <div class="visual-placeholder">
                            <p>Visual content: ${typeof visualContent === 'string' ? visualContent.replace(/\n/g, '<br>') : JSON.stringify(visualContent, null, 2)}</p>
                        </div>
                    `}
                </div>
            `;
        }

        // Personalized Content Section
        if (data.personalized_content && data.personalized_content.content) {
            content += `
                <div class="content-section">
                    <h6 class="text-secondary"><i class="fas fa-user-cog me-2"></i>Personalized Content</h6>
                    <div class="content-text">${typeof data.personalized_content.content === 'string' ? data.personalized_content.content.replace(/\n/g, '<br>') : JSON.stringify(data.personalized_content.content, null, 2)}</div>
                </div>
            `;
        }

        // Learning Path Section
        if (data.learning_path && data.learning_path.learning_path) {
            content += `
                <div class="content-section">
                    <h6 class="text-dark"><i class="fas fa-route me-2"></i>Learning Path</h6>
                    <div class="content-text">${typeof data.learning_path.learning_path === 'string' ? data.learning_path.learning_path.replace(/\n/g, '<br>') : JSON.stringify(data.learning_path.learning_path, null, 2)}</div>
                </div>
            `;
        }

        // Add metadata
        if (data.generated_at) {
            content += `
                <div class="content-metadata mt-3 pt-3 border-top">
                    <small class="text-muted">
                        <i class="fas fa-clock me-1"></i>
                        Generated on ${new Date(data.generated_at).toLocaleString()}
                        ${data.learning_style ? ` • Learning Style: ${data.learning_style}` : ''}
                        ${data.difficulty_level ? ` • Difficulty: ${data.difficulty_level}` : ''}
                    </small>
                </div>
            `;
        }

        content += '</div>';
        displayDiv.innerHTML = content;
    }

    function showContentTypeInfo(type) {
        const modal = new bootstrap.Modal(document.getElementById('contentTypeInfoModal'));
        const body = document.getElementById('contentTypeInfoBody');

        if (contentTypes[type]) {
            const config = contentTypes[type];
            body.innerHTML = `
                <h6>${type.charAt(0).toUpperCase() + type.slice(1).replace('_', ' ')}</h6>
                <p>${config.description}</p>
                <h6>Available Subtypes:</h6>
                <ul>
                    ${config.subtypes.map(subtype => `<li>${subtype.charAt(0).toUpperCase() + subtype.slice(1).replace('_', ' ')}</li>`).join('')}
                </ul>
            `;
        }

        modal.show();
    }

    function showContentGenerator() {
        // Show the advanced generator modal
        const modal = new bootstrap.Modal(document.getElementById('advancedGeneratorModal'));
        modal.show();

        // Load topics into the advanced selector
        loadAdvancedTopics();
    }

    async function loadAdvancedTopics() {
        try {
            const response = await fetch('/content/api/topics');
            const data = await response.json();

            const select = document.getElementById('advancedTopicSelect');
            select.innerHTML = '<option value="">Choose a topic...</option>';

            if (data.topics && data.topics.length > 0) {
                data.topics.forEach(topic => {
                    const option = document.createElement('option');
                    option.value = topic.id;
                    option.textContent = topic.title;
                    select.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading topics:', error);
        }
    }

    // Update creativity slider value display
    document.addEventListener('DOMContentLoaded', function () {
        const creativitySlider = document.getElementById('creativityLevel');
        if (creativitySlider) {
            creativitySlider.addEventListener('input', function () {
                document.getElementById('creativityValue').textContent = this.value + '%';
            });
        }
    });

    async function generateAdvancedContent() {
        const topicId = document.getElementById('advancedTopicSelect').value;

        if (!topicId) {
            showAlert('Please select a topic first!', 'warning');
            return;
        }

        // Get selected content types
        const selectedTypes = [];
        document.querySelectorAll('#advancedGeneratorForm input[type="checkbox"]:checked').forEach(checkbox => {
            selectedTypes.push(checkbox.value);
        });

        if (selectedTypes.length === 0) {
            showAlert('Please select at least one content type!', 'warning');
            return;
        }

        // Get other parameters
        const creativity = document.getElementById('creativityLevel').value;
        const difficulty = document.getElementById('difficultyLevel').value;
        const length = document.getElementById('contentLength').value;

        // Close the modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('advancedGeneratorModal'));
        modal.hide();

        // Clear previous content display
        const displayDiv = document.getElementById('generatedContentDisplay');
        displayDiv.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-success mb-3" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5 class="text-success">Generating ${selectedTypes.length} types of content...</h5>
                <p class="text-muted">This may take a moment. Please wait.</p>
                <div id="batchProgress" class="mt-3">
                    <small class="text-muted">Preparing...</small>
                </div>
            </div>
        `;

        // Scroll to display area
        displayDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });

        // Generate each content type
        let successCount = 0;
        let failCount = 0;
        let generatedContent = [];

        for (let i = 0; i < selectedTypes.length; i++) {
            const contentType = selectedTypes[i];

            // Update progress
            document.getElementById('batchProgress').innerHTML = `
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                         style="width: ${((i + 1) / selectedTypes.length) * 100}%">
                        ${i + 1} of ${selectedTypes.length}
                    </div>
                </div>
                <small class="text-muted mt-2 d-block">Generating ${contentType.replace('_', ' ')}...</small>
            `;

            try {
                let endpoint = '';

                if (contentType === 'study_notes') {
                    endpoint = `/content/api/generate-notes/${topicId}?type=comprehensive`;
                } else if (contentType === 'quiz') {
                    endpoint = `/content/api/generate-interactive/${topicId}?type=quiz`;
                } else if (contentType === 'flashcards') {
                    endpoint = `/content/api/generate-interactive/${topicId}?type=flashcards`;
                } else if (contentType === 'mind_map') {
                    endpoint = `/content/api/generate-visual/${topicId}?type=mind_map`;
                } else if (contentType === 'summary') {
                    endpoint = `/content/api/generate-summary/${topicId}?type=overview`;
                } else if (contentType === 'practice') {
                    endpoint = `/content/api/generate-interactive/${topicId}?type=exercises`;
                }

                const response = await fetch(endpoint);
                const data = await response.json();

                if (response.ok && !data.error) {
                    successCount++;
                    generatedContent.push({
                        type: contentType,
                        data: data
                    });
                } else {
                    console.error(`Error generating ${contentType}:`, data.error);
                    failCount++;
                }
            } catch (error) {
                console.error(`Error generating ${contentType}:`, error);
                failCount++;
            }
        }

        // Display all generated content
        if (generatedContent.length > 0) {
            displayBatchGeneratedContent(generatedContent);
            showAlert(`✅ Successfully generated ${successCount} content type(s)! ${failCount > 0 ? `⚠️ (${failCount} failed)` : ''}`, 'success');
        } else {
            displayDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Failed to generate content. Please try again.
                </div>
            `;
            showAlert('Failed to generate content. Please try again.', 'danger');
        }
    }

    function displayBatchGeneratedContent(contentArray) {
        const displayDiv = document.getElementById('generatedContentDisplay');

        let html = `
            <div class="batch-content-display">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">
                        <i class="fas fa-layer-group text-success me-2"></i>
                        Generated Content Package (${contentArray.length} items)
                    </h5>
                </div>
        `;

        // Build HTML for each content item
        contentArray.forEach((item, index) => {
            const typeLabel = item.type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
            const iconMap = {
                'study_notes': 'fa-book',
                'quiz': 'fa-question-circle',
                'flashcards': 'fa-layer-group',
                'mind_map': 'fa-project-diagram',
                'summary': 'fa-compress-alt',
                'practice': 'fa-pencil-alt'
            };
            const icon = iconMap[item.type] || 'fa-file-alt';

            html += `
                <div class="batch-content-item mb-4">
                    <div class="batch-item-header">
                        <h6><i class="fas ${icon} me-2"></i>${typeLabel}</h6>
                    </div>
                    <div class="p-3">
            `;

            // Build content HTML directly
            if (item.data.notes) {
                // Study notes
                const notes = typeof item.data.notes === 'string' ? item.data.notes : JSON.stringify(item.data.notes, null, 2);
                html += `<div class="content-text">${notes.replace(/\n/g, '<br>')}</div>`;
            } else if (item.data.content) {
                // Interactive or personalized content
                const content = item.data.content;
                if (typeof content === 'string') {
                    html += `<div class="content-text">${content.replace(/\n/g, '<br>')}</div>`;
                } else if (content.questions && Array.isArray(content.questions)) {
                    // Quiz content
                    html += '<div class="quiz-questions">';
                    content.questions.forEach((q, qi) => {
                        html += `
                            <div class="question-item">
                                <h6>Question ${qi + 1}: ${q.question}</h6>
                                <div class="question-options">
                        `;
                        if (q.options) {
                            q.options.forEach((opt, oi) => {
                                const correct = oi === q.correct_answer;
                                html += `
                                    <div class="option ${correct ? 'correct' : ''}">
                                        <span class="option-label">${String.fromCharCode(65 + oi)}.</span> ${opt}
                                        ${correct ? '<i class="fas fa-check text-success ms-2"></i>' : ''}
                                    </div>
                                `;
                            });
                        }
                        html += '</div>';
                        if (q.explanation) {
                            html += `<div class="explanation"><strong>Explanation:</strong> ${q.explanation}</div>`;
                        }
                        html += '</div>';
                    });
                    html += '</div>';
                } else {
                    html += `<div class="content-text">${JSON.stringify(content, null, 2)}</div>`;
                }
            } else if (item.data.visual) {
                // Visual aids
                const visual = item.data.visual;
                html += `<div class="content-text"><strong>${visual.title || 'Visual Aid'}</strong><br>${visual.description || ''}</div>`;
            } else if (item.data.summary) {
                // Summary
                const summary = typeof item.data.summary === 'string' ? item.data.summary : JSON.stringify(item.data.summary, null, 2);
                html += `<div class="content-text">${summary.replace(/\n/g, '<br>')}</div>`;
            } else {
                html += `<div class="content-text">${JSON.stringify(item.data, null, 2)}</div>`;
            }

            html += `
                    </div>
                </div>
            `;
        });

        html += '</div>';
        displayDiv.innerHTML = html;
    }

    let historyData = [];

    function showContentHistory() {
        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('historyModal'));
        modal.show();

        // Load history
        loadGenerationHistory();
    }

    async function loadGenerationHistory() {
        const loadingSpinner = document.getElementById('historyLoadingSpinner');
        const historyContent = document.getElementById('historyContent');
        const historyEmpty = document.getElementById('historyEmpty');
        const historyList = document.getElementById('historyList');

        try {
            loadingSpinner.style.display = 'block';
            historyContent.style.display = 'none';

            const response = await fetch('/content/api/history');
            const data = await response.json();

            if (response.ok) {
                historyData = data.history || [];

                if (historyData.length === 0) {
                    historyEmpty.style.display = 'block';
                    historyList.style.display = 'none';
                } else {
                    historyEmpty.style.display = 'none';
                    historyList.style.display = 'block';
                    displayHistory(historyData);
                }

                loadingSpinner.style.display = 'none';
                historyContent.style.display = 'block';
            } else {
                throw new Error(data.error || 'Failed to load history');
            }
        } catch (error) {
            console.error('Error loading history:', error);
            loadingSpinner.style.display = 'none';
            historyList.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Failed to load generation history. Please try again.
                </div>
            `;
            historyContent.style.display = 'block';
        }
    }

    function displayHistory(history) {
        const historyList = document.getElementById('historyList');

        if (!history || history.length === 0) {
            historyList.innerHTML = '';
            return;
        }

        const historyHtml = history.map((item, index) => {
            const date = new Date(item.generated_at);
            const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();

            // Icon based on content type
            const iconMap = {
                'study_notes': 'fa-book',
                'interactive_content': 'fa-puzzle-piece',
                'visual_aids': 'fa-project-diagram',
                'personalized_content': 'fa-user-cog',
                'summary': 'fa-compress-alt',
                'learning_path': 'fa-route'
            };
            const icon = iconMap[item.content_type] || 'fa-file-alt';

            // Badge color based on content type
            const badgeMap = {
                'study_notes': 'success',
                'interactive_content': 'info',
                'visual_aids': 'primary',
                'personalized_content': 'secondary',
                'summary': 'warning',
                'learning_path': 'dark'
            };
            const badgeColor = badgeMap[item.content_type] || 'secondary';

            return `
                <div class="card mb-2 history-item">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">
                                    <i class="fas ${icon} me-2 text-${badgeColor}"></i>
                                    ${item.topic_title}
                                </h6>
                                <div class="mb-2">
                                    <span class="badge bg-${badgeColor} me-2">${item.content_type.replace('_', ' ')}</span>
                                    ${item.content_subtype ? `<span class="badge bg-light text-dark">${item.content_subtype}</span>` : ''}
                                </div>
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i>
                                    ${formattedDate}
                                </small>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-primary" onclick="viewHistoryItem('${item.id}')" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        historyList.innerHTML = historyHtml;
    }

    let currentContentId = null;

    async function viewHistoryItem(itemId) {
        currentContentId = itemId;

        // Show detail modal
        const detailModal = new bootstrap.Modal(document.getElementById('contentDetailModal'));
        detailModal.show();

        // Load content details
        try {
            const response = await fetch(`/content/api/history/${itemId}`);
            const data = await response.json();

            if (response.ok) {
                displayContentDetails(data);
            } else {
                throw new Error(data.error || 'Failed to load content details');
            }
        } catch (error) {
            console.error('Error loading content details:', error);
            document.getElementById('contentDetailBody').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Failed to load content details. Please try again.
                </div>
            `;
        }
    }

    function displayContentDetails(data) {
        const titleEl = document.getElementById('contentDetailTitle');
        const bodyEl = document.getElementById('contentDetailBody');

        // Update title
        const iconMap = {
            'study_notes': 'fa-book',
            'interactive_content': 'fa-puzzle-piece',
            'visual_aids': 'fa-project-diagram',
            'personalized_content': 'fa-user-cog',
            'summary': 'fa-compress-alt',
            'learning_path': 'fa-route'
        };
        const icon = iconMap[data.content_type] || 'fa-file-alt';

        titleEl.innerHTML = `<i class="fas ${icon} me-2"></i>${data.topic_title} - ${data.content_type.replace('_', ' ')}`;

        // Display content based on type
        const contentData = data.content_data;

        // Reuse the existing display functions
        const displayData = {
            content_type: data.content_type,
            content_subtype: data.content_subtype,
            ...contentData,
            generated_at: data.created_at
        };

        // Build content HTML similar to displayGeneratedContent
        let contentHtml = `
            <div class="content-detail-header mb-3">
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Topic:</strong> ${data.topic_title}</p>
                        <p class="mb-1"><strong>Type:</strong> ${data.content_type.replace('_', ' ')}</p>
                        ${data.content_subtype ? `<p class="mb-1"><strong>Subtype:</strong> ${data.content_subtype}</p>` : ''}
                    </div>
                    <div class="col-md-6 text-end">
                        <p class="mb-1"><strong>Generated:</strong> ${new Date(data.created_at).toLocaleString()}</p>
                    </div>
                </div>
            </div>
            <hr>
            <div id="generatedContentDisplay"></div>
        `;

        bodyEl.innerHTML = contentHtml;

        // Reuse the existing display logic - build HTML directly in the detail display
        const detailDisplayDiv = document.getElementById('generatedContentDisplay');
        let detailHTML = '';

        if (data.content_type === 'study_notes') {
            // Study notes
            const notes = contentData.notes || contentData;
            const notesText = typeof notes === 'string' ? notes : JSON.stringify(notes, null, 2);
            detailHTML = `
                <div class="content-section">
                    <h6 class="text-success"><i class="fas fa-book me-2"></i>Study Notes</h6>
                    <div class="content-text">${notesText.replace(/\n/g, '<br>')}</div>
                </div>
            `;
        } else if (data.content_type === 'interactive_content') {
            // Interactive content - check if it's a quiz
            if (contentData.questions && Array.isArray(contentData.questions)) {
                // It's a quiz
                detailHTML = `
                    <div class="content-section">
                        <h6 class="text-info"><i class="fas fa-question-circle me-2"></i>Interactive Quiz</h6>
                        ${contentData.title ? `<h6 class="quiz-title">${contentData.title}</h6>` : ''}
                        ${contentData.description ? `<p class="quiz-description">${contentData.description}</p>` : ''}
                        <div class="quiz-questions">
                `;
                contentData.questions.forEach((question, index) => {
                    detailHTML += `
                        <div class="question-item">
                            <h6>Question ${index + 1}: ${question.question}</h6>
                            <div class="question-options">
                    `;
                    if (question.options) {
                        question.options.forEach((option, optIndex) => {
                            const isCorrect = optIndex === question.correct_answer;
                            detailHTML += `
                                <div class="option ${isCorrect ? 'correct' : ''}">
                                    <span class="option-label">${String.fromCharCode(65 + optIndex)}.</span> ${option}
                                    ${isCorrect ? '<i class="fas fa-check text-success ms-2"></i>' : ''}
                                </div>
                            `;
                        });
                    }
                    detailHTML += '</div>';
                    if (question.explanation) {
                        detailHTML += `<div class="explanation"><strong>Explanation:</strong> ${question.explanation}</div>`;
                    }
                    detailHTML += '</div>';
                });
                detailHTML += '</div></div>';
            } else {
                // Other interactive content
                const contentText = typeof contentData === 'string' ? contentData : JSON.stringify(contentData, null, 2);
                detailHTML = `
                    <div class="content-section">
                        <h6 class="text-info"><i class="fas fa-puzzle-piece me-2"></i>Interactive Content</h6>
                        <div class="content-text">${contentText.replace(/\n/g, '<br>')}</div>
                    </div>
                `;
            }
        } else if (data.content_type === 'visual_aids') {
            displayGeneratedContent({ visual: contentData });
            return; // Exit early since displayGeneratedContent handles it
        } else if (data.content_type === 'personalized_content' && contentData.type === 'reading') {
            displayGeneratedContent({ content: contentData });
            return; // Exit early since displayGeneratedContent handles it
        } else if (data.content_type === 'summary') {
            const summaryText = typeof contentData === 'string' ? contentData : (contentData.summary || JSON.stringify(contentData, null, 2));
            detailHTML = `
                <div class="content-section">
                    <h6 class="text-warning"><i class="fas fa-compress-alt me-2"></i>Summary</h6>
                    <div class="content-text">${summaryText.replace(/\n/g, '<br>')}</div>
                </div>
            `;
        } else {
            // Default display
            displayGeneratedContent(displayData);
            return; // Exit early
        }

        detailDisplayDiv.innerHTML = detailHTML;
    }

    function regenerateContent() {
        if (currentContentId) {
            alert('Regenerate feature coming soon! This will create new content based on the same parameters.');
        }
    }

    function copyDetailContent() {
        const content = document.getElementById('contentDetailBody').innerText;
        navigator.clipboard.writeText(content).then(() => {
            showAlert('Content copied to clipboard!', 'success');
        }).catch(err => {
            console.error('Failed to copy:', err);
            showAlert('Failed to copy content', 'danger');
        });
    }

    // Search history
    document.addEventListener('DOMContentLoaded', function () {
        const searchInput = document.getElementById('historySearch');
        if (searchInput) {
            searchInput.addEventListener('input', function (e) {
                const searchTerm = e.target.value.toLowerCase();
                const filtered = historyData.filter(item =>
                    item.topic_title.toLowerCase().includes(searchTerm) ||
                    item.content_type.toLowerCase().includes(searchTerm) ||
                    (item.content_subtype && item.content_subtype.toLowerCase().includes(searchTerm))
                );
                displayHistory(filtered);
            });
        }
    });

    // Utility function to show alerts
    function showAlert(message, type = 'info') {
        // Remove any existing alerts
        const existingAlerts = document.querySelectorAll('.alert-temp');
        existingAlerts.forEach(alert => alert.remove());

        // Create new alert
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show alert-temp`;
        alertDiv.style.position = 'fixed';
        alertDiv.style.top = '20px';
        alertDiv.style.right = '20px';
        alertDiv.style.zIndex = '9999';
        alertDiv.style.minWidth = '300px';

        alertDiv.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        document.body.appendChild(alertDiv);

        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }

    // Enhanced content generation with better error handling
    function generateContent() {
        const topicId = document.getElementById('contentTopicSelect').value;
        const contentType = document.getElementById('contentTypeSelect').value;
        const subtype = document.getElementById('contentSubtypeSelect').value;
        const learningStyle = document.getElementById('learningStyleSelect').value;

        if (!topicId || !contentType) {
            showAlert('Please select a topic and content type', 'warning');
            return;
        }

        // Get selected topic name for display
        const topicSelect = document.getElementById('contentTopicSelect');
        const selectedTopic = topicSelect.options[topicSelect.selectedIndex].text;

        let url = '';
        let params = new URLSearchParams();

        switch (contentType) {
            case 'study_notes':
                url = `/content/api/generate-notes/${topicId}`;
                if (subtype) params.append('type', subtype);
                break;
            case 'interactive':
                url = `/content/api/generate-interactive/${topicId}`;
                if (subtype) params.append('type', subtype);
                break;
            case 'visual':
                url = `/content/api/generate-visual/${topicId}`;
                if (subtype) params.append('type', subtype);
                break;
            case 'personalized':
                url = `/content/api/generate-personalized/${topicId}`;
                params.append('style', learningStyle);
                break;
            case 'summary':
                url = `/content/api/generate-summary/${topicId}`;
                if (subtype) params.append('type', subtype);
                break;
            case 'learning_path':
                url = `/content/api/generate-learning-path/${topicId}`;
                if (subtype) params.append('difficulty', subtype);
                break;
            default:
                showAlert('Invalid content type', 'danger');
                return;
        }

        if (params.toString()) url += '?' + params.toString();

        // Show loading state
        const resultDiv = document.getElementById('contentGenerationResult');
        resultDiv.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-spinner fa-spin me-2"></i>
                Generating ${contentType.replace('_', ' ')} content for "${selectedTopic}"...
                <div class="mt-2">
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        `;
        resultDiv.style.display = 'block';

        // Disable form during generation
        const generateBtn = document.querySelector('button[onclick="generateContent()"]');
        const packageBtn = document.querySelector('button[onclick="generateComprehensivePackage()"]');
        generateBtn.disabled = true;
        packageBtn.disabled = true;

        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    resultDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>${data.error}</div>`;
                    showAlert('Content generation failed: ' + data.error, 'danger');
                } else {
                    displayGeneratedContent(data);
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            Content generated successfully for "${selectedTopic}"!
                            <button class="btn btn-sm btn-outline-success ms-2" onclick="downloadContent()">
                                <i class="fas fa-download me-1"></i>Download
                            </button>
                        </div>
                    `;
                    showAlert('Content generated successfully!', 'success');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error generating content: ${error.message}
                        <br><small class="text-muted">Please check your internet connection and try again.</small>
                    </div>
                `;
                showAlert('Error generating content. Please try again.', 'danger');
            })
            .finally(() => {
                // Re-enable form
                generateBtn.disabled = false;
                packageBtn.disabled = false;
            });
    }
</script>

<style>
    .generated-content {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }

    .content-text {
        white-space: pre-wrap;
        font-family: inherit;
        line-height: 1.6;
    }

    .comprehensive-content .content-section {
        margin-bottom: 20px;
        padding: 15px;
        background: #fff;
        border-radius: 5px;
        border: 1px solid #dee2e6;
    }

    .comprehensive-content .content-section h6 {
        color: #495057;
        border-bottom: 2px solid #007bff;
        padding-bottom: 5px;
        margin-bottom: 10px;
    }

    .generated-content .content-section {
        margin-bottom: 20px;
        padding: 15px;
        background: #fff;
        border-radius: 8px;
        border: 1px solid #e9ecef;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .generated-content .content-section h6 {
        color: #495057;
        border-bottom: 2px solid #28a745;
        padding-bottom: 8px;
        margin-bottom: 15px;
        font-weight: 600;
    }

    .content-metadata {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #e9ecef;
    }

    .package-info {
        background: #e7f3ff;
        padding: 10px;
        border-radius: 5px;
        border-left: 4px solid #007bff;
    }

    .alert-temp {
        animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .progress {
        border-radius: 10px;
        overflow: hidden;
    }

    .content-text {
        line-height: 1.6;
        font-size: 14px;
    }

    .content-text pre {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        border: 1px solid #e9ecef;
        font-size: 13px;
        max-height: 300px;
        overflow-y: auto;
    }

    /* Quiz Styling */
    .quiz-title {
        color: #0d6efd;
        font-weight: 600;
        margin-bottom: 10px;
    }

    .quiz-description {
        color: #6c757d;
        font-style: italic;
        margin-bottom: 15px;
    }

    .question-item {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        border-left: 4px solid #0d6efd;
    }

    .question-options {
        margin: 10px 0;
    }

    .option {
        padding: 8px 12px;
        margin: 5px 0;
        border-radius: 5px;
        background: #fff;
        border: 1px solid #dee2e6;
        transition: all 0.2s ease;
    }

    .option.correct {
        background: #d4edda;
        border-color: #28a745;
        color: #155724;
    }

    .option-label {
        font-weight: 600;
        margin-right: 8px;
    }

    .explanation {
        background: #e7f3ff;
        padding: 10px;
        border-radius: 5px;
        margin-top: 10px;
        border-left: 3px solid #0d6efd;
    }

    /* Visual Aids Styling */
    .visual-title {
        color: #6f42c1;
        font-weight: 600;
        margin-bottom: 10px;
    }

    .visual-description {
        color: #6c757d;
        font-style: italic;
        margin-bottom: 15px;
    }

    .visual-display,
    .timeline-display,
    .flowchart-display {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #e9ecef;
        margin: 10px 0;
        min-height: 200px;
        position: relative;
    }

    .mindmap-container {
        display: flex;
        gap: 20px;
        align-items: flex-start;
    }

    .mindmap-canvas {
        flex: 2;
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        min-height: 400px;
        position: relative;
        overflow: auto;
        max-height: 500px;
    }

    .flowchart-canvas {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        min-height: 500px;
        position: relative;
        overflow: auto;
        max-height: 700px;
        margin-bottom: 20px;
    }

    .flowchart-info {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
    }

    .steps-list {
        margin-bottom: 15px;
    }

    .step-item {
        display: flex;
        align-items: center;
        padding: 10px;
        margin: 5px 0;
        border-radius: 5px;
        background: #f8f9fa;
        border-left: 4px solid #6c757d;
    }

    .step-item.start {
        border-left-color: #0d6efd;
        background: #e7f3ff;
    }

    .step-item.process {
        border-left-color: #28a745;
        background: #d4edda;
    }

    .step-item.decision {
        border-left-color: #ffc107;
        background: #fff3cd;
    }

    .step-item.end {
        border-left-color: #dc3545;
        background: #f8d7da;
    }

    .step-number {
        font-size: 14px;
        font-weight: 700;
        color: #495057;
        margin-right: 10px;
        min-width: 25px;
        height: 25px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: white;
        border-radius: 50%;
        border: 2px solid #dee2e6;
    }

    .step-label {
        font-size: 14px;
        font-weight: 500;
        flex: 1;
    }

    .diagram-canvas {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        min-height: 500px;
        position: relative;
        overflow: auto;
        max-height: 700px;
        margin-bottom: 20px;
    }

    .diagram-info {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
    }

    .elements-list {
        margin-bottom: 15px;
    }

    .element-item {
        display: flex;
        align-items: center;
        padding: 10px;
        margin: 5px 0;
        border-radius: 5px;
        background: #f8f9fa;
        border-left: 4px solid #6c757d;
    }

    .element-item.box {
        border-left-color: #6f42c1;
        background: #f3e5f5;
    }

    .element-item.circle {
        border-left-color: #17a2b8;
        background: #e0f7fa;
    }

    .element-item.arrow {
        border-left-color: #fd7e14;
        background: #fff3e0;
    }

    .element-number {
        font-size: 14px;
        font-weight: 700;
        color: #495057;
        margin-right: 10px;
        min-width: 25px;
        height: 25px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: white;
        border-radius: 50%;
        border: 2px solid #dee2e6;
    }

    .element-label {
        font-size: 14px;
        font-weight: 500;
        flex: 1;
    }

    .element-type-badge {
        font-size: 11px;
        font-weight: 600;
        color: #6c757d;
        background: white;
        padding: 3px 8px;
        border-radius: 10px;
        border: 1px solid #dee2e6;
    }

    .diagram-element {
        position: absolute;
        margin: 0;
        z-index: 2;
    }

    .element-content {
        background: #fff;
        border: 2px solid #6f42c1;
        border-radius: 8px;
        padding: 10px 15px;
        font-size: 13px;
        font-weight: 500;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        min-width: 120px;
        text-align: center;
    }

    .diagram-element.box .element-content {
        border-radius: 8px;
        background: #f3e5f5;
        border-color: #6f42c1;
    }

    .diagram-element.circle .element-content {
        border-radius: 50%;
        background: #e0f7fa;
        border-color: #17a2b8;
        min-width: 100px;
        min-height: 100px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .diagram-element.arrow .element-content {
        background: #fff3e0;
        border-color: #fd7e14;
        clip-path: polygon(0% 50%, 25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%);
        padding: 15px;
    }

    .diagram-connections {
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid #dee2e6;
    }

    .connections-svg {
        position: absolute;
        top: 0;
        left: 0;
        pointer-events: none;
        z-index: 1;
    }

    .visual-info {
        flex: 1;
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
    }

    .nodes-list {
        margin-bottom: 15px;
    }

    .node-item {
        display: flex;
        align-items: center;
        padding: 8px;
        margin: 5px 0;
        border-radius: 5px;
        background: #f8f9fa;
        border-left: 4px solid #6c757d;
    }

    .node-item.central {
        border-left-color: #0d6efd;
        background: #e7f3ff;
    }

    .node-item.main {
        border-left-color: #28a745;
        background: #d4edda;
    }

    .node-item.sub {
        border-left-color: #ffc107;
        background: #fff3cd;
    }

    .node-type {
        font-size: 11px;
        font-weight: 600;
        color: #6c757d;
        margin-right: 8px;
        min-width: 40px;
    }

    .node-label {
        font-size: 13px;
        font-weight: 500;
    }

    .visual-node,
    .flowchart-step {
        position: absolute;
        margin: 0;
        z-index: 2;
    }

    .node-content,
    .step-content {
        background: #fff;
        border: 2px solid #0d6efd;
        border-radius: 8px;
        padding: 8px 12px;
        font-size: 12px;
        font-weight: 500;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        min-width: 100px;
        text-align: center;
    }

    .visual-node.central .node-content,
    .flowchart-step.start .step-content {
        background: #0d6efd;
        color: white;
        border-color: #0b5ed7;
    }

    .visual-node.main .node-content,
    .flowchart-step.process .step-content {
        background: #28a745;
        color: white;
        border-color: #1e7e34;
    }

    .visual-node.sub .node-content,
    .flowchart-step.decision .step-content {
        background: #ffc107;
        color: #212529;
        border-color: #ffb300;
    }

    .flowchart-step.end .step-content {
        background: #dc3545;
        color: white;
        border-color: #c82333;
    }

    .visual-connections,
    .flowchart-connections {
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid #dee2e6;
    }

    .connection {
        background: #fff;
        padding: 8px 12px;
        margin: 5px 0;
        border-radius: 5px;
        border: 1px solid #dee2e6;
        font-size: 13px;
    }

    .timeline-event {
        display: flex;
        margin-bottom: 15px;
        padding: 10px;
        background: #fff;
        border-radius: 5px;
        border-left: 4px solid #6f42c1;
    }

    .timeline-date {
        background: #6f42c1;
        color: white;
        padding: 8px 12px;
        border-radius: 5px;
        font-weight: 600;
        margin-right: 15px;
        min-width: 80px;
        text-align: center;
    }

    .timeline-content {
        flex: 1;
    }

    .timeline-content h6 {
        margin: 0 0 5px 0;
        color: #495057;
    }

    .timeline-content p {
        margin: 0;
        color: #6c757d;
        font-size: 14px;
    }

    /* Reading Content Styles */
    .reading-content {
        background: #f8f9fa;
    }

    .reading-introduction {
        background: #e7f3ff;
        border-left: 4px solid #0d6efd;
        padding: 15px;
        margin: 15px 0;
        border-radius: 5px;
    }

    .reading-introduction p {
        margin: 0;
        font-size: 15px;
        line-height: 1.6;
        color: #495057;
    }

    .reading-sections {
        margin: 20px 0;
    }

    .reading-section {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        margin: 15px 0;
    }

    .section-heading {
        color: #0d6efd;
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e9ecef;
    }

    .section-content {
        color: #495057;
        font-size: 15px;
        line-height: 1.8;
        margin-bottom: 15px;
    }

    .section-content p {
        margin: 12px 0;
    }

    .key-points {
        background: #f8f9fa;
        border-left: 3px solid #28a745;
        padding: 12px 15px;
        margin: 15px 0;
        border-radius: 5px;
    }

    .key-points strong {
        color: #28a745;
        font-size: 14px;
    }

    .key-points ul {
        margin: 8px 0 0 20px;
        padding: 0;
    }

    .key-points li {
        margin: 5px 0;
        font-size: 14px;
        color: #495057;
    }

    .definitions-section {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        margin: 15px 0;
    }

    .definitions-section h6 {
        color: #6f42c1;
        margin-bottom: 15px;
    }

    .definitions-list {
        display: grid;
        gap: 10px;
    }

    .definition-item {
        background: #f8f9fa;
        border-left: 3px solid #6f42c1;
        padding: 12px 15px;
        border-radius: 5px;
    }

    .definition-item strong {
        color: #6f42c1;
        font-size: 15px;
    }

    .examples-section {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        margin: 15px 0;
    }

    .examples-section h6 {
        color: #fd7e14;
        margin-bottom: 15px;
    }

    .example-item {
        background: #fff3e0;
        border: 1px solid #ffa726;
        border-radius: 5px;
        padding: 15px;
        margin: 10px 0;
    }

    .example-item h6 {
        color: #f57c00;
        font-size: 15px;
        margin-bottom: 8px;
    }

    .example-item p {
        margin: 0;
        font-size: 14px;
        color: #495057;
    }

    .writing-prompts-section {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        margin: 15px 0;
    }

    .writing-prompts-section h6 {
        color: #17a2b8;
        margin-bottom: 15px;
    }

    .prompts-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .prompts-list li {
        background: #e0f7fa;
        border-left: 3px solid #17a2b8;
        padding: 12px 15px;
        margin: 10px 0;
        border-radius: 5px;
        font-size: 14px;
        color: #495057;
    }

    .content-summary {
        background: #d4edda;
        border: 1px solid #28a745;
        border-radius: 8px;
        padding: 20px;
        margin: 15px 0;
    }

    .content-summary h6 {
        color: #28a745;
        margin-bottom: 12px;
    }

    .content-summary p {
        margin: 0;
        font-size: 15px;
        line-height: 1.6;
        color: #495057;
    }

    .quiz-placeholder,
    .visual-placeholder {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 5px;
        padding: 15px;
        color: #856404;
    }

    /* History Modal Styles */
    .history-item {
        transition: all 0.2s ease;
        border-left: 4px solid transparent;
    }

    .history-item:hover {
        border-left-color: #0d6efd;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transform: translateX(2px);
    }

    .history-item .card-body {
        padding: 12px 15px;
    }

    .history-item h6 {
        font-size: 15px;
        font-weight: 600;
        margin-bottom: 8px;
        color: #212529;
    }

    .history-item .badge {
        font-size: 11px;
        padding: 4px 8px;
        font-weight: 500;
    }

    .history-item small {
        font-size: 12px;
    }

    #historySearch {
        border-radius: 20px;
        padding: 10px 15px;
        border: 2px solid #e9ecef;
    }

    #historySearch:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.1);
    }

    .modal-dialog-scrollable .modal-body {
        max-height: calc(100vh - 200px);
    }

    /* Advanced Generator Styles */
    #advancedGeneratorModal .modal-body {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }

    #advancedGeneratorModal .alert-info {
        background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
        border: none;
        border-left: 4px solid #0dcaf0;
    }

    #advancedGeneratorForm .form-label {
        font-weight: 600;
        color: #198754;
        font-size: 15px;
        margin-bottom: 10px;
    }

    #advancedGeneratorForm .form-select,
    #advancedGeneratorForm .form-control {
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 10px 15px;
        transition: all 0.3s ease;
    }

    #advancedGeneratorForm .form-select:focus,
    #advancedGeneratorForm .form-control:focus {
        border-color: #198754;
        box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.15);
    }

    #advancedGeneratorForm .form-check {
        background: white;
        padding: 12px 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        border: 2px solid #e9ecef;
        transition: all 0.2s ease;
    }

    #advancedGeneratorForm .form-check:hover {
        border-color: #198754;
        box-shadow: 0 2px 8px rgba(25, 135, 84, 0.1);
        transform: translateX(2px);
    }

    #advancedGeneratorForm .form-check-input:checked~.form-check-label {
        color: #198754;
        font-weight: 600;
    }

    #advancedGeneratorForm .form-check-input:checked {
        background-color: #198754;
        border-color: #198754;
    }

    #advancedGeneratorForm .form-check-label {
        font-size: 14px;
        cursor: pointer;
        user-select: none;
        width: 100%;
    }

    #advancedGeneratorForm .form-range {
        height: 8px;
    }

    #advancedGeneratorForm .form-range::-webkit-slider-thumb {
        background: #198754;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        cursor: pointer;
    }

    #advancedGeneratorForm .form-range::-moz-range-thumb {
        background: #198754;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        cursor: pointer;
    }

    #creativityValue {
        background: #198754;
        color: white;
        padding: 4px 12px;
        border-radius: 15px;
        font-weight: 600;
        font-size: 14px;
    }

    .batch-section {
        background: white;
        padding: 15px;
        border-radius: 12px;
        border: 2px solid #e9ecef;
    }

    .param-section {
        background: white;
        padding: 15px;
        border-radius: 12px;
        border: 2px solid #e9ecef;
        margin-top: 15px;
    }

    #advancedGeneratorModal .btn-success {
        background: linear-gradient(135deg, #198754 0%, #20c997 100%);
        border: none;
        padding: 10px 25px;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(25, 135, 84, 0.3);
    }

    #advancedGeneratorModal .btn-success:hover {
        background: linear-gradient(135deg, #157347 0%, #1aa179 100%);
        box-shadow: 0 6px 16px rgba(25, 135, 84, 0.4);
        transform: translateY(-2px);
    }

    /* Batch Content Display */
    .batch-content-display {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 12px;
        border: 2px solid #e9ecef;
    }

    .batch-content-item {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        border: 1px solid #e9ecef;
    }

    .batch-item-header {
        background: linear-gradient(135deg, #198754 0%, #20c997 100%);
        color: white;
        padding: 12px 20px;
        border-bottom: 2px solid #157347;
    }

    .batch-item-header h6 {
        margin: 0;
        font-weight: 600;
        font-size: 16px;
    }

    .batch-content-item .content-section {
        margin: 0;
        border-radius: 0;
        border: none;
    }

    #batchProgress {
        max-width: 500px;
        margin: 0 auto;
    }

    #batchProgress .progress {
        height: 25px;
        border-radius: 15px;
        background: #e9ecef;
    }

    #batchProgress .progress-bar {
        font-weight: 600;
        font-size: 14px;
    }

    /* AI Tips Styling */
    .tip-item {
        display: flex;
        align-items: flex-start;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .tip-item:hover {
        background: #e9ecef;
        transform: translateX(5px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .tip-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        flex-shrink: 0;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    }

    .tip-icon i {
        font-size: 18px;
    }

    .tip-content h6 {
        font-size: 14px;
        font-weight: 600;
        color: #212529;
        margin-bottom: 4px;
    }

    .tip-content p {
        font-size: 13px;
        color: #6c757d;
        line-height: 1.5;
    }
</style>
{% endblock %}