{% extends "base.html" %}

{% block title %}Predictive Analytics - Learning Companion{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        
        <div class="col-12">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-gradient-primary text-white">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-chart-line fa-2x me-3"></i>
                        <div>
                            <h2 class="h4 mb-0">Predictive Analytics Dashboard</h2>
                            <p class="mb-0 opacity-75">Advanced AI-powered learning analytics and predictions</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        
        <div class="col-lg-8">
            
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-trending-up text-success me-2"></i>
                        Performance Trends
                    </h5>
                </div>
                <div class="card-body">
                    {% if performance_trends and not performance_trends.error %}
                    <div class="row">
                        <div class="col-md-4">
                            <div class="text-center">
                                <h3 class="text-primary mb-1">{{
                                    performance_trends.cross_topic_trends.overall_trend|title }}</h3>
                                <p class="text-muted mb-0">Overall Trend</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <h3 class="text-success mb-1">{{ performance_trends.total_topics_analyzed }}</h3>
                                <p class="text-muted mb-0">Topics Analyzed</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <h3 class="text-info mb-1">{{ performance_trends.analysis_period_days }}d</h3>
                                <p class="text-muted mb-0">Analysis Period</p>
                            </div>
                        </div>
                    </div>

                    {% if performance_trends.strengths_weaknesses %}
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <h6 class="text-success">Strengths</h6>
                            <div class="d-flex flex-wrap gap-2">
                                {% for strength in performance_trends.strengths_weaknesses.strengths %}
                                <span class="badge bg-success">{{ strength }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-danger">Areas for Improvement</h6>
                            <div class="d-flex flex-wrap gap-2">
                                {% for weakness in performance_trends.strengths_weaknesses.weaknesses %}
                                <span class="badge bg-warning text-dark">{{ weakness }}</span>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Start studying to see performance trends!</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-crystal-ball text-primary me-2"></i>
                        Grade Predictions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Select Topic</label>
                                <select class="form-select" id="predictionTopicSelect">
                                    <option value="">Choose a topic...</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Target Grade (Optional)</label>
                                <select class="form-select" id="targetGradeSelect">
                                    <option value="">Any grade</option>
                                    <option value="9">Grade 9</option>
                                    <option value="8">Grade 8</option>
                                    <option value="7">Grade 7</option>
                                    <option value="6">Grade 6</option>
                                    <option value="5">Grade 5</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Exam Date (Optional)</label>
                        <input type="date" class="form-control" id="examDateInput">
                    </div>
                    <button class="btn btn-primary" onclick="predictGrade()">
                        <i class="fas fa-magic me-2"></i>Predict Grade
                    </button>

                    <div id="gradePredictionResult" class="mt-3" style="display: none;">
                        
                    </div>
                </div>
            </div>

            
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-route text-info me-2"></i>
                        Learning Trajectory Analysis
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Select Topic</label>
                                <select class="form-select" id="trajectoryTopicSelect">
                                    <option value="">Choose a topic...</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Analysis Period</label>
                                <select class="form-select" id="analysisPeriodSelect">
                                    <option value="30">Last 30 days</option>
                                    <option value="60">Last 60 days</option>
                                    <option value="90">Last 90 days</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-info" onclick="analyzeTrajectory()">
                        <i class="fas fa-chart-area me-2"></i>Analyze Trajectory
                    </button>

                    <div id="trajectoryResult" class="mt-3" style="display: none;">
                        
                    </div>
                </div>
            </div>
        </div>

        
        <div class="col-lg-4">
            
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-gradient-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-bolt me-2"></i>Quick Analytics
                    </h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        <a href="#" class="list-group-item list-group-item-action" onclick="showRiskAssessment()">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-exclamation-triangle text-warning me-3"></i>
                                <div>
                                    <h6 class="mb-1">Risk Assessment</h6>
                                    <small class="text-muted">Identify potential risks</small>
                                </div>
                            </div>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action" onclick="showStudyEfficiency()">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-tachometer-alt text-success me-3"></i>
                                <div>
                                    <h6 class="mb-1">Study Efficiency</h6>
                                    <small class="text-muted">Optimize study time</small>
                                </div>
                            </div>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action" onclick="showRevisionSchedule()">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-calendar-check text-primary me-3"></i>
                                <div>
                                    <h6 class="mb-1">Revision Schedule</h6>
                                    <small class="text-muted">Plan exam preparation</small>
                                </div>
                            </div>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action" onclick="showComprehensiveReport()">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-file-alt text-secondary me-3"></i>
                                <div>
                                    <h6 class="mb-1">Comprehensive Report</h6>
                                    <small class="text-muted">Full analytics report</small>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>

            
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-brain text-purple me-2"></i>
                        AI Insights
                    </h5>
                </div>
                <div class="card-body">
                    <div id="aiInsights">
                        <div class="text-center py-4">
                            <i class="fas fa-robot fa-2x text-muted mb-3"></i>
                            <p class="text-muted">Click "Get Insights" to see AI-powered recommendations</p>
                            <button class="btn btn-outline-primary btn-sm" onclick="getAIInsights()">
                                <i class="fas fa-lightbulb me-2"></i>Get Insights
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<div class="modal fade" id="riskAssessmentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Risk Assessment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Select Topic</label>
                    <select class="form-select" id="riskTopicSelect">
                        <option value="">Choose a topic...</option>
                    </select>
                </div>
                <div id="riskAssessmentResult" style="display: none;">
                    
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-warning" onclick="assessRisks()">Assess Risks</button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="studyEfficiencyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Study Efficiency Analysis</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Select Topic</label>
                            <select class="form-select" id="efficiencyTopicSelect">
                                <option value="">Choose a topic...</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Study Time (minutes)</label>
                            <input type="number" class="form-control" id="studyTimeInput" value="60" min="15" max="300">
                        </div>
                    </div>
                </div>
                <div id="studyEfficiencyResult" style="display: none;">
                    
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" onclick="analyzeEfficiency()">Analyze Efficiency</button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="revisionScheduleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Revision Schedule Generator</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Select Topic</label>
                            <select class="form-select" id="revisionTopicSelect">
                                <option value="">Choose a topic...</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Target Grade</label>
                            <select class="form-select" id="revisionTargetGrade">
                                <option value="">Any grade</option>
                                <option value="9">Grade 9</option>
                                <option value="8">Grade 8</option>
                                <option value="7">Grade 7</option>
                                <option value="6">Grade 6</option>
                                <option value="5">Grade 5</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Exam Date</label>
                    <input type="date" class="form-control" id="revisionExamDate" required>
                </div>
                <div id="revisionScheduleResult" style="display: none;">
                    
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="generateRevisionSchedule()">Generate
                    Schedule</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Load topics for dropdowns
    document.addEventListener('DOMContentLoaded', function () {
        loadTopics();
    });

    function loadTopics() {
        // This would load topics from your API
        // For now, we'll use placeholder data
        const topicSelects = document.querySelectorAll('select[id$="TopicSelect"]');
        topicSelects.forEach(select => {
            select.innerHTML = '<option value="">Choose a topic...</option>';
            // Add your topics here
        });
    }

    function predictGrade() {
        const topicId = document.getElementById('predictionTopicSelect').value;
        const targetGrade = document.getElementById('targetGradeSelect').value;
        const examDate = document.getElementById('examDateInput').value;

        if (!topicId) {
            alert('Please select a topic');
            return;
        }

        let url = `/analytics/grade-prediction/${topicId}`;
        const params = new URLSearchParams();
        if (targetGrade) params.append('target_grade', targetGrade);
        if (examDate) params.append('exam_date', examDate);
        if (params.toString()) url += '?' + params.toString();

        fetch(url)
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.getElementById('gradePredictionResult');
                if (data.error) {
                    resultDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                } else {
                    const ensemble = data.predictions.ensemble;
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <h6>Predicted Grade: ${ensemble.grade}</h6>
                            <p>Confidence: ${ensemble.confidence}%</p>
                            <p>Based on ${ensemble.model_count} prediction models</p>
                            ${data.recommendations.length > 0 ? `
                                <h6>Recommendations:</h6>
                                <ul>
                                    ${data.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                                </ul>
                            ` : ''}
                        </div>
                    `;
                }
                resultDiv.style.display = 'block';
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('gradePredictionResult').innerHTML = '<div class="alert alert-danger">Error predicting grade</div>';
                document.getElementById('gradePredictionResult').style.display = 'block';
            });
    }

    function analyzeTrajectory() {
        const topicId = document.getElementById('trajectoryTopicSelect').value;
        const daysBack = document.getElementById('analysisPeriodSelect').value;

        if (!topicId) {
            alert('Please select a topic');
            return;
        }

        fetch(`/analytics/trajectory/${topicId}?days_back=${daysBack}`)
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.getElementById('trajectoryResult');
                if (data.error) {
                    resultDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-info">
                            <h6>Learning Trajectory Analysis</h6>
                            <p>Data Points: ${data.data_points}</p>
                            <p>Analysis Period: ${data.analysis_period_days} days</p>
                            ${data.insights.length > 0 ? `
                                <h6>Insights:</h6>
                                <ul>
                                    ${data.insights.map(insight => `<li>${insight}</li>`).join('')}
                                </ul>
                            ` : ''}
                        </div>
                    `;
                }
                resultDiv.style.display = 'block';
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('trajectoryResult').innerHTML = '<div class="alert alert-danger">Error analyzing trajectory</div>';
                document.getElementById('trajectoryResult').style.display = 'block';
            });
    }

    function showRiskAssessment() {
        const modal = new bootstrap.Modal(document.getElementById('riskAssessmentModal'));
        modal.show();
    }

    function showStudyEfficiency() {
        const modal = new bootstrap.Modal(document.getElementById('studyEfficiencyModal'));
        modal.show();
    }

    function showRevisionSchedule() {
        const modal = new bootstrap.Modal(document.getElementById('revisionScheduleModal'));
        modal.show();
    }

    function assessRisks() {
        const topicId = document.getElementById('riskTopicSelect').value;

        if (!topicId) {
            alert('Please select a topic');
            return;
        }

        fetch(`/analytics/risk-assessment/${topicId}`)
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.getElementById('riskAssessmentResult');
                if (data.error) {
                    resultDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-${data.risk_level === 'High' ? 'danger' : data.risk_level === 'Medium' ? 'warning' : 'success'}">
                            <h6>Risk Assessment: ${data.risk_level}</h6>
                            <p>Overall Risk Score: ${data.overall_risk_score}/100</p>
                            ${data.mitigation_strategies.length > 0 ? `
                                <h6>Mitigation Strategies:</h6>
                                <ul>
                                    ${data.mitigation_strategies.map(strategy => `<li>${strategy}</li>`).join('')}
                                </ul>
                            ` : ''}
                        </div>
                    `;
                }
                resultDiv.style.display = 'block';
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('riskAssessmentResult').innerHTML = '<div class="alert alert-danger">Error assessing risks</div>';
                document.getElementById('riskAssessmentResult').style.display = 'block';
            });
    }

    function analyzeEfficiency() {
        const topicId = document.getElementById('efficiencyTopicSelect').value;
        const studyTime = document.getElementById('studyTimeInput').value;

        if (!topicId) {
            alert('Please select a topic');
            return;
        }

        fetch(`/analytics/efficiency/${topicId}?study_time=${studyTime}`)
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.getElementById('studyEfficiencyResult');
                if (data.error) {
                    resultDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <h6>Study Efficiency Analysis</h6>
                            <p>Efficiency Score: ${data.efficiency_metrics.efficiency_score}/100</p>
                            <p>Optimal Duration: ${data.efficiency_metrics.optimal_duration} minutes</p>
                            ${data.recommendations.length > 0 ? `
                                <h6>Recommendations:</h6>
                                <ul>
                                    ${data.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                                </ul>
                            ` : ''}
                        </div>
                    `;
                }
                resultDiv.style.display = 'block';
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('studyEfficiencyResult').innerHTML = '<div class="alert alert-danger">Error analyzing efficiency</div>';
                document.getElementById('studyEfficiencyResult').style.display = 'block';
            });
    }

    function generateRevisionSchedule() {
        const topicId = document.getElementById('revisionTopicSelect').value;
        const examDate = document.getElementById('revisionExamDate').value;
        const targetGrade = document.getElementById('revisionTargetGrade').value;

        if (!topicId || !examDate) {
            alert('Please select a topic and exam date');
            return;
        }

        let url = `/analytics/revision-schedule/${topicId}?exam_date=${examDate}`;
        if (targetGrade) url += `&target_grade=${targetGrade}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.getElementById('revisionScheduleResult');
                if (data.error) {
                    resultDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-primary">
                            <h6>Optimal Revision Schedule</h6>
                            <p>Days until exam: ${data.days_until_exam}</p>
                            <p>Hours needed: ${data.revision_requirements.hours_needed}</p>
                            ${data.recommendations.length > 0 ? `
                                <h6>Recommendations:</h6>
                                <ul>
                                    ${data.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                                </ul>
                            ` : ''}
                        </div>
                    `;
                }
                resultDiv.style.display = 'block';
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('revisionScheduleResult').innerHTML = '<div class="alert alert-danger">Error generating revision schedule</div>';
                document.getElementById('revisionScheduleResult').style.display = 'block';
            });
    }

    function getAIInsights() {
        fetch('/analytics/insights')
            .then(response => response.json())
            .then(data => {
                const insightsDiv = document.getElementById('aiInsights');
                if (data.error) {
                    insightsDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                } else {
                    insightsDiv.innerHTML = `
                        <div class="mb-3">
                            <h6>Key Insights</h6>
                            <ul class="list-unstyled">
                                ${data.key_insights.map(insight => `<li><i class="fas fa-lightbulb text-warning me-2"></i>${insight}</li>`).join('')}
                            </ul>
                        </div>
                        <div>
                            <h6>Recommendations</h6>
                            <ul class="list-unstyled">
                                ${data.recommendations.map(rec => `<li><i class="fas fa-check-circle text-success me-2"></i>${rec}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('aiInsights').innerHTML = '<div class="alert alert-danger">Error getting insights</div>';
            });
    }

    function showComprehensiveReport() {
        const topicId = prompt('Enter topic ID for comprehensive report:');
        if (!topicId) return;

        const examDate = prompt('Enter exam date (YYYY-MM-DD) or leave empty:');
        const targetGrade = prompt('Enter target grade (1-9) or leave empty:');

        let url = `/analytics/comprehensive-report/${topicId}`;
        const params = new URLSearchParams();
        if (examDate) params.append('exam_date', examDate);
        if (targetGrade) params.append('target_grade', targetGrade);
        if (params.toString()) url += '?' + params.toString();

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    // Open comprehensive report in new window
                    const reportWindow = window.open('', '_blank');
                    reportWindow.document.write(`
                        <html>
                            <head><title>Comprehensive Analytics Report</title></head>
                            <body>
                                <h1>Comprehensive Analytics Report</h1>
                                <pre>${JSON.stringify(data, null, 2)}</pre>
                            </body>
                        </html>
                    `);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error generating comprehensive report');
            });
    }
</script>
{% endblock %}